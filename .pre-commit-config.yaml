# Pre-commit hooks configuration for orb-integration-hub
# See https://pre-commit.com for more information
#
# NOTE: Uses local hooks to run in main pipenv environment instead of isolated environments.
# This avoids CodeArtifact authentication issues for standard development tools.
#
# SETUP: After cloning, create the git hook wrapper:
#   cat > .git/hooks/pre-commit << 'EOF'
#   #!/bin/bash
#   pipenv run pre-commit run --config=.pre-commit-config.yaml
#   EOF
#   chmod +x .git/hooks/pre-commit
#
# CRITICAL: NEVER use `git commit --no-verify` to bypass pre-commit hooks.

repos:
  - repo: local
    hooks:
      # ============================================
      # Python Hooks (Backend API)
      # ============================================

      # Black - Code formatting
      - id: black
        name: Format Python with black
        entry: pipenv run black --line-length=100
        language: system
        types: [python]
        files: ^apps/api/.*\.py$

      # Ruff - Fast linting
      # NOTE: No --fix flag to match CI behavior and catch unfixable errors like F841
      - id: ruff
        name: Lint Python with ruff
        entry: pipenv run ruff check
        language: system
        types: [python]
        files: ^apps/api/.*\.py$

      # MyPy - Static type checking
      - id: mypy
        name: Type check with mypy
        entry: pipenv run mypy --ignore-missing-imports
        language: system
        types: [python]
        files: ^apps/api/.*\.py$
        exclude: ^apps/api/(lambdas/|core/testing/).*\.py$

      # Bandit - Security scanning
      - id: bandit
        name: Security check with bandit
        entry: pipenv run bandit -f json --skip B101
        language: system
        types: [python]
        files: ^apps/api/.*\.py$
        exclude: ^apps/api/(tests/|.*test.*\.py$|core/testing/)

      # ============================================
      # Python Hooks (Infrastructure)
      # ============================================

      - id: black-infra
        name: Format infrastructure Python with black
        entry: bash -c 'cd infrastructure && pipenv run black --line-length=100 "${@#infrastructure/}"' --
        language: system
        types: [python]
        files: ^infrastructure/.*\.py$

      - id: ruff-infra
        name: Lint infrastructure Python with ruff
        entry: bash -c 'cd infrastructure && pipenv run ruff check --ignore E402 "${@#infrastructure/}"' --
        language: system
        types: [python]
        files: ^infrastructure/.*\.py$

      - id: mypy-infra
        name: Type check infrastructure with mypy
        entry: bash -c 'cd infrastructure && pipenv run mypy --ignore-missing-imports "${@#infrastructure/}"' --
        language: system
        types: [python]
        files: ^infrastructure/.*\.py$
        exclude: ^infrastructure/cdk\.out/

      # ============================================
      # Frontend Hooks (Angular/TypeScript)
      # ============================================

      - id: frontend-lint
        name: Lint frontend with ESLint
        entry: bash -c 'cd apps/web && npm run lint'
        language: system
        files: ^apps/web/.*\.(ts|html)$
        pass_filenames: false

      # ============================================
      # General File Hygiene
      # ============================================

      - id: check-yaml
        name: Check YAML syntax
        entry: python -c "import yaml, sys; yaml.safe_load(open(sys.argv[1], encoding='utf-8'))"
        language: system
        types: [yaml]

      - id: check-json
        name: Check JSON syntax
        entry: python -c "import json, sys; json.load(open(sys.argv[1], encoding='utf-8'))"
        language: system
        types: [json]

      - id: check-toml
        name: Check TOML syntax
        entry: python -c "import tomllib, sys; tomllib.load(open(sys.argv[1], 'rb'))"
        language: system
        types: [toml]

      # ============================================
      # Infrastructure Hooks
      # ============================================

      - id: cdk-synth
        name: CDK synth validation
        entry: bash -c 'cd infrastructure && pipenv run cdk synth --quiet'
        language: system
        files: ^infrastructure/.*\.py$
        pass_filenames: false

      - id: cdk-tests
        name: Run CDK infrastructure tests
        entry: bash -c 'cd infrastructure && PIPENV_IGNORE_VIRTUALENVS=1 pipenv run pytest cdk/tests/ --tb=short -q'
        language: system
        files: ^infrastructure/.*\.py$
        pass_filenames: false

      # ============================================
      # Test Hooks
      # ============================================

      - id: pytest-backend
        name: Run backend tests
        entry: bash -c 'cd apps/api && pipenv run pytest lambdas/ core/testing/ --tb=short -q'
        language: system
        files: ^apps/api/.*\.py$
        pass_filenames: false

      - id: frontend-tests
        name: Run frontend tests
        entry: bash -c 'cd apps/web && npm test -- --no-watch --browsers=ChromeHeadless'
        language: system
        files: ^apps/web/.*\.(ts|html)$
        pass_filenames: false
