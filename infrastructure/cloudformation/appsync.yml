# --------------------------------------------------- #
AWSTemplateFormatVersion: 2010-09-09

# --------------------------------------------------- #
Transform: AWS::Serverless-2016-10-31

# --------------------------------------------------- #
Description: >
  Application Infrastructure - AppSync Stack

# --------------------------------------------------- #
Parameters:
  Environment:
    Default: dev
    Type: String
  CustomerId:
    Default: orb
    Type: String
  ProjectId:
    Default: integration-hub
    Type: String
  TracingIs:
    Default: Active
    Type: String
  SchemaS3Key:
    Type: String
    Description: Name of the GraphQL schema file in S3

# --------------------------------------------------- #
Resources:
  AppSyncServiceRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: 2012-10-17
        Statement:
          - Effect: Allow
            Principal:
              Service: appsync.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/AmazonDynamoDBFullAccess
      Policies:
        - PolicyName: SSMParameterAccess
          PolicyDocument:
            Version: 2012-10-17
            Statement:
              - Effect: Allow
                Action:
                  - ssm:GetParameter
                  - ssm:GetParameters
                Resource: !Sub 'arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter/${Environment}/${CustomerId}/${ProjectId}/*'
  
  AppSyncLoggingServiceRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: 2012-10-17
        Statement:
          - Effect: Allow
            Principal:
              Service: appsync.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSAppSyncPushToCloudWatchLogs

  IntegrationHubApi:
    Type: AWS::AppSync::GraphQLApi
    Properties:
      Name: !Sub '${CustomerId}-${ProjectId}-${Environment}-appsync'
      AuthenticationType: AMAZON_COGNITO_USER_POOLS
      UserPoolConfig:
        UserPoolId: !Sub "resolve:ssm:${CustomerId}-${ProjectId}-${Environment}-cognito-user-pool-id"
        AwsRegion: !Ref AWS::Region
        DefaultAction: ALLOW
      AdditionalAuthenticationProviders:
        - AuthenticationType: API_KEY
      LogConfig:
        CloudWatchLogsRoleArn: !GetAtt AppSyncLoggingServiceRole.Arn
        FieldLogLevel: ALL
        ExcludeVerboseContent: false

  IntegrationHubApiKey:
    Type: AWS::AppSync::ApiKey
    Properties:
      ApiId: !GetAtt IntegrationHubApi.ApiId
      Description: "API Key for unauthenticated access"
      Expires: 1767211838

  ApiKeySecret:
    Type: AWS::SecretsManager::Secret
    Properties:
      Name: !Sub '${CustomerId}-${ProjectId}-${Environment}-appsync-graphql-key'
      Description: "AppSync API Key for unauthenticated access"
      SecretString: !GetAtt IntegrationHubApiKey.ApiKey

  IntegrationHubSchema:
    Type: AWS::AppSync::GraphQLSchema
    Properties:
      ApiId: !GetAtt IntegrationHubApi.ApiId
      DefinitionS3Location: !Sub 's3://${CustomerId}-${ProjectId}-build-templates/${SchemaS3Key}'

  # DynamoDB DataSources
  # Jinja template for AppSync DynamoDB DataSources
  ApplicationRolesDynamoDbDataSource:
    Type: AWS::AppSync::DataSource
    Properties:
      ApiId: !GetAtt IntegrationHubApi.ApiId
      Name: ApplicationRolesDynamoDbDataSource
      Type: AMAZON_DYNAMODB
      DynamoDBConfig:
        TableName: !Sub '{{resolve:ssm:${CustomerId}-${ProjectId}-${Environment}-application-roles-table-name}}'
        AwsRegion: !Ref AWS::Region
        UseCallerCredentials: false
      ServiceRoleArn: !GetAtt AppSyncServiceRole.Arn
  ApplicationsDynamoDbDataSource:
    Type: AWS::AppSync::DataSource
    Properties:
      ApiId: !GetAtt IntegrationHubApi.ApiId
      Name: ApplicationsDynamoDbDataSource
      Type: AMAZON_DYNAMODB
      DynamoDBConfig:
        TableName: !Sub '{{resolve:ssm:${CustomerId}-${ProjectId}-${Environment}-applications-table-name}}'
        AwsRegion: !Ref AWS::Region
        UseCallerCredentials: false
      ServiceRoleArn: !GetAtt AppSyncServiceRole.Arn
  ApplicationUsersDynamoDbDataSource:
    Type: AWS::AppSync::DataSource
    Properties:
      ApiId: !GetAtt IntegrationHubApi.ApiId
      Name: ApplicationUsersDynamoDbDataSource
      Type: AMAZON_DYNAMODB
      DynamoDBConfig:
        TableName: !Sub '{{resolve:ssm:${CustomerId}-${ProjectId}-${Environment}-application-users-table-name}}'
        AwsRegion: !Ref AWS::Region
        UseCallerCredentials: false
      ServiceRoleArn: !GetAtt AppSyncServiceRole.Arn
  RolesDynamoDbDataSource:
    Type: AWS::AppSync::DataSource
    Properties:
      ApiId: !GetAtt IntegrationHubApi.ApiId
      Name: RolesDynamoDbDataSource
      Type: AMAZON_DYNAMODB
      DynamoDBConfig:
        TableName: !Sub '{{resolve:ssm:${CustomerId}-${ProjectId}-${Environment}-roles-table-name}}'
        AwsRegion: !Ref AWS::Region
        UseCallerCredentials: false
      ServiceRoleArn: !GetAtt AppSyncServiceRole.Arn
  UsersDynamoDbDataSource:
    Type: AWS::AppSync::DataSource
    Properties:
      ApiId: !GetAtt IntegrationHubApi.ApiId
      Name: UsersDynamoDbDataSource
      Type: AMAZON_DYNAMODB
      DynamoDBConfig:
        TableName: !Sub '{{resolve:ssm:${CustomerId}-${ProjectId}-${Environment}-users-table-name}}'
        AwsRegion: !Ref AWS::Region
        UseCallerCredentials: false
      ServiceRoleArn: !GetAtt AppSyncServiceRole.Arn

  # DynamoDB Resolvers
  # Jinja template for AppSync DynamoDB Resolvers
  ApplicationRolesCreateResolver:
    Type: AWS::AppSync::Resolver
    DependsOn: ApplicationRolesDynamoDbDataSource
    Properties:
      ApiId: !GetAtt IntegrationHubApi.ApiId
      TypeName: Mutation
      FieldName: ApplicationRolesCreate
      DataSourceName: ApplicationRolesDynamoDbDataSource
      RequestMappingTemplate: |
        {
          "version": "2018-05-29",
          "operation": "PutItem",
          "key": {
            "applicationRoleId": $util.dynamodb.toDynamoDBJson($ctx.args.input.applicationRoleId)
          },
          "attributeValues": $util.dynamodb.toMapValuesJson($ctx.args.input)
        }
      ResponseMappingTemplate: |
        #if($ctx.error)
          {
            "StatusCode": 500,
            "Message": "$ctx.error.message",
            "Data": null
          }
        #else
          {
            "StatusCode": 200,
            "Message": null,
            "Data": $util.toJson($ctx.result)
          }
        #end
  ApplicationRolesUpdateResolver:
    Type: AWS::AppSync::Resolver
    DependsOn: ApplicationRolesDynamoDbDataSource
    Properties:
      ApiId: !GetAtt IntegrationHubApi.ApiId
      TypeName: Mutation
      FieldName: ApplicationRolesUpdate
      DataSourceName: ApplicationRolesDynamoDbDataSource
      RequestMappingTemplate: |
        {
          "version": "2018-05-29",
          "operation": "UpdateItem",
          "key": {
            "applicationRoleId": $util.dynamodb.toDynamoDBJson($ctx.args.input.applicationRoleId)
          },
          "attributeValues": $util.dynamodb.toMapValuesJson($ctx.args.input)
        }
      ResponseMappingTemplate: |
        #if($ctx.error)
          {
            "StatusCode": 500,
            "Message": "$ctx.error.message",
            "Data": null
          }
        #else
          {
            "StatusCode": 200,
            "Message": null,
            "Data": $util.toJson($ctx.result)
          }
        #end
  ApplicationRolesDeleteResolver:
    Type: AWS::AppSync::Resolver
    DependsOn: ApplicationRolesDynamoDbDataSource
    Properties:
      ApiId: !GetAtt IntegrationHubApi.ApiId
      TypeName: Mutation
      FieldName: ApplicationRolesDelete
      DataSourceName: ApplicationRolesDynamoDbDataSource
      RequestMappingTemplate: |
        {
          "version": "2018-05-29",
          "operation": "DeleteItem",
          "key": {
            "applicationRoleId": $util.dynamodb.toDynamoDBJson($ctx.args.input.applicationRoleId)
          }
        }
      ResponseMappingTemplate: |
        #if($ctx.error)
          {
            "StatusCode": 500,
            "Message": "$ctx.error.message",
            "Data": null
          }
        #else
          {
            "StatusCode": 200,
            "Message": null,
            "Data": $util.toJson($ctx.result)
          }
        #end
  ApplicationRolesDisableResolver:
    Type: AWS::AppSync::Resolver
    DependsOn: ApplicationRolesDynamoDbDataSource
    Properties:
      ApiId: !GetAtt IntegrationHubApi.ApiId
      TypeName: Mutation
      FieldName: ApplicationRolesDisable
      DataSourceName: ApplicationRolesDynamoDbDataSource
      RequestMappingTemplate: |
        {
          "version": "2018-05-29",
          "operation": "UpdateItem",
          "key": {
            "applicationRoleId": $util.dynamodb.toDynamoDBJson($ctx.args.input.applicationRoleId)
          },
          "attributeValues": $util.dynamodb.toMapValuesJson($ctx.args.input)
        }
      ResponseMappingTemplate: |
        #if($ctx.error)
          {
            "StatusCode": 500,
            "Message": "$ctx.error.message",
            "Data": null
          }
        #else
          {
            "StatusCode": 200,
            "Message": null,
            "Data": $util.toJson($ctx.result)
          }
        #end
  ApplicationRolesQueryByApplicationRoleIdResolver:
    Type: AWS::AppSync::Resolver
    DependsOn: ApplicationRolesDynamoDbDataSource
    Properties:
      ApiId: !GetAtt IntegrationHubApi.ApiId
      TypeName: Query
      FieldName: ApplicationRolesQueryByApplicationRoleId
      DataSourceName: ApplicationRolesDynamoDbDataSource
      RequestMappingTemplate: |
        {
          "version": "2018-05-29",
          "operation": "Query",
          "query": {
            "expression": "#pk = :pk",
            "expressionNames": {
              "#pk": "applicationRoleId"
            },
            "expressionValues": {
              ":pk": $util.dynamodb.toDynamoDBJson($ctx.args.input.applicationRoleId)
            }
          }
        }
      ResponseMappingTemplate: |
        #if($ctx.error)
          {
            "StatusCode": 500,
            "Message": "$ctx.error.message",
            "Data": null
          }
        #else
          {
            "StatusCode": 200,
            "Message": null,
            "Data": $util.toJson($ctx.result)
          }
        #end
  ApplicationRolesQueryByUserIdAndRoleIdResolver:
    Type: AWS::AppSync::Resolver
    DependsOn: ApplicationRolesDynamoDbDataSource
    Properties:
      ApiId: !GetAtt IntegrationHubApi.ApiId
      TypeName: Query
      FieldName: ApplicationRolesQueryByUserIdAndRoleId
      DataSourceName: ApplicationRolesDynamoDbDataSource
      RequestMappingTemplate: |
        {
          "version": "2018-05-29",
          "operation": "Query",
          "index": "UserRoleIndex",
          "query": {
            "expression": "#pk = :pk" AND #sk = :sk,
            "expressionNames": {
              "#pk": "userId",
              "#sk": "roleId"
            },
            "expressionValues": {
              ":pk": $util.dynamodb.toDynamoDBJson($ctx.args.input.userId),
              ":sk": $util.dynamodb.toDynamoDBJson($ctx.args.input.roleId)
            }
          }
        }
      ResponseMappingTemplate: |
        #if($ctx.error)
          {
            "StatusCode": 500,
            "Message": "$ctx.error.message",
            "Data": null
          }
        #else
          {
            "StatusCode": 200,
            "Message": null,
            "Data": $util.toJson($ctx.result)
          }
        #end
  ApplicationRolesQueryByApplicationIdAndRoleIdResolver:
    Type: AWS::AppSync::Resolver
    DependsOn: ApplicationRolesDynamoDbDataSource
    Properties:
      ApiId: !GetAtt IntegrationHubApi.ApiId
      TypeName: Query
      FieldName: ApplicationRolesQueryByApplicationIdAndRoleId
      DataSourceName: ApplicationRolesDynamoDbDataSource
      RequestMappingTemplate: |
        {
          "version": "2018-05-29",
          "operation": "Query",
          "index": "ApplicationRoleIndex",
          "query": {
            "expression": "#pk = :pk" AND #sk = :sk,
            "expressionNames": {
              "#pk": "applicationId",
              "#sk": "roleId"
            },
            "expressionValues": {
              ":pk": $util.dynamodb.toDynamoDBJson($ctx.args.input.applicationId),
              ":sk": $util.dynamodb.toDynamoDBJson($ctx.args.input.roleId)
            }
          }
        }
      ResponseMappingTemplate: |
        #if($ctx.error)
          {
            "StatusCode": 500,
            "Message": "$ctx.error.message",
            "Data": null
          }
        #else
          {
            "StatusCode": 200,
            "Message": null,
            "Data": $util.toJson($ctx.result)
          }
        #end
  ApplicationRolesQueryByRoleIdAndRoleTypeResolver:
    Type: AWS::AppSync::Resolver
    DependsOn: ApplicationRolesDynamoDbDataSource
    Properties:
      ApiId: !GetAtt IntegrationHubApi.ApiId
      TypeName: Query
      FieldName: ApplicationRolesQueryByRoleIdAndRoleType
      DataSourceName: ApplicationRolesDynamoDbDataSource
      RequestMappingTemplate: |
        {
          "version": "2018-05-29",
          "operation": "Query",
          "index": "RoleTypeIndex",
          "query": {
            "expression": "#pk = :pk" AND #sk = :sk,
            "expressionNames": {
              "#pk": "roleId",
              "#sk": "roleType"
            },
            "expressionValues": {
              ":pk": $util.dynamodb.toDynamoDBJson($ctx.args.input.roleId),
              ":sk": $util.dynamodb.toDynamoDBJson($ctx.args.input.roleType)
            }
          }
        }
      ResponseMappingTemplate: |
        #if($ctx.error)
          {
            "StatusCode": 500,
            "Message": "$ctx.error.message",
            "Data": null
          }
        #else
          {
            "StatusCode": 200,
            "Message": null,
            "Data": $util.toJson($ctx.result)
          }
        #end
  ApplicationsCreateResolver:
    Type: AWS::AppSync::Resolver
    DependsOn: ApplicationsDynamoDbDataSource
    Properties:
      ApiId: !GetAtt IntegrationHubApi.ApiId
      TypeName: Mutation
      FieldName: ApplicationsCreate
      DataSourceName: ApplicationsDynamoDbDataSource
      RequestMappingTemplate: |
        {
          "version": "2018-05-29",
          "operation": "PutItem",
          "key": {
            "applicationId": $util.dynamodb.toDynamoDBJson($ctx.args.input.applicationId)
          },
          "attributeValues": $util.dynamodb.toMapValuesJson($ctx.args.input)
        }
      ResponseMappingTemplate: |
        #if($ctx.error)
          {
            "StatusCode": 500,
            "Message": "$ctx.error.message",
            "Data": null
          }
        #else
          {
            "StatusCode": 200,
            "Message": null,
            "Data": $util.toJson($ctx.result)
          }
        #end
  ApplicationsUpdateResolver:
    Type: AWS::AppSync::Resolver
    DependsOn: ApplicationsDynamoDbDataSource
    Properties:
      ApiId: !GetAtt IntegrationHubApi.ApiId
      TypeName: Mutation
      FieldName: ApplicationsUpdate
      DataSourceName: ApplicationsDynamoDbDataSource
      RequestMappingTemplate: |
        {
          "version": "2018-05-29",
          "operation": "UpdateItem",
          "key": {
            "applicationId": $util.dynamodb.toDynamoDBJson($ctx.args.input.applicationId)
          },
          "attributeValues": $util.dynamodb.toMapValuesJson($ctx.args.input)
        }
      ResponseMappingTemplate: |
        #if($ctx.error)
          {
            "StatusCode": 500,
            "Message": "$ctx.error.message",
            "Data": null
          }
        #else
          {
            "StatusCode": 200,
            "Message": null,
            "Data": $util.toJson($ctx.result)
          }
        #end
  ApplicationsDeleteResolver:
    Type: AWS::AppSync::Resolver
    DependsOn: ApplicationsDynamoDbDataSource
    Properties:
      ApiId: !GetAtt IntegrationHubApi.ApiId
      TypeName: Mutation
      FieldName: ApplicationsDelete
      DataSourceName: ApplicationsDynamoDbDataSource
      RequestMappingTemplate: |
        {
          "version": "2018-05-29",
          "operation": "DeleteItem",
          "key": {
            "applicationId": $util.dynamodb.toDynamoDBJson($ctx.args.input.applicationId)
          }
        }
      ResponseMappingTemplate: |
        #if($ctx.error)
          {
            "StatusCode": 500,
            "Message": "$ctx.error.message",
            "Data": null
          }
        #else
          {
            "StatusCode": 200,
            "Message": null,
            "Data": $util.toJson($ctx.result)
          }
        #end
  ApplicationsDisableResolver:
    Type: AWS::AppSync::Resolver
    DependsOn: ApplicationsDynamoDbDataSource
    Properties:
      ApiId: !GetAtt IntegrationHubApi.ApiId
      TypeName: Mutation
      FieldName: ApplicationsDisable
      DataSourceName: ApplicationsDynamoDbDataSource
      RequestMappingTemplate: |
        {
          "version": "2018-05-29",
          "operation": "UpdateItem",
          "key": {
            "applicationId": $util.dynamodb.toDynamoDBJson($ctx.args.input.applicationId)
          },
          "attributeValues": $util.dynamodb.toMapValuesJson($ctx.args.input)
        }
      ResponseMappingTemplate: |
        #if($ctx.error)
          {
            "StatusCode": 500,
            "Message": "$ctx.error.message",
            "Data": null
          }
        #else
          {
            "StatusCode": 200,
            "Message": null,
            "Data": $util.toJson($ctx.result)
          }
        #end
  ApplicationsQueryByApplicationIdResolver:
    Type: AWS::AppSync::Resolver
    DependsOn: ApplicationsDynamoDbDataSource
    Properties:
      ApiId: !GetAtt IntegrationHubApi.ApiId
      TypeName: Query
      FieldName: ApplicationsQueryByApplicationId
      DataSourceName: ApplicationsDynamoDbDataSource
      RequestMappingTemplate: |
        {
          "version": "2018-05-29",
          "operation": "Query",
          "query": {
            "expression": "#pk = :pk",
            "expressionNames": {
              "#pk": "applicationId"
            },
            "expressionValues": {
              ":pk": $util.dynamodb.toDynamoDBJson($ctx.args.input.applicationId)
            }
          }
        }
      ResponseMappingTemplate: |
        #if($ctx.error)
          {
            "StatusCode": 500,
            "Message": "$ctx.error.message",
            "Data": null
          }
        #else
          {
            "StatusCode": 200,
            "Message": null,
            "Data": $util.toJson($ctx.result)
          }
        #end
  ApplicationUsersCreateResolver:
    Type: AWS::AppSync::Resolver
    DependsOn: ApplicationUsersDynamoDbDataSource
    Properties:
      ApiId: !GetAtt IntegrationHubApi.ApiId
      TypeName: Mutation
      FieldName: ApplicationUsersCreate
      DataSourceName: ApplicationUsersDynamoDbDataSource
      RequestMappingTemplate: |
        {
          "version": "2018-05-29",
          "operation": "PutItem",
          "key": {
            "applicationUserId": $util.dynamodb.toDynamoDBJson($ctx.args.input.applicationUserId)
          },
          "attributeValues": $util.dynamodb.toMapValuesJson($ctx.args.input)
        }
      ResponseMappingTemplate: |
        #if($ctx.error)
          {
            "StatusCode": 500,
            "Message": "$ctx.error.message",
            "Data": null
          }
        #else
          {
            "StatusCode": 200,
            "Message": null,
            "Data": $util.toJson($ctx.result)
          }
        #end
  ApplicationUsersUpdateResolver:
    Type: AWS::AppSync::Resolver
    DependsOn: ApplicationUsersDynamoDbDataSource
    Properties:
      ApiId: !GetAtt IntegrationHubApi.ApiId
      TypeName: Mutation
      FieldName: ApplicationUsersUpdate
      DataSourceName: ApplicationUsersDynamoDbDataSource
      RequestMappingTemplate: |
        {
          "version": "2018-05-29",
          "operation": "UpdateItem",
          "key": {
            "applicationUserId": $util.dynamodb.toDynamoDBJson($ctx.args.input.applicationUserId)
          },
          "attributeValues": $util.dynamodb.toMapValuesJson($ctx.args.input)
        }
      ResponseMappingTemplate: |
        #if($ctx.error)
          {
            "StatusCode": 500,
            "Message": "$ctx.error.message",
            "Data": null
          }
        #else
          {
            "StatusCode": 200,
            "Message": null,
            "Data": $util.toJson($ctx.result)
          }
        #end
  ApplicationUsersDeleteResolver:
    Type: AWS::AppSync::Resolver
    DependsOn: ApplicationUsersDynamoDbDataSource
    Properties:
      ApiId: !GetAtt IntegrationHubApi.ApiId
      TypeName: Mutation
      FieldName: ApplicationUsersDelete
      DataSourceName: ApplicationUsersDynamoDbDataSource
      RequestMappingTemplate: |
        {
          "version": "2018-05-29",
          "operation": "DeleteItem",
          "key": {
            "applicationUserId": $util.dynamodb.toDynamoDBJson($ctx.args.input.applicationUserId)
          }
        }
      ResponseMappingTemplate: |
        #if($ctx.error)
          {
            "StatusCode": 500,
            "Message": "$ctx.error.message",
            "Data": null
          }
        #else
          {
            "StatusCode": 200,
            "Message": null,
            "Data": $util.toJson($ctx.result)
          }
        #end
  ApplicationUsersDisableResolver:
    Type: AWS::AppSync::Resolver
    DependsOn: ApplicationUsersDynamoDbDataSource
    Properties:
      ApiId: !GetAtt IntegrationHubApi.ApiId
      TypeName: Mutation
      FieldName: ApplicationUsersDisable
      DataSourceName: ApplicationUsersDynamoDbDataSource
      RequestMappingTemplate: |
        {
          "version": "2018-05-29",
          "operation": "UpdateItem",
          "key": {
            "applicationUserId": $util.dynamodb.toDynamoDBJson($ctx.args.input.applicationUserId)
          },
          "attributeValues": $util.dynamodb.toMapValuesJson($ctx.args.input)
        }
      ResponseMappingTemplate: |
        #if($ctx.error)
          {
            "StatusCode": 500,
            "Message": "$ctx.error.message",
            "Data": null
          }
        #else
          {
            "StatusCode": 200,
            "Message": null,
            "Data": $util.toJson($ctx.result)
          }
        #end
  ApplicationUsersQueryByApplicationUserIdResolver:
    Type: AWS::AppSync::Resolver
    DependsOn: ApplicationUsersDynamoDbDataSource
    Properties:
      ApiId: !GetAtt IntegrationHubApi.ApiId
      TypeName: Query
      FieldName: ApplicationUsersQueryByApplicationUserId
      DataSourceName: ApplicationUsersDynamoDbDataSource
      RequestMappingTemplate: |
        {
          "version": "2018-05-29",
          "operation": "Query",
          "query": {
            "expression": "#pk = :pk",
            "expressionNames": {
              "#pk": "applicationUserId"
            },
            "expressionValues": {
              ":pk": $util.dynamodb.toDynamoDBJson($ctx.args.input.applicationUserId)
            }
          }
        }
      ResponseMappingTemplate: |
        #if($ctx.error)
          {
            "StatusCode": 500,
            "Message": "$ctx.error.message",
            "Data": null
          }
        #else
          {
            "StatusCode": 200,
            "Message": null,
            "Data": $util.toJson($ctx.result)
          }
        #end
  ApplicationUsersQueryByUserIdAndApplicationIdResolver:
    Type: AWS::AppSync::Resolver
    DependsOn: ApplicationUsersDynamoDbDataSource
    Properties:
      ApiId: !GetAtt IntegrationHubApi.ApiId
      TypeName: Query
      FieldName: ApplicationUsersQueryByUserIdAndApplicationId
      DataSourceName: ApplicationUsersDynamoDbDataSource
      RequestMappingTemplate: |
        {
          "version": "2018-05-29",
          "operation": "Query",
          "index": "UserAppIndex",
          "query": {
            "expression": "#pk = :pk" AND #sk = :sk,
            "expressionNames": {
              "#pk": "userId",
              "#sk": "applicationId"
            },
            "expressionValues": {
              ":pk": $util.dynamodb.toDynamoDBJson($ctx.args.input.userId),
              ":sk": $util.dynamodb.toDynamoDBJson($ctx.args.input.applicationId)
            }
          }
        }
      ResponseMappingTemplate: |
        #if($ctx.error)
          {
            "StatusCode": 500,
            "Message": "$ctx.error.message",
            "Data": null
          }
        #else
          {
            "StatusCode": 200,
            "Message": null,
            "Data": $util.toJson($ctx.result)
          }
        #end
  ApplicationUsersQueryByApplicationIdAndUserIdResolver:
    Type: AWS::AppSync::Resolver
    DependsOn: ApplicationUsersDynamoDbDataSource
    Properties:
      ApiId: !GetAtt IntegrationHubApi.ApiId
      TypeName: Query
      FieldName: ApplicationUsersQueryByApplicationIdAndUserId
      DataSourceName: ApplicationUsersDynamoDbDataSource
      RequestMappingTemplate: |
        {
          "version": "2018-05-29",
          "operation": "Query",
          "index": "AppUserIndex",
          "query": {
            "expression": "#pk = :pk" AND #sk = :sk,
            "expressionNames": {
              "#pk": "applicationId",
              "#sk": "userId"
            },
            "expressionValues": {
              ":pk": $util.dynamodb.toDynamoDBJson($ctx.args.input.applicationId),
              ":sk": $util.dynamodb.toDynamoDBJson($ctx.args.input.userId)
            }
          }
        }
      ResponseMappingTemplate: |
        #if($ctx.error)
          {
            "StatusCode": 500,
            "Message": "$ctx.error.message",
            "Data": null
          }
        #else
          {
            "StatusCode": 200,
            "Message": null,
            "Data": $util.toJson($ctx.result)
          }
        #end
  RolesCreateResolver:
    Type: AWS::AppSync::Resolver
    DependsOn: RolesDynamoDbDataSource
    Properties:
      ApiId: !GetAtt IntegrationHubApi.ApiId
      TypeName: Mutation
      FieldName: RolesCreate
      DataSourceName: RolesDynamoDbDataSource
      RequestMappingTemplate: |
        {
          "version": "2018-05-29",
          "operation": "PutItem",
          "key": {
            "roleId": $util.dynamodb.toDynamoDBJson($ctx.args.input.roleId)
          },
          "attributeValues": $util.dynamodb.toMapValuesJson($ctx.args.input)
        }
      ResponseMappingTemplate: |
        #if($ctx.error)
          {
            "StatusCode": 500,
            "Message": "$ctx.error.message",
            "Data": null
          }
        #else
          {
            "StatusCode": 200,
            "Message": null,
            "Data": $util.toJson($ctx.result)
          }
        #end
  RolesUpdateResolver:
    Type: AWS::AppSync::Resolver
    DependsOn: RolesDynamoDbDataSource
    Properties:
      ApiId: !GetAtt IntegrationHubApi.ApiId
      TypeName: Mutation
      FieldName: RolesUpdate
      DataSourceName: RolesDynamoDbDataSource
      RequestMappingTemplate: |
        {
          "version": "2018-05-29",
          "operation": "UpdateItem",
          "key": {
            "roleId": $util.dynamodb.toDynamoDBJson($ctx.args.input.roleId)
          },
          "attributeValues": $util.dynamodb.toMapValuesJson($ctx.args.input)
        }
      ResponseMappingTemplate: |
        #if($ctx.error)
          {
            "StatusCode": 500,
            "Message": "$ctx.error.message",
            "Data": null
          }
        #else
          {
            "StatusCode": 200,
            "Message": null,
            "Data": $util.toJson($ctx.result)
          }
        #end
  RolesDeleteResolver:
    Type: AWS::AppSync::Resolver
    DependsOn: RolesDynamoDbDataSource
    Properties:
      ApiId: !GetAtt IntegrationHubApi.ApiId
      TypeName: Mutation
      FieldName: RolesDelete
      DataSourceName: RolesDynamoDbDataSource
      RequestMappingTemplate: |
        {
          "version": "2018-05-29",
          "operation": "DeleteItem",
          "key": {
            "roleId": $util.dynamodb.toDynamoDBJson($ctx.args.input.roleId)
          }
        }
      ResponseMappingTemplate: |
        #if($ctx.error)
          {
            "StatusCode": 500,
            "Message": "$ctx.error.message",
            "Data": null
          }
        #else
          {
            "StatusCode": 200,
            "Message": null,
            "Data": $util.toJson($ctx.result)
          }
        #end
  RolesDisableResolver:
    Type: AWS::AppSync::Resolver
    DependsOn: RolesDynamoDbDataSource
    Properties:
      ApiId: !GetAtt IntegrationHubApi.ApiId
      TypeName: Mutation
      FieldName: RolesDisable
      DataSourceName: RolesDynamoDbDataSource
      RequestMappingTemplate: |
        {
          "version": "2018-05-29",
          "operation": "UpdateItem",
          "key": {
            "roleId": $util.dynamodb.toDynamoDBJson($ctx.args.input.roleId)
          },
          "attributeValues": $util.dynamodb.toMapValuesJson($ctx.args.input)
        }
      ResponseMappingTemplate: |
        #if($ctx.error)
          {
            "StatusCode": 500,
            "Message": "$ctx.error.message",
            "Data": null
          }
        #else
          {
            "StatusCode": 200,
            "Message": null,
            "Data": $util.toJson($ctx.result)
          }
        #end
  RolesQueryByRoleIdResolver:
    Type: AWS::AppSync::Resolver
    DependsOn: RolesDynamoDbDataSource
    Properties:
      ApiId: !GetAtt IntegrationHubApi.ApiId
      TypeName: Query
      FieldName: RolesQueryByRoleId
      DataSourceName: RolesDynamoDbDataSource
      RequestMappingTemplate: |
        {
          "version": "2018-05-29",
          "operation": "Query",
          "query": {
            "expression": "#pk = :pk",
            "expressionNames": {
              "#pk": "roleId"
            },
            "expressionValues": {
              ":pk": $util.dynamodb.toDynamoDBJson($ctx.args.input.roleId)
            }
          }
        }
      ResponseMappingTemplate: |
        #if($ctx.error)
          {
            "StatusCode": 500,
            "Message": "$ctx.error.message",
            "Data": null
          }
        #else
          {
            "StatusCode": 200,
            "Message": null,
            "Data": $util.toJson($ctx.result)
          }
        #end
  RolesQueryByUserIdAndRoleTypeResolver:
    Type: AWS::AppSync::Resolver
    DependsOn: RolesDynamoDbDataSource
    Properties:
      ApiId: !GetAtt IntegrationHubApi.ApiId
      TypeName: Query
      FieldName: RolesQueryByUserIdAndRoleType
      DataSourceName: RolesDynamoDbDataSource
      RequestMappingTemplate: |
        {
          "version": "2018-05-29",
          "operation": "Query",
          "index": "UserRoleIndex",
          "query": {
            "expression": "#pk = :pk" AND #sk = :sk,
            "expressionNames": {
              "#pk": "userId",
              "#sk": "roleType"
            },
            "expressionValues": {
              ":pk": $util.dynamodb.toDynamoDBJson($ctx.args.input.userId),
              ":sk": $util.dynamodb.toDynamoDBJson($ctx.args.input.roleType)
            }
          }
        }
      ResponseMappingTemplate: |
        #if($ctx.error)
          {
            "StatusCode": 500,
            "Message": "$ctx.error.message",
            "Data": null
          }
        #else
          {
            "StatusCode": 200,
            "Message": null,
            "Data": $util.toJson($ctx.result)
          }
        #end
  UsersCreateResolver:
    Type: AWS::AppSync::Resolver
    DependsOn: UsersDynamoDbDataSource
    Properties:
      ApiId: !GetAtt IntegrationHubApi.ApiId
      TypeName: Mutation
      FieldName: UsersCreate
      DataSourceName: UsersDynamoDbDataSource
      RequestMappingTemplate: |
        {
          "version": "2018-05-29",
          "operation": "PutItem",
          "key": {
            "userId": $util.dynamodb.toDynamoDBJson($ctx.args.input.userId)
          },
          "attributeValues": $util.dynamodb.toMapValuesJson($ctx.args.input)
        }
      ResponseMappingTemplate: |
        #if($ctx.error)
          {
            "StatusCode": 500,
            "Message": "$ctx.error.message",
            "Data": null
          }
        #else
          {
            "StatusCode": 200,
            "Message": null,
            "Data": $util.toJson($ctx.result)
          }
        #end
  UsersUpdateResolver:
    Type: AWS::AppSync::Resolver
    DependsOn: UsersDynamoDbDataSource
    Properties:
      ApiId: !GetAtt IntegrationHubApi.ApiId
      TypeName: Mutation
      FieldName: UsersUpdate
      DataSourceName: UsersDynamoDbDataSource
      RequestMappingTemplate: |
        {
          "version": "2018-05-29",
          "operation": "UpdateItem",
          "key": {
            "userId": $util.dynamodb.toDynamoDBJson($ctx.args.input.userId)
          },
          "attributeValues": $util.dynamodb.toMapValuesJson($ctx.args.input)
        }
      ResponseMappingTemplate: |
        #if($ctx.error)
          {
            "StatusCode": 500,
            "Message": "$ctx.error.message",
            "Data": null
          }
        #else
          {
            "StatusCode": 200,
            "Message": null,
            "Data": $util.toJson($ctx.result)
          }
        #end
  UsersDeleteResolver:
    Type: AWS::AppSync::Resolver
    DependsOn: UsersDynamoDbDataSource
    Properties:
      ApiId: !GetAtt IntegrationHubApi.ApiId
      TypeName: Mutation
      FieldName: UsersDelete
      DataSourceName: UsersDynamoDbDataSource
      RequestMappingTemplate: |
        {
          "version": "2018-05-29",
          "operation": "DeleteItem",
          "key": {
            "userId": $util.dynamodb.toDynamoDBJson($ctx.args.input.userId)
          }
        }
      ResponseMappingTemplate: |
        #if($ctx.error)
          {
            "StatusCode": 500,
            "Message": "$ctx.error.message",
            "Data": null
          }
        #else
          {
            "StatusCode": 200,
            "Message": null,
            "Data": $util.toJson($ctx.result)
          }
        #end
  UsersDisableResolver:
    Type: AWS::AppSync::Resolver
    DependsOn: UsersDynamoDbDataSource
    Properties:
      ApiId: !GetAtt IntegrationHubApi.ApiId
      TypeName: Mutation
      FieldName: UsersDisable
      DataSourceName: UsersDynamoDbDataSource
      RequestMappingTemplate: |
        {
          "version": "2018-05-29",
          "operation": "UpdateItem",
          "key": {
            "userId": $util.dynamodb.toDynamoDBJson($ctx.args.input.userId)
          },
          "attributeValues": $util.dynamodb.toMapValuesJson($ctx.args.input)
        }
      ResponseMappingTemplate: |
        #if($ctx.error)
          {
            "StatusCode": 500,
            "Message": "$ctx.error.message",
            "Data": null
          }
        #else
          {
            "StatusCode": 200,
            "Message": null,
            "Data": $util.toJson($ctx.result)
          }
        #end
  UsersQueryByUserIdResolver:
    Type: AWS::AppSync::Resolver
    DependsOn: UsersDynamoDbDataSource
    Properties:
      ApiId: !GetAtt IntegrationHubApi.ApiId
      TypeName: Query
      FieldName: UsersQueryByUserId
      DataSourceName: UsersDynamoDbDataSource
      RequestMappingTemplate: |
        {
          "version": "2018-05-29",
          "operation": "Query",
          "query": {
            "expression": "#pk = :pk",
            "expressionNames": {
              "#pk": "userId"
            },
            "expressionValues": {
              ":pk": $util.dynamodb.toDynamoDBJson($ctx.args.input.userId)
            }
          }
        }
      ResponseMappingTemplate: |
        #if($ctx.error)
          {
            "StatusCode": 500,
            "Message": "$ctx.error.message",
            "Data": null
          }
        #else
          {
            "StatusCode": 200,
            "Message": null,
            "Data": $util.toJson($ctx.result)
          }
        #end
  UsersQueryByEmailResolver:
    Type: AWS::AppSync::Resolver
    DependsOn: UsersDynamoDbDataSource
    Properties:
      ApiId: !GetAtt IntegrationHubApi.ApiId
      TypeName: Query
      FieldName: UsersQueryByEmail
      DataSourceName: UsersDynamoDbDataSource
      RequestMappingTemplate: |
        {
          "version": "2018-05-29",
          "operation": "Query",
          "index": "EmailIndex",
          "query": {
            "expression": "#pk = :pk",
            "expressionNames": {
              "#pk": "email"
            },
            "expressionValues": {
              ":pk": $util.dynamodb.toDynamoDBJson($ctx.args.input.email)
            }
          }
        }
      ResponseMappingTemplate: |
        #if($ctx.error)
          {
            "StatusCode": 500,
            "Message": "$ctx.error.message",
            "Data": null
          }
        #else
          {
            "StatusCode": 200,
            "Message": null,
            "Data": $util.toJson($ctx.result)
          }
        #end
  UsersQueryByCognitoIdResolver:
    Type: AWS::AppSync::Resolver
    DependsOn: UsersDynamoDbDataSource
    Properties:
      ApiId: !GetAtt IntegrationHubApi.ApiId
      TypeName: Query
      FieldName: UsersQueryByCognitoId
      DataSourceName: UsersDynamoDbDataSource
      RequestMappingTemplate: |
        {
          "version": "2018-05-29",
          "operation": "Query",
          "index": "CognitoIdIndex",
          "query": {
            "expression": "#pk = :pk",
            "expressionNames": {
              "#pk": "cognitoId"
            },
            "expressionValues": {
              ":pk": $util.dynamodb.toDynamoDBJson($ctx.args.input.cognitoId)
            }
          }
        }
      ResponseMappingTemplate: |
        #if($ctx.error)
          {
            "StatusCode": 500,
            "Message": "$ctx.error.message",
            "Data": null
          }
        #else
          {
            "StatusCode": 200,
            "Message": null,
            "Data": $util.toJson($ctx.result)
          }
        #end 

# --------------------------------------------------- #
Outputs:
  IntegrationHubApiId:
    Description: The ID of the AppSync API
    Value: !GetAtt IntegrationHubApi.ApiId
    Export:
      Name: !Sub ${CustomerId}-${ProjectId}-${Environment}-appsync-api-id

  IntegrationHubApiEndpoint:
    Description: The endpoint URL of the AppSync API
    Value: !GetAtt IntegrationHubApi.GraphQLUrl
    Export:
      Name: !Sub ${CustomerId}-${ProjectId}-${Environment}-appsync-api-endpoint 