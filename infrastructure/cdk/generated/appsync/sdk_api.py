# AUTO-GENERATED by orb-schema-generator v2.0.3 - DO NOT EDIT
# Regenerate with: orb-schema generate
from pathlib import Path
from typing import Dict

from aws_cdk import (
    aws_appsync as appsync,
    aws_dynamodb as dynamodb,
    aws_iam as iam,
    aws_lambda as lambda_,
    aws_ssm as ssm,
)
from constructs import Construct


class AppSyncSdkApi(Construct):
    """AppSync GraphQL SDK API construct with Lambda authorizer.

    Args:
        scope: CDK construct scope
        id: Construct ID
        tables: Dictionary of DynamoDB tables by schema name
        lambda_functions: Optional dictionary of Lambda functions
        enable_xray: Enable X-Ray tracing (default False)
    """

    def __init__(
        self,
        scope: Construct,
        id: str,
        tables: Dict[str, dynamodb.Table],
        lambda_functions: Dict[str, lambda_.IFunction] | None = None,
        enable_xray: bool = False,
    ) -> None:
        super().__init__(scope, id)

        # Calculate schema path relative to this file
        schema_path = Path(__file__).parent / "../../../../apps/api/graphql-sdk/schema.graphql"

        # Get Lambda authorizer ARN from SSM
        authorizer_arn = ssm.StringParameter.value_for_string_parameter(
            self, "/orb/integration-hub/dev/lambda/authorizer/arn"
        )
        authorizer_function = lambda_.Function.from_function_arn(
            self, "AuthorizerFunction", authorizer_arn
        )

        # Create CloudWatch Logs role for AppSync
        logging_role = iam.Role(
            self, "AppSyncSdkLoggingRole",
            assumed_by=iam.ServicePrincipal("appsync.amazonaws.com"),
            managed_policies=[
                iam.ManagedPolicy.from_aws_managed_policy_name(
                    "service-role/AWSAppSyncPushToCloudWatchLogs"
                ),
            ],
        )

        # Create GraphQL SDK API
        self.api = appsync.GraphqlApi(
            self, "SdkApi",
            name="orb-integration-hub-dev-appsync-sdk",
            definition=appsync.Definition.from_file(str(schema_path)),
            authorization_config=appsync.AuthorizationConfig(
                default_authorization=appsync.AuthorizationMode(
                    authorization_type=appsync.AuthorizationType.LAMBDA,
                    lambda_authorizer_config=appsync.LambdaAuthorizerConfig(
                        handler=authorizer_function,
                    ),
                ),
            ),
            log_config=appsync.LogConfig(
                field_log_level=appsync.FieldLogLevel.ALL,
                exclude_verbose_content=False,
                role=logging_role,
            ),
            xray_enabled=enable_xray,
        )

        # SSM Parameters for SDK API discovery
        ssm.StringParameter(
            self, "SdkApiIdParameter",
            parameter_name="/orb/integration-hub/dev/appsync/sdk-api-id",
            string_value=self.api.api_id,
        )

        ssm.StringParameter(
            self, "SdkGraphqlUrlParameter",
            parameter_name="/orb/integration-hub/dev/appsync/sdk-graphql-url",
            string_value=self.api.graphql_url,
        )

        # Add DynamoDB data sources and resolvers for Users and Applications only

        # Users data source and resolvers
        users_data_source = self.api.add_dynamo_db_data_source(
            "UsersDataSource",
            tables["Users"],
        )

        users_data_source.create_resolver(
            "UsersCreateResolver",
            type_name="Mutation",
            field_name="UsersCreate",
            request_mapping_template=appsync.MappingTemplate.from_file(
                str(Path(__file__).parent / "resolvers/Mutation.UsersCreate.request.vtl")
            ),
            response_mapping_template=appsync.MappingTemplate.from_file(
                str(Path(__file__).parent / "resolvers/Mutation.UsersCreate.response.vtl")
            ),
        )

        users_data_source.create_resolver(
            "UsersUpdateResolver",
            type_name="Mutation",
            field_name="UsersUpdate",
            request_mapping_template=appsync.MappingTemplate.from_file(
                str(Path(__file__).parent / "resolvers/Mutation.UsersUpdate.request.vtl")
            ),
            response_mapping_template=appsync.MappingTemplate.from_file(
                str(Path(__file__).parent / "resolvers/Mutation.UsersUpdate.response.vtl")
            ),
        )

        users_data_source.create_resolver(
            "UsersDeleteResolver",
            type_name="Mutation",
            field_name="UsersDelete",
            request_mapping_template=appsync.MappingTemplate.from_file(
                str(Path(__file__).parent / "resolvers/Mutation.UsersDelete.request.vtl")
            ),
            response_mapping_template=appsync.MappingTemplate.from_file(
                str(Path(__file__).parent / "resolvers/Mutation.UsersDelete.response.vtl")
            ),
        )

        users_data_source.create_resolver(
            "UsersDisableResolver",
            type_name="Mutation",
            field_name="UsersDisable",
            request_mapping_template=appsync.MappingTemplate.from_file(
                str(Path(__file__).parent / "resolvers/Mutation.UsersDisable.request.vtl")
            ),
            response_mapping_template=appsync.MappingTemplate.from_file(
                str(Path(__file__).parent / "resolvers/Mutation.UsersDisable.response.vtl")
            ),
        )

        users_data_source.create_resolver(
            "UsersGetResolver",
            type_name="Query",
            field_name="UsersGet",
            request_mapping_template=appsync.MappingTemplate.from_file(
                str(Path(__file__).parent / "resolvers/Query.UsersGet.request.vtl")
            ),
            response_mapping_template=appsync.MappingTemplate.from_file(
                str(Path(__file__).parent / "resolvers/Query.UsersGet.response.vtl")
            ),
        )

        users_data_source.create_resolver(
            "UsersListByUserIdResolver",
            type_name="Query",
            field_name="UsersListByUserId",
            request_mapping_template=appsync.MappingTemplate.from_file(
                str(Path(__file__).parent / "resolvers/Query.UsersListByUserId.request.vtl")
            ),
            response_mapping_template=appsync.MappingTemplate.from_file(
                str(Path(__file__).parent / "resolvers/Query.UsersListByUserId.response.vtl")
            ),
        )

        users_data_source.create_resolver(
            "UsersListByEmailResolver",
            type_name="Query",
            field_name="UsersListByEmail",
            request_mapping_template=appsync.MappingTemplate.from_file(
                str(Path(__file__).parent / "resolvers/Query.UsersListByEmail.request.vtl")
            ),
            response_mapping_template=appsync.MappingTemplate.from_file(
                str(Path(__file__).parent / "resolvers/Query.UsersListByEmail.response.vtl")
            ),
        )

        users_data_source.create_resolver(
            "UsersListByCognitoIdResolver",
            type_name="Query",
            field_name="UsersListByCognitoId",
            request_mapping_template=appsync.MappingTemplate.from_file(
                str(Path(__file__).parent / "resolvers/Query.UsersListByCognitoId.request.vtl")
            ),
            response_mapping_template=appsync.MappingTemplate.from_file(
                str(Path(__file__).parent / "resolvers/Query.UsersListByCognitoId.response.vtl")
            ),
        )

        users_data_source.create_resolver(
            "UsersListByCognitoSubResolver",
            type_name="Query",
            field_name="UsersListByCognitoSub",
            request_mapping_template=appsync.MappingTemplate.from_file(
                str(Path(__file__).parent / "resolvers/Query.UsersListByCognitoSub.request.vtl")
            ),
            response_mapping_template=appsync.MappingTemplate.from_file(
                str(Path(__file__).parent / "resolvers/Query.UsersListByCognitoSub.response.vtl")
            ),
        )

        # Applications data source and resolvers
        applications_data_source = self.api.add_dynamo_db_data_source(
            "ApplicationsDataSource",
            tables["Applications"],
        )

        applications_data_source.create_resolver(
            "ApplicationsCreateResolver",
            type_name="Mutation",
            field_name="ApplicationsCreate",
            request_mapping_template=appsync.MappingTemplate.from_file(
                str(Path(__file__).parent / "resolvers/Mutation.ApplicationsCreate.request.vtl")
            ),
            response_mapping_template=appsync.MappingTemplate.from_file(
                str(Path(__file__).parent / "resolvers/Mutation.ApplicationsCreate.response.vtl")
            ),
        )

        applications_data_source.create_resolver(
            "ApplicationsUpdateResolver",
            type_name="Mutation",
            field_name="ApplicationsUpdate",
            request_mapping_template=appsync.MappingTemplate.from_file(
                str(Path(__file__).parent / "resolvers/Mutation.ApplicationsUpdate.request.vtl")
            ),
            response_mapping_template=appsync.MappingTemplate.from_file(
                str(Path(__file__).parent / "resolvers/Mutation.ApplicationsUpdate.response.vtl")
            ),
        )

        applications_data_source.create_resolver(
            "ApplicationsDeleteResolver",
            type_name="Mutation",
            field_name="ApplicationsDelete",
            request_mapping_template=appsync.MappingTemplate.from_file(
                str(Path(__file__).parent / "resolvers/Mutation.ApplicationsDelete.request.vtl")
            ),
            response_mapping_template=appsync.MappingTemplate.from_file(
                str(Path(__file__).parent / "resolvers/Mutation.ApplicationsDelete.response.vtl")
            ),
        )

        applications_data_source.create_resolver(
            "ApplicationsDisableResolver",
            type_name="Mutation",
            field_name="ApplicationsDisable",
            request_mapping_template=appsync.MappingTemplate.from_file(
                str(Path(__file__).parent / "resolvers/Mutation.ApplicationsDisable.request.vtl")
            ),
            response_mapping_template=appsync.MappingTemplate.from_file(
                str(Path(__file__).parent / "resolvers/Mutation.ApplicationsDisable.response.vtl")
            ),
        )

        applications_data_source.create_resolver(
            "ApplicationsGetResolver",
            type_name="Query",
            field_name="ApplicationsGet",
            request_mapping_template=appsync.MappingTemplate.from_file(
                str(Path(__file__).parent / "resolvers/Query.ApplicationsGet.request.vtl")
            ),
            response_mapping_template=appsync.MappingTemplate.from_file(
                str(Path(__file__).parent / "resolvers/Query.ApplicationsGet.response.vtl")
            ),
        )

        applications_data_source.create_resolver(
            "ApplicationsListByApplicationIdResolver",
            type_name="Query",
            field_name="ApplicationsListByApplicationId",
            request_mapping_template=appsync.MappingTemplate.from_file(
                str(Path(__file__).parent / "resolvers/Query.ApplicationsListByApplicationId.request.vtl")
            ),
            response_mapping_template=appsync.MappingTemplate.from_file(
                str(Path(__file__).parent / "resolvers/Query.ApplicationsListByApplicationId.response.vtl")
            ),
        )

        applications_data_source.create_resolver(
            "ApplicationsListByOrganizationIdResolver",
            type_name="Query",
            field_name="ApplicationsListByOrganizationId",
            request_mapping_template=appsync.MappingTemplate.from_file(
                str(Path(__file__).parent / "resolvers/Query.ApplicationsListByOrganizationId.request.vtl")
            ),
            response_mapping_template=appsync.MappingTemplate.from_file(
                str(Path(__file__).parent / "resolvers/Query.ApplicationsListByOrganizationId.response.vtl")
            ),
        )

        applications_data_source.create_resolver(
            "ApplicationsListByOrganizationIdAndCreatedAtResolver",
            type_name="Query",
            field_name="ApplicationsListByOrganizationIdAndCreatedAt",
            request_mapping_template=appsync.MappingTemplate.from_file(
                str(Path(__file__).parent / "resolvers/Query.ApplicationsListByOrganizationIdAndCreatedAt.request.vtl")
            ),
            response_mapping_template=appsync.MappingTemplate.from_file(
                str(Path(__file__).parent / "resolvers/Query.ApplicationsListByOrganizationIdAndCreatedAt.response.vtl")
            ),
        )
