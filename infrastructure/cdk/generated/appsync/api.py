# AUTO-GENERATED by orb-schema-generator v0.17.0 - DO NOT EDIT
# Regenerate with: orb-schema generate
from pathlib import Path
from typing import Dict
import time

from aws_cdk import (
    aws_appsync as appsync,
    aws_dynamodb as dynamodb,
    aws_iam as iam,
    aws_lambda as lambda_,
    aws_ssm as ssm,
)
from constructs import Construct


class AppSyncApi(Construct):
    """AppSync GraphQL API construct."""

    def __init__(
        self,
        scope: Construct,
        id: str,
        tables: Dict[str, dynamodb.Table],
        lambda_functions: Dict[str, lambda_.IFunction] | None = None,
    ) -> None:
        super().__init__(scope, id)

        # Calculate schema path relative to this file
        schema_path = Path(__file__).parent / "../../../../apps/api/graphql/schema.graphql"

        # Create GraphQL API
        self.api = appsync.GraphqlApi(
            self, "Api",
            name="GeneratedApi",
            definition=appsync.Definition.from_file(str(schema_path)),
            authorization_config=appsync.AuthorizationConfig(
                default_authorization=appsync.AuthorizationMode(
                    authorization_type=appsync.AuthorizationType.API_KEY,
                ),
            ),
        )

        # Create API Key
        self.api_key = appsync.CfnApiKey(
            self, "ApiKey",
            api_id=self.api.api_id,
            description="API Key for unauthenticated access",
            expires=int(time.time()) + (365 * 24 * 60 * 60),
        )

        # SSM Parameters
        ssm.StringParameter(
            self, "ApiIdParameter",
            parameter_name="/orb/integration-hub/dev/appsync/api-id",
            string_value=self.api.api_id,
        )

        ssm.StringParameter(
            self, "GraphqlUrlParameter",
            parameter_name="/orb/integration-hub/dev/appsync/graphql-url",
            string_value=self.api.graphql_url,
        )


        # Add Lambda data sources and resolvers

        # CreateUserFromCognito Lambda data source and resolvers
        create_user_from_cognito_lambda_arn = ssm.StringParameter.value_for_string_parameter(
            self, "/orb/integration-hub/dev/lambda/createuserfromcognito/arn"
        )
        create_user_from_cognito_lambda = lambda_.Function.from_function_arn(
            self, "CreateUserFromCognitoLambda", create_user_from_cognito_lambda_arn
        )
        create_user_from_cognito_lambda_data_source = self.api.add_lambda_data_source(
            "CreateUserFromCognitoLambdaDataSource",
            create_user_from_cognito_lambda,
        )

        create_user_from_cognito_lambda_data_source.create_resolver(
            "CreateUserFromCognitoResolver",
            type_name="Mutation",
            field_name="CreateUserFromCognito",
        )


        # CheckEmailExists Lambda data source and resolvers
        check_email_exists_lambda_arn = ssm.StringParameter.value_for_string_parameter(
            self, "/orb/integration-hub/dev/lambda/checkemailexists/arn"
        )
        check_email_exists_lambda = lambda_.Function.from_function_arn(
            self, "CheckEmailExistsLambda", check_email_exists_lambda_arn
        )
        check_email_exists_lambda_data_source = self.api.add_lambda_data_source(
            "CheckEmailExistsLambdaDataSource",
            check_email_exists_lambda,
        )

        check_email_exists_lambda_data_source.create_resolver(
            "CheckEmailExistsResolver",
            type_name="Query",
            field_name="CheckEmailExists",
        )


        # SmsVerification Lambda data source and resolvers
        sms_verification_lambda_arn = ssm.StringParameter.value_for_string_parameter(
            self, "/orb/integration-hub/dev/lambda/smsverification/arn"
        )
        sms_verification_lambda = lambda_.Function.from_function_arn(
            self, "SmsVerificationLambda", sms_verification_lambda_arn
        )
        sms_verification_lambda_data_source = self.api.add_lambda_data_source(
            "SmsVerificationLambdaDataSource",
            sms_verification_lambda,
        )

        sms_verification_lambda_data_source.create_resolver(
            "SmsVerificationResolver",
            type_name="Mutation",
            field_name="SmsVerification",
        )
