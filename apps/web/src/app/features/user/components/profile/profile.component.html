<!-- 
file: frontend/src/app/features/user/components/profile/profile.component.html
author: Corey Dale Peters
date: 2025-03-07
description: HTML template file - Profile page with step-based setup flow
-->

<div class="profile-container">
  <div class="orb-page-header">
    <div class="orb-page-header__content">
      <div class="orb-page-header__flex-container">
        <div class="orb-page-header__logo-section">
          <img src="assets/orb-logo.jpg" alt="Orb Integration Hub Logo" class="orb-page-header__logo">
        </div>
        <div class="orb-page-header__text-section" *ngIf="currentUser$ | async as user">
          <div class="orb-page-header__greeting">
            <div class="orb-page-header__icon-title">
              <img src="../../../../../assets/hardhat.jpg" alt="Engineering" class="orb-page-header__icon">
              <h1 class="orb-page-header__title">
                {{ setupState.isFlowMode ? 'Profile Setup' : 'Profile Settings' }}
              </h1>
            </div>
            <p class="orb-page-header__subtitle" *ngIf="isAccountComplete(user) && !setupState.isFlowMode; else pendingMessage">
              Your profile is complete and ready for engineering work
            </p>
            <ng-template #pendingMessage>
              <p class="orb-page-header__subtitle orb-page-header__subtitle--warning">
                {{ setupState.isFlowMode ? 'Complete the steps below to finish your profile' : 'Complete your profile setup to activate your account' }}
              </p>
            </ng-template>
            <p class="orb-page-header__hint" *ngIf="!setupState.isFlowMode">
              Review your personal information below and click the edit button to make changes. Ensure all verification steps are completed for full account access.
            </p>
            <div class="orb-page-header__status" *ngIf="!setupState.isFlowMode">
              <span class="orb-header-badge" 
                    [ngClass]="'orb-header-badge--' + getStatusClass(user.status)">
                <fa-icon [icon]="isAccountComplete(user) ? 'check-circle' : 'exclamation-triangle'" class="orb-header-badge__icon"></fa-icon>
                {{ isAccountComplete(user) ? 'Account Complete' : 'Profile Incomplete' }}
              </span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Profile Overview Card - Only show when NOT in flow mode -->
  <div class="profile-overview-section" *ngIf="!setupState.isFlowMode && (currentUser$ | async) as user">
    <div class="orb-card">
      <div class="orb-card__header">
        <h2 class="orb-card__title">
          <fa-icon icon="user" class="orb-card__icon"></fa-icon>
          Profile Overview
        </h2>
        <div class="orb-card__header-actions">
          <app-status-badge 
            [status]="user.status" 
            type="user"
            [showIcon]="true"
            [showLabel]="true"
            size="medium"
            variant="badge">
          </app-status-badge>
          <button 
            class="orb-card-btn"
            (click)="startFullFlow()"
            type="button">
            <fa-icon icon="edit" class="orb-card-btn__icon"></fa-icon>
            Edit Profile
          </button>
        </div>
      </div>
      
      <div class="orb-card__content orb-card__content--padded">
        <div class="profile-overview-grid">
          <div class="profile-overview-item">
            <div class="profile-overview-item__label">Full Name</div>
            <div class="profile-overview-item__value">{{ user.firstName }} {{ user.lastName }}</div>
          </div>
          
          <div class="profile-overview-item">
            <div class="profile-overview-item__label">Email Address</div>
            <div class="profile-overview-item__value">
              {{ user.email }}
              <app-status-badge 
                [status]="user.emailVerified ? 'VERIFIED' : 'PENDING'" 
                type="verification"
                [showIcon]="true"
                [showLabel]="true"
                size="small"
                variant="badge">
              </app-status-badge>
            </div>
          </div>
          
          <div class="profile-overview-item">
            <div class="profile-overview-item__label">Phone Number</div>
            <div class="profile-overview-item__value">
              {{ user.phoneNumber || 'Not provided' }}
              <app-status-badge 
                *ngIf="user.phoneNumber"
                [status]="user.phoneVerified ? 'VERIFIED' : 'PENDING'" 
                type="verification"
                [showIcon]="true"
                [showLabel]="true"
                size="small"
                variant="badge">
              </app-status-badge>
            </div>
          </div>
          
          <div class="profile-overview-item">
            <div class="profile-overview-item__label">Account Type</div>
            <div class="profile-overview-item__value">
              <span *ngFor="let group of getGroupsArray(user.groups); let last = last" 
                    class="role-badge">
                {{ group }}<span *ngIf="!last">, </span>
              </span>
            </div>
          </div>
          
          <div class="profile-overview-item">
            <div class="profile-overview-item__label">Member Since</div>
            <div class="profile-overview-item__value">{{ formatDate(user.createdAt) }}</div>
          </div>
          
          <div class="profile-overview-item">
            <div class="profile-overview-item__label">Last Updated</div>
            <div class="profile-overview-item__value">{{ formatDate(user.updatedAt) }}</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Step-Based Profile Setup Flow -->
  <div class="profile-setup-flow" *ngIf="setupState.isFlowMode && (currentUser$ | async) as user">
    
    <!-- Progress Indicator (using shared component) -->
    <app-progress-steps
      [steps]="profileSteps"
      [currentStep]="getCurrentStepNumber()">
    </app-progress-steps>

    <!-- Step 1: Name -->
    <div class="profile-setup-flow__step" *ngIf="setupState.currentStep === ProfileSetupStep.NAME">
      <div class="profile-setup-flow__step-card">
        <h2 class="profile-setup-flow__step-title">Your Name</h2>
        <p class="profile-setup-flow__step-description">Enter your legal name as it appears on your ID.</p>
        
        <form [formGroup]="nameForm" class="profile-setup-flow__form">
          <div class="profile-setup-flow__input-group">
            <label for="setup-firstName" class="profile-setup-flow__label">
              First Name <span class="profile-setup-flow__required">*</span>
            </label>
            <input 
              type="text" 
              id="setup-firstName" 
              formControlName="firstName" 
              class="profile-setup-flow__input"
              [ngClass]="{'profile-setup-flow__input--error': nameForm.get('firstName')?.invalid && nameForm.get('firstName')?.touched}"
              placeholder="Enter your first name"
              autocomplete="given-name">
            <div *ngIf="nameForm.get('firstName')?.invalid && nameForm.get('firstName')?.touched" 
                 class="profile-setup-flow__error">
              <span *ngIf="nameForm.get('firstName')?.errors?.['required']">First name is required</span>
              <span *ngIf="nameForm.get('firstName')?.errors?.['minlength']">First name must be at least 2 characters</span>
            </div>
          </div>
          
          <div class="profile-setup-flow__input-group">
            <label for="setup-lastName" class="profile-setup-flow__label">
              Last Name <span class="profile-setup-flow__required">*</span>
            </label>
            <input 
              type="text" 
              id="setup-lastName" 
              formControlName="lastName" 
              class="profile-setup-flow__input"
              [ngClass]="{'profile-setup-flow__input--error': nameForm.get('lastName')?.invalid && nameForm.get('lastName')?.touched}"
              placeholder="Enter your last name"
              autocomplete="family-name">
            <div *ngIf="nameForm.get('lastName')?.invalid && nameForm.get('lastName')?.touched" 
                 class="profile-setup-flow__error">
              <span *ngIf="nameForm.get('lastName')?.errors?.['required']">Last name is required</span>
              <span *ngIf="nameForm.get('lastName')?.errors?.['minlength']">Last name must be at least 2 characters</span>
            </div>
          </div>
        </form>
        
        <div class="profile-setup-flow__actions">
          <button 
            type="button" 
            class="profile-setup-flow__button profile-setup-flow__button--secondary"
            (click)="showSummary()">
            Cancel
          </button>
          <button 
            type="button" 
            class="profile-setup-flow__button profile-setup-flow__button--primary"
            [disabled]="nameForm.invalid || isLoading"
            (click)="submitNameStep()">
            {{ isLoading ? 'Saving...' : 'Continue' }}
          </button>
        </div>
      </div>
    </div>

    <!-- Step 2: Phone -->
    <div class="profile-setup-flow__step" *ngIf="setupState.currentStep === ProfileSetupStep.PHONE">
      <div class="profile-setup-flow__step-card">
        <h2 class="profile-setup-flow__step-title">Phone Number</h2>
        <p class="profile-setup-flow__step-description">Enter your phone number with country code (e.g., +1 for US).</p>
        
        <form [formGroup]="phoneForm" class="profile-setup-flow__form">
          <div class="profile-setup-flow__input-group">
            <label for="setup-phoneNumber" class="profile-setup-flow__label">
              Phone Number <span class="profile-setup-flow__required">*</span>
            </label>
            <input 
              type="tel" 
              id="setup-phoneNumber" 
              formControlName="phoneNumber" 
              class="profile-setup-flow__input"
              [ngClass]="{'profile-setup-flow__input--error': phoneForm.get('phoneNumber')?.invalid && phoneForm.get('phoneNumber')?.touched}"
              placeholder="+12025550123"
              autocomplete="tel">
            <div *ngIf="phoneForm.get('phoneNumber')?.invalid && phoneForm.get('phoneNumber')?.touched" 
                 class="profile-setup-flow__error">
              <span *ngIf="phoneForm.get('phoneNumber')?.errors?.['required']">Phone number is required</span>
              <span *ngIf="phoneForm.get('phoneNumber')?.errors?.['pattern']">Please enter a valid phone number in international format (e.g., +12025550123)</span>
            </div>
            <div class="profile-setup-flow__hint">
              Enter your phone number in E.164 format starting with + and country code
            </div>
          </div>
        </form>
        
        <div class="profile-setup-flow__actions">
          <button 
            type="button" 
            class="profile-setup-flow__button profile-setup-flow__button--secondary"
            (click)="previousStep()">
            Back
          </button>
          <button 
            type="button" 
            class="profile-setup-flow__button profile-setup-flow__button--primary"
            [disabled]="phoneForm.invalid || isLoading"
            (click)="submitPhoneStep()">
            {{ isLoading ? 'Saving...' : 'Continue' }}
          </button>
        </div>
      </div>
    </div>

    <!-- Step 3: Phone Verification -->
    <div class="profile-setup-flow__step" *ngIf="setupState.currentStep === ProfileSetupStep.PHONE_VERIFY">
      <div class="profile-setup-flow__step-card">
        <h2 class="profile-setup-flow__step-title">Verify Phone</h2>
        <p class="profile-setup-flow__step-description">
          A 6-digit verification code has been sent to {{ (currentUser$ | async)?.phoneNumber }}. Enter the code below to verify your phone number.
        </p>
        
        <!-- Verification Code Input -->
        <form [formGroup]="verifyForm" class="profile-setup-flow__form">
          <div class="profile-setup-flow__input-group">
            <label for="setup-verificationCode" class="profile-setup-flow__label">
              Verification Code <span class="profile-setup-flow__required">*</span>
            </label>
            <input 
              type="text" 
              id="setup-verificationCode" 
              formControlName="verificationCode" 
              class="profile-setup-flow__input profile-setup-flow__input--code"
              [ngClass]="{'profile-setup-flow__input--error': verifyForm.get('verificationCode')?.invalid && verifyForm.get('verificationCode')?.touched}"
              placeholder="000000"
              maxlength="6"
              inputmode="numeric"
              autocomplete="one-time-code">
            <div *ngIf="verifyForm.get('verificationCode')?.invalid && verifyForm.get('verificationCode')?.touched" 
                 class="profile-setup-flow__error">
              <span *ngIf="verifyForm.get('verificationCode')?.errors?.['required']">Verification code is required</span>
              <span *ngIf="verifyForm.get('verificationCode')?.errors?.['pattern']">Please enter a 6-digit code</span>
            </div>
            <div *ngIf="phoneVerificationState.error" class="profile-setup-flow__error">
              {{ phoneVerificationState.error }}
            </div>
          </div>
          
          <div class="profile-setup-flow__resend">
            <span class="profile-setup-flow__resend-text">Didn't receive the code?</span>
            <button 
              type="button" 
              class="profile-setup-flow__text-button"
              [disabled]="!canResendCode() || isLoading"
              (click)="sendVerificationCode()">
              Resend Code
            </button>
          </div>
        </form>
        
        <div class="profile-setup-flow__actions">
          <button 
            type="button" 
            class="profile-setup-flow__button profile-setup-flow__button--secondary"
            (click)="previousStep()">
            Back
          </button>
          <button 
            type="button" 
            class="profile-setup-flow__button profile-setup-flow__button--primary"
            [disabled]="verifyForm.invalid || isLoading"
            (click)="submitVerifyStep()">
            {{ isLoading ? 'Verifying...' : 'Verify' }}
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Debug section (matching auth-flow format) -->
  <ng-container *ngIf="debugMode$ | async">
    <div class="profile__debug">
      <h3>Profile Debug Information</h3>

      <!-- LLM-Friendly Summary Section -->
      <div class="profile__debug-section profile__debug-summary">
        <h4>Quick Debug Summary</h4>
        <p class="profile__debug-hint">Click to copy a compact summary for troubleshooting</p>
        <button 
          type="button" 
          class="profile__debug-copy-btn"
          (click)="copyDebugSummary()"
          [disabled]="debugCopyStatus === 'copying'">
          {{ debugCopyStatus === 'copied' ? 'Copied!' : debugCopyStatus === 'copying' ? 'Copying...' : 'Copy Debug Summary' }}
        </button>
      </div>

      <!-- Recent API Calls -->
      <div class="profile__debug-section">
        <h4>Recent API Calls</h4>
        <div class="profile__debug-logs">
          <ng-container *ngFor="let log of debugLogs$ | async | slice:-5">
            <div class="profile__debug-log-entry" [class.profile__debug-log-entry--error]="log.status === 'failure'">
              <span class="profile__debug-log-time">{{ log.timestamp | date:'HH:mm:ss' }}</span>
              <span class="profile__debug-log-type">{{ log.type }}</span>
              <span class="profile__debug-log-op">{{ log.operation }}</span>
              <span class="profile__debug-log-status" 
                    [class.profile__debug-log-status--success]="log.status === 'success'" 
                    [class.profile__debug-log-status--failure]="log.status === 'failure'">
                {{ log.status }}
              </span>
              <span *ngIf="log.error" class="profile__debug-log-error">{{ log.error }}</span>
            </div>
          </ng-container>
          <p *ngIf="(debugLogs$ | async)?.length === 0" class="profile__debug-empty">No API calls yet</p>
        </div>
      </div>
    
      <div class="profile__debug-section">
        <h4>Setup Flow State</h4>
        <pre>Flow Mode: {{ setupState.isFlowMode ? 'ON' : 'OFF' }}</pre>
        <pre>Current Step: {{ setupState.currentStep }}</pre>
        <pre>Start From Beginning: {{ setupState.startFromBeginning }}</pre>
        <pre>Progress: {{ getProgressPercentage() }}%</pre>
      </div>
    
      <div class="profile__debug-section">
        <h4>Phone Verification State</h4>
        <pre>Code Sent: {{ phoneVerificationState.codeSent }}</pre>
        <pre>Error: {{ phoneVerificationState.error || 'None' }}</pre>
        <pre>Can Resend: {{ canResendCode() }}</pre>
      </div>
    
      <div class="profile__debug-section">
        <h4>Current User Observable Status</h4>
        <ng-container *ngIf="currentUser$ | async as user; else noUser">
          <pre>User Data Found</pre>
          <pre>{{ user | json }}</pre>
          <pre>User Is Valid: {{ isUserValid(user) }}</pre>
          <h5>Required Attributes Check:</h5>
          <ul>
            <li>Email: {{ !!user.email }} ({{ user.email }})</li>
            <li>First Name: {{ !!user.firstName }} ({{ user.firstName }})</li>
            <li>Last Name: {{ !!user.lastName}} ({{ user.lastName }})</li>
            <li>Phone Number: {{ !!user.phoneNumber}} ({{ user.phoneNumber }})</li>
            <li>Phone Verified: {{ user.phoneVerified }}</li>
            <li>Status Is Active: {{ user.status === 'ACTIVE' }} ({{ user.status }})</li>
          </ul>
        </ng-container>
        <ng-template #noUser>
          <p class="error"><strong>No User Data Found</strong></p>
          <p>currentUser$ observable is emitting null or undefined</p>
        </ng-template>
      </div>
    
      <div class="profile__debug-section" *ngIf="setupState.isFlowMode">
        <h4>Form Debug Status</h4>
        <pre>Name Form Valid: {{ nameForm.valid }}</pre>
        <pre>Phone Form Valid: {{ phoneForm.valid }}</pre>
        <pre>Verify Form Valid: {{ verifyForm.valid }}</pre>
        <pre>Loading: {{ isLoading ? 'YES' : 'NO' }}</pre>
      </div>
    </div>
  </ng-container>
</div>
