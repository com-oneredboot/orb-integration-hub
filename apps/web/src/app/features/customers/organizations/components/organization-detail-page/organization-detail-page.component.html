<!-- Organization Detail Page Template -->
<!-- Uses NgRx store as single source of truth (store-first pattern) -->
<!-- @see .kiro/specs/organization-applications-tab/design.md -->

<ng-container *ngIf="{
  isLoading: isLoading$ | async,
  isSaving: isSaving$ | async,
  isDeleting: isDeleting$ | async,
  saveError: saveError$ | async,
  applications: applications$ | async,
  isLoadingApplications: isLoadingApplications$ | async,
  applicationsError: applicationsError$ | async,
  applicationCount: applicationCount$ | async
} as data">
  <div class="org-detail-page">
    <!-- Page Header -->
    <div class="orb-page-header">
      <div class="orb-page-header__content">
        <div class="orb-page-header__flex-container">
          <div class="orb-page-header__logo-section">
            <img src="assets/orb-logo.jpg" alt="Orb Integration Hub Logo" class="orb-page-header__logo">
          </div>
          <div class="orb-page-header__text-section">
            <div class="orb-page-header__greeting">
              <div class="orb-page-header__icon-title">
                <fa-icon icon="building" class="orb-page-header__icon-fa"></fa-icon>
                <h1 class="orb-page-header__title">
                  {{ isDraft ? 'Complete Organization Setup' : (organization?.name || 'Organization Details') }}
                </h1>
              </div>
              <p class="orb-page-header__subtitle" *ngIf="isDraft" class="orb-page-header__subtitle--warning">
                Your organization was created but needs to be completed. Fill in the details below and click "Activate Organization" to finish setup.
              </p>
              <p class="orb-page-header__subtitle" *ngIf="!isDraft && !data.isLoading && !loadError">
                Manage your organization's information and applications.
              </p>
              <div class="orb-page-header__status" *ngIf="organization && !isDraft">
                <app-status-badge
                  [status]="organization.status"
                  type="organization"
                  [showIcon]="true"
                  [showLabel]="true"
                  size="medium"
                  variant="chip">
                </app-status-badge>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Back Link -->
    <div class="org-detail-page__content">
      <div class="org-detail-page__breadcrumb">
        <a routerLink="/customers/organizations" class="org-detail-page__back-link">
          <fa-icon icon="arrow-left"></fa-icon>
          Back to Organizations
        </a>
      </div>

      <!-- Loading State -->
      <div class="org-detail-page__loading" *ngIf="data.isLoading">
        <fa-icon icon="spinner" animation="spin" size="2x"></fa-icon>
        <p>Loading organization...</p>
      </div>

      <!-- Error State -->
      <div class="org-detail-page__error" *ngIf="loadError && !data.isLoading">
        <fa-icon icon="exclamation-triangle" size="2x"></fa-icon>
        <p>{{ loadError }}</p>
        <button class="orb-btn orb-btn--secondary" routerLink="/customers/organizations">
          Back to Organizations
        </button>
      </div>

      <!-- Main Content with Tabs -->
      <div class="org-detail-page__main" *ngIf="organization && !data.isLoading && !loadError">
        
        <!-- Tabs Navigation -->
        <div class="org-detail-page__tabs">
          <button class="org-detail-page__tab"
                  [class.org-detail-page__tab--active]="activeTab === 'overview'"
                  (click)="setActiveTab('overview')">
            <fa-icon icon="info-circle" class="org-detail-page__tab-icon"></fa-icon>
            Overview
          </button>
          <button class="org-detail-page__tab"
                  [class.org-detail-page__tab--active]="activeTab === 'security'"
                  (click)="setActiveTab('security')">
            <fa-icon icon="shield-alt" class="org-detail-page__tab-icon"></fa-icon>
            Security
          </button>
          <button class="org-detail-page__tab"
                  [class.org-detail-page__tab--active]="activeTab === 'stats'"
                  (click)="setActiveTab('stats')">
            <fa-icon icon="chart-bar" class="org-detail-page__tab-icon"></fa-icon>
            Stats
          </button>
          <button class="org-detail-page__tab"
                  [class.org-detail-page__tab--active]="activeTab === 'applications'"
                  (click)="setActiveTab('applications')">
            <fa-icon icon="rocket" class="org-detail-page__tab-icon"></fa-icon>
            Applications
            <span class="org-detail-page__tab-badge" *ngIf="data.applicationCount">
              {{ data.applicationCount }}
            </span>
          </button>
          <button class="org-detail-page__tab org-detail-page__tab--danger"
                  [class.org-detail-page__tab--active]="activeTab === 'danger'"
                  (click)="setActiveTab('danger')">
            <fa-icon icon="exclamation-triangle" class="org-detail-page__tab-icon"></fa-icon>
            Danger Zone
          </button>
        </div>

        <!-- Tab Content -->
        <div class="org-detail-page__tab-content">
          
          <!-- Overview Tab -->
          <div class="org-detail-page__tab-panel" *ngIf="activeTab === 'overview'">
            <div class="orb-card">
              <div class="orb-card__header">
                <h2 class="orb-card__title">
                  <fa-icon icon="info-circle" class="orb-card__icon"></fa-icon>
                  Organization Information
                </h2>
              </div>
              <div class="orb-card__content orb-card__content--padded">
                <!-- Name Field -->
                <div class="org-detail-page__field">
                  <label class="org-detail-page__field-label" for="org-name">
                    Organization Name <span class="org-detail-page__field-required">*</span>
                  </label>
                  <input
                    type="text"
                    id="org-name"
                    class="org-detail-page__field-input"
                    [class.org-detail-page__field-input--error]="validationErrors.name"
                    [(ngModel)]="editForm.name"
                    placeholder="Enter organization name"
                    maxlength="100"
                    [attr.aria-invalid]="validationErrors.name ? 'true' : 'false'"
                    [attr.aria-describedby]="validationErrors.name ? 'name-error' : null">
                  <div class="org-detail-page__field-error" id="name-error" *ngIf="validationErrors.name">
                    {{ validationErrors.name }}
                  </div>
                  <div class="org-detail-page__field-hint">
                    {{ editForm.name.length }}/100 characters
                  </div>
                </div>

                <!-- Description Field -->
                <div class="org-detail-page__field">
                  <label class="org-detail-page__field-label" for="org-description">
                    Description
                  </label>
                  <textarea
                    id="org-description"
                    class="org-detail-page__field-textarea"
                    [class.org-detail-page__field-textarea--error]="validationErrors.description"
                    [(ngModel)]="editForm.description"
                    placeholder="Enter a brief description of your organization"
                    maxlength="500"
                    rows="4"
                    [attr.aria-invalid]="validationErrors.description ? 'true' : 'false'"
                    [attr.aria-describedby]="validationErrors.description ? 'desc-error' : null">
                  </textarea>
                  <div class="org-detail-page__field-error" id="desc-error" *ngIf="validationErrors.description">
                    {{ validationErrors.description }}
                  </div>
                  <div class="org-detail-page__field-hint">
                    {{ editForm.description.length }}/500 characters
                  </div>
                </div>

                <!-- Metadata (read-only, shown for existing orgs) -->
                <div class="org-detail-page__metadata" *ngIf="!isDraft">
                  <div class="org-detail-page__metadata-item">
                    <span class="org-detail-page__metadata-label">Organization ID</span>
                    <span class="org-detail-page__metadata-value org-detail-page__metadata-value--code">{{ organization.organizationId }}</span>
                  </div>
                  <div class="org-detail-page__metadata-item">
                    <span class="org-detail-page__metadata-label">Created</span>
                    <span class="org-detail-page__metadata-value">{{ formatDate(organization.createdAt) }}</span>
                  </div>
                  <div class="org-detail-page__metadata-item">
                    <span class="org-detail-page__metadata-label">Last Updated</span>
                    <span class="org-detail-page__metadata-value">{{ formatDate(organization.updatedAt) }}</span>
                  </div>
                </div>

                <!-- Save Error -->
                <div class="org-detail-page__save-error" *ngIf="data.saveError">
                  <fa-icon icon="exclamation-circle"></fa-icon>
                  {{ data.saveError }}
                </div>
              </div>

              <!-- Actions Footer -->
              <div class="org-detail-page__actions">
                <div class="org-detail-page__actions-right">
                  <button
                    class="orb-btn orb-btn--secondary"
                    (click)="onCancel()"
                    [disabled]="data.isSaving || data.isDeleting">
                    Cancel
                  </button>
                  <button
                    class="orb-btn orb-btn--primary"
                    (click)="onSave()"
                    [disabled]="data.isSaving || data.isDeleting">
                    <fa-icon icon="spinner" animation="spin" *ngIf="data.isSaving"></fa-icon>
                    <fa-icon icon="save" *ngIf="!data.isSaving"></fa-icon>
                    {{ isDraft ? 'Activate Organization' : 'Save Changes' }}
                  </button>
                </div>
              </div>
            </div>
          </div>

          <!-- Security Tab -->
          <div class="org-detail-page__tab-panel" *ngIf="activeTab === 'security'">
            <div class="orb-card">
              <div class="orb-card__header">
                <h2 class="orb-card__title">
                  <fa-icon icon="shield-alt" class="orb-card__icon"></fa-icon>
                  Security Settings
                </h2>
              </div>
              <div class="orb-card__content orb-card__content--padded">
                <div class="org-detail-page__info-grid">
                  <div class="org-detail-page__info-item">
                    <span class="org-detail-page__info-label">Encryption Key ID</span>
                    <div class="org-detail-page__info-value org-detail-page__info-value--code">
                      {{ organization.kmsKeyId || 'Not configured' }}
                    </div>
                  </div>
                  <div class="org-detail-page__info-item">
                    <span class="org-detail-page__info-label">Key Alias</span>
                    <div class="org-detail-page__info-value org-detail-page__info-value--code">
                      {{ organization.kmsAlias || 'Not configured' }}
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Stats Tab -->
          <div class="org-detail-page__tab-panel" *ngIf="activeTab === 'stats'">
            <div class="orb-card">
              <div class="orb-card__header">
                <h2 class="orb-card__title">
                  <fa-icon icon="chart-bar" class="orb-card__icon"></fa-icon>
                  Organization Statistics
                </h2>
              </div>
              <div class="orb-card__content orb-card__content--padded">
                <div class="org-detail-page__stats-grid">
                  <div class="org-detail-page__stat-card">
                    <div class="org-detail-page__stat-icon">
                      <fa-icon icon="users"></fa-icon>
                    </div>
                    <div class="org-detail-page__stat-content">
                      <span class="org-detail-page__stat-value">1</span>
                      <span class="org-detail-page__stat-label">Members</span>
                    </div>
                  </div>
                  <div class="org-detail-page__stat-card">
                    <div class="org-detail-page__stat-icon">
                      <fa-icon icon="rocket"></fa-icon>
                    </div>
                    <div class="org-detail-page__stat-content">
                      <span class="org-detail-page__stat-value">{{ data.applicationCount || 0 }}</span>
                      <span class="org-detail-page__stat-label">Applications</span>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Applications Tab -->
          <div class="org-detail-page__tab-panel" *ngIf="activeTab === 'applications'">
            <div class="orb-card">
              <div class="orb-card__header">
                <h2 class="orb-card__title">
                  <fa-icon icon="rocket" class="orb-card__icon"></fa-icon>
                  Applications
                </h2>
                <button
                  class="orb-card-btn"
                  (click)="onCreateApplication()"
                  aria-label="Create new application for this organization">
                  <fa-icon icon="plus" class="orb-card-btn__icon"></fa-icon>
                  Create Application
                </button>
              </div>
              <div class="orb-card__content">
                <!-- Loading State -->
                <div class="org-detail-page__apps-loading" *ngIf="data.isLoadingApplications">
                  <fa-icon icon="spinner" animation="spin"></fa-icon>
                  <span>Loading applications...</span>
                </div>

                <!-- Error State -->
                <div class="org-detail-page__apps-error" *ngIf="data.applicationsError && !data.isLoadingApplications">
                  <fa-icon icon="exclamation-triangle"></fa-icon>
                  <span>{{ data.applicationsError }}</span>
                  <button class="orb-btn orb-btn--secondary orb-btn--sm" (click)="loadApplications()">
                    Retry
                  </button>
                </div>

                <!-- Empty State -->
                <div class="org-detail-page__apps-empty" *ngIf="!data.isLoadingApplications && !data.applicationsError && data.applications && data.applications.length === 0">
                  <fa-icon icon="rocket" size="2x"></fa-icon>
                  <p class="org-detail-page__apps-empty-text">No applications yet</p>
                  <p class="org-detail-page__apps-empty-hint">Create your first application to get started.</p>
                </div>

                <!-- Applications List -->
                <div class="org-detail-page__apps-list" *ngIf="!data.isLoadingApplications && !data.applicationsError && data.applications && data.applications.length > 0">
                  <div
                    class="org-detail-page__app-row"
                    *ngFor="let app of data.applications"
                    (click)="onApplicationClick(app)"
                    (keydown.enter)="onApplicationClick(app)"
                    tabindex="0"
                    role="button"
                    [attr.aria-label]="'View application ' + app.name">
                    <div class="org-detail-page__app-info">
                      <span class="org-detail-page__app-name">{{ app.name }}</span>
                      <span class="org-detail-page__app-id">{{ app.applicationId }}</span>
                    </div>
                    <div class="org-detail-page__app-meta">
                      <app-status-badge
                        [status]="app.status"
                        type="application"
                        [showIcon]="true"
                        [showLabel]="true"
                        size="small"
                        variant="chip">
                      </app-status-badge>
                      <span class="org-detail-page__app-env-count">
                        <fa-icon icon="server"></fa-icon>
                        {{ getEnvironmentCount(app) }} env{{ getEnvironmentCount(app) !== 1 ? 's' : '' }}
                      </span>
                    </div>
                    <fa-icon icon="chevron-right" class="org-detail-page__app-arrow"></fa-icon>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Danger Zone Tab -->
          <div class="org-detail-page__tab-panel" *ngIf="activeTab === 'danger'">
            <div class="orb-card orb-card--danger">
              <div class="orb-card__header">
                <h2 class="orb-card__title orb-card__title--danger">
                  <fa-icon icon="exclamation-triangle" class="orb-card__icon"></fa-icon>
                  Danger Zone
                </h2>
              </div>
              <div class="orb-card__content orb-card__content--padded">
                <p class="org-detail-page__danger-warning">
                  These actions are permanent and cannot be undone. Please proceed with caution.
                </p>
                
                <div class="org-detail-page__danger-actions">
                  <div class="org-detail-page__danger-action">
                    <div class="org-detail-page__danger-action-info">
                      <h4 class="org-detail-page__danger-action-title">Delete Organization</h4>
                      <p class="org-detail-page__danger-action-desc">
                        Permanently delete this organization and all associated data. This action cannot be undone.
                      </p>
                    </div>
                    <button
                      class="orb-btn orb-btn--danger"
                      (click)="onDelete()"
                      [disabled]="data.isSaving || data.isDeleting">
                      <fa-icon icon="spinner" animation="spin" *ngIf="data.isDeleting"></fa-icon>
                      <fa-icon icon="trash" *ngIf="!data.isDeleting"></fa-icon>
                      Delete Organization
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>

        </div>
      </div>
    </div>

    <!-- Debug Panel -->
    <app-debug-panel
      [visible]="(debugMode$ | async) || false"
      [title]="'Organization Detail Debug'"
      [logs$]="debugLogs$"
      [context]="debugContext">
    </app-debug-panel>
  </div>
</ng-container>
