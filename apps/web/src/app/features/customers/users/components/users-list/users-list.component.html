<!-- Users List Component Template -->

<app-user-page
  [heroTitle]="'Users'"
  [heroSubtitle]="'View users assigned to applications'"
  [breadcrumbItems]="breadcrumbItems"
  [tabs]="tabs"
  [activeTabId]="activeTab"
  (tabChange)="onTabChange($event)">

  <!-- Page Content -->
  <div class="orb-card">
    <!-- Header -->
    <div class="orb-card__header">
      <h2 class="orb-card__title">
        <fa-icon icon="users" class="orb-card__icon"></fa-icon>
        Application Users
      </h2>
      <div class="orb-card__header-actions">
        <button class="orb-card-btn" (click)="onRefresh()">
          <fa-icon icon="refresh" class="orb-card-btn__icon"></fa-icon>
          Refresh
        </button>
      </div>
    </div>

    <!-- Error Display -->
    <div class="orb-card__content" *ngIf="error$ | async as error">
      <div class="orb-error-message">
        <fa-icon icon="exclamation-triangle" class="orb-error-message__icon"></fa-icon>
        <div class="orb-error-message__content">
          <h3 class="orb-error-message__title">Unable to load users</h3>
          <p class="orb-error-message__text">{{ error }}</p>
          <button class="orb-btn orb-btn--primary" (click)="onRetry()">
            <fa-icon icon="refresh" class="orb-btn__icon"></fa-icon>
            Retry
          </button>
        </div>
      </div>
    </div>

    <!-- Data Grid -->
    <div class="orb-card__content" *ngIf="!(error$ | async)">
      <app-data-grid
        [columns]="columns"
        [data]="(filteredUserRows$ | async) || []"
        [pageState]="pageState"
        [sortState]="sortState"
        [filterState]="filterState"
        [loading]="(isLoading$ | async) || false"
        [showFilters]="true"
        [showPagination]="true"
        [showReset]="true"
        [selectable]="false"
        trackByField="user"
        emptyMessage="No users found"
        (pageChange)="onPageChange($event)"
        (sortChange)="onSortChange($event)"
        (filterChange)="onFilterChange($event)"
        (resetGrid)="onResetGrid()"
        (rowClick)="onRowClick($event)">
      </app-data-grid>

      <!-- Load More Button -->
      <div class="orb-card__footer" *ngIf="hasMore$ | async">
        <button 
          class="orb-btn orb-btn--secondary orb-btn--block"
          (click)="onLoadMore()"
          [disabled]="(isLoading$ | async) || false">
          <fa-icon icon="arrow-down" class="orb-btn__icon"></fa-icon>
          Load More Users
        </button>
      </div>
    </div>
  </div>

</app-user-page>

<!-- Custom Cell Templates -->

<!-- User Info Cell -->
<ng-template #userInfoCell let-row>
  <div class="orb-info">
    <div class="orb-info__name">{{ row.user.firstName }} {{ row.user.lastName }}</div>
    <div class="orb-info__id">{{ row.user.userId }}</div>
  </div>
</ng-template>

<!-- Status Cell -->
<ng-template #statusCell let-row>
  <app-status-badge 
    [status]="row.userStatus" 
    type="user"
    [showIcon]="true"
    [showLabel]="true"
    size="small"
    variant="chip">
  </app-status-badge>
</ng-template>

<!-- Role Count Cell -->
<ng-template #roleCountCell let-row>
  <div class="orb-count">
    <fa-icon icon="user-shield" class="orb-count__icon"></fa-icon>
    {{ row.roleCount }}
  </div>
</ng-template>

<!-- Environments Cell -->
<ng-template #environmentsCell let-row>
  <div class="orb-tags">
    <span class="orb-tag orb-tag--small" *ngFor="let env of row.environments">
      {{ env }}
    </span>
  </div>
</ng-template>

<!-- Organizations Cell -->
<ng-template #organizationsCell let-row>
  <div class="orb-info">
    <div class="orb-info__name" *ngIf="row.organizationNames.length === 1">
      {{ row.organizationNames[0] }}
    </div>
    <div class="orb-info__name" *ngIf="row.organizationNames.length > 1">
      {{ row.organizationNames[0] }} +{{ row.organizationNames.length - 1 }}
    </div>
  </div>
</ng-template>

<!-- Applications Cell -->
<ng-template #applicationsCell let-row>
  <div class="orb-info">
    <div class="orb-info__name" *ngIf="row.applicationNames.length === 1">
      {{ row.applicationNames[0] }}
    </div>
    <div class="orb-info__name" *ngIf="row.applicationNames.length > 1">
      {{ row.applicationNames[0] }} +{{ row.applicationNames.length - 1 }}
    </div>
  </div>
</ng-template>

<!-- Last Activity Cell -->
<ng-template #lastActivityCell let-row>
  <span class="orb-info__id">{{ row.lastActivity }}</span>
</ng-template>

<!-- Expanded Row Cell - Shows role assignments -->
<ng-template #expandedRowCell let-row>
  <div class="orb-expanded-row" *ngIf="isRowExpanded(row.user.userId)">
    <h4 class="orb-expanded-row__title">Role Assignments</h4>
    <div class="orb-expanded-row__content">
      <table class="orb-table orb-table--compact">
        <thead>
          <tr>
            <th>Organization</th>
            <th>Application</th>
            <th>Environment</th>
            <th>Role</th>
            <th>Status</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let role of row.roleAssignments">
            <td>{{ role.organizationName }}</td>
            <td>{{ role.applicationName }}</td>
            <td>
              <span class="orb-tag orb-tag--small">{{ role.environment }}</span>
            </td>
            <td>{{ role.roleName }}</td>
            <td>
              <span class="orb-tag orb-tag--small orb-tag--{{ role.status.toLowerCase() }}">
                {{ role.status }}
              </span>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
</ng-template>
