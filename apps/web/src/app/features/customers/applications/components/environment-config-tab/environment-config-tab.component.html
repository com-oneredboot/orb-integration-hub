<!-- Environment Config Tab Component Template -->
<div class="environment-config-tab">
  <!-- Environment Selector -->
  <div class="environment-selector">
    <h3>Environment Configuration</h3>
    <div class="environment-tabs">
      @for (env of environments; track env) {
        <button
          class="env-tab"
          [class.active]="selectedEnvironment === env"
          (click)="selectEnvironment(env)"
        >
          {{ getEnvironmentLabel(env) }}
        </button>
      }
    </div>
  </div>

  <!-- Loading State -->
  @if (isLoading$ | async) {
    <div class="loading-state">
      <div class="spinner"></div>
      <p>Loading configuration...</p>
    </div>
  }

  <!-- Error State -->
  @if (loadError$ | async; as error) {
    <div class="error-state">
      <p class="error-message">{{ error }}</p>
      <button class="btn btn-secondary" (click)="clearErrors()">Dismiss</button>
    </div>
  }

  <!-- Config Content -->
  @if (selectedConfig && !(isLoading$ | async)) {
    <div class="config-content">
      <!-- Save Error -->
      @if (saveError$ | async; as error) {
        <div class="save-error">
          <p>{{ error }}</p>
          <button class="btn-dismiss" (click)="clearErrors()">Ã—</button>
        </div>
      }

      <!-- Allowed Origins Section -->
      <section class="config-section">
        <h4>Allowed Origins (CORS)</h4>
        <p class="section-description">
          Configure which domains can make requests using publishable API keys.
        </p>

        <div class="origins-list">
          @for (origin of selectedConfig.allowedOrigins || []; track origin) {
            <div class="origin-item">
              <span class="origin-url">{{ origin }}</span>
              <button
                class="btn-remove"
                (click)="removeOrigin(origin)"
                [disabled]="isSaving$ | async"
              >
                Remove
              </button>
            </div>
          } @empty {
            <p class="empty-state">No allowed origins configured.</p>
          }
        </div>

        <div class="add-origin-form">
          <input
            type="text"
            [(ngModel)]="newOrigin"
            placeholder="https://example.com or https://*.example.com"
            class="origin-input"
          />
          <button
            class="btn btn-primary"
            (click)="addOrigin()"
            [disabled]="!newOrigin.trim() || (isSaving$ | async)"
          >
            Add Origin
          </button>
        </div>
      </section>

      <!-- Rate Limits Section -->
      <section class="config-section">
        <h4>Rate Limits</h4>
        <p class="section-description">
          Configure API request limits for this environment.
        </p>

        <div class="rate-limits-form">
          <div class="form-group">
            <label for="rateLimitPerMinute">Requests per minute</label>
            <input
              type="number"
              id="rateLimitPerMinute"
              [(ngModel)]="rateLimitForm.perMinute"
              min="1"
              max="10000"
              class="rate-input"
            />
          </div>
          <div class="form-group">
            <label for="rateLimitPerDay">Requests per day</label>
            <input
              type="number"
              id="rateLimitPerDay"
              [(ngModel)]="rateLimitForm.perDay"
              min="1"
              max="1000000"
              class="rate-input"
            />
          </div>
          <button
            class="btn btn-primary"
            (click)="saveRateLimits()"
            [disabled]="isSaving$ | async"
          >
            Save Rate Limits
          </button>
        </div>
      </section>

      <!-- Webhook Configuration Section -->
      <section class="config-section">
        <h4>Webhook Configuration</h4>
        <p class="section-description">
          Configure webhook delivery for real-time event notifications.
        </p>

        <div class="webhook-form">
          <div class="form-group">
            <label for="webhookUrl">Webhook URL</label>
            <input
              type="url"
              id="webhookUrl"
              [(ngModel)]="webhookForm.url"
              placeholder="https://your-server.com/webhook"
              class="webhook-input"
            />
          </div>

          <div class="form-group checkbox-group">
            <label>
              <input
                type="checkbox"
                [(ngModel)]="webhookForm.enabled"
              />
              Enable webhook delivery
            </label>
          </div>

          <div class="form-group">
            <label>Webhook Events</label>
            <div class="events-grid">
              @for (event of webhookEventTypes; track event.value) {
                <label class="event-checkbox">
                  <input
                    type="checkbox"
                    [checked]="isWebhookEventSelected(event.value)"
                    (change)="toggleWebhookEvent(event.value)"
                  />
                  {{ event.label }}
                </label>
              }
            </div>
          </div>

          <div class="retry-settings">
            <div class="form-group">
              <label for="maxRetries">Max Retries</label>
              <input
                type="number"
                id="maxRetries"
                [(ngModel)]="webhookForm.maxRetries"
                min="0"
                max="10"
                class="retry-input"
              />
            </div>
            <div class="form-group">
              <label for="retryDelay">Retry Delay (seconds)</label>
              <input
                type="number"
                id="retryDelay"
                [(ngModel)]="webhookForm.retryDelaySeconds"
                min="10"
                max="3600"
                class="retry-input"
              />
            </div>
          </div>

          <div class="webhook-secret">
            <label>Webhook Secret</label>
            <div class="secret-display">
              <code>{{ selectedConfig.webhookSecret || 'Not generated' }}</code>
              <button
                class="btn btn-secondary"
                (click)="regenerateWebhookSecret()"
                [disabled]="isSaving$ | async"
              >
                Regenerate Secret
              </button>
            </div>
          </div>

          <button
            class="btn btn-primary"
            (click)="saveWebhookConfig()"
            [disabled]="isSaving$ | async"
          >
            Save Webhook Configuration
          </button>
        </div>
      </section>

      <!-- Feature Flags Section -->
      <section class="config-section">
        <h4>Feature Flags</h4>
        <p class="section-description">
          Configure feature flags for this environment.
        </p>

        <div class="feature-flags-list">
          @for (flag of getFeatureFlagEntries(); track flag.key) {
            <div class="flag-item">
              <div class="flag-info">
                <span class="flag-key">{{ flag.key }}</span>
                <span class="flag-type">{{ getFeatureFlagType(flag.value) }}</span>
              </div>
              <div class="flag-value">{{ formatFeatureFlagValue(flag.value) }}</div>
              <button
                class="btn-remove"
                (click)="deleteFeatureFlag(flag.key)"
                [disabled]="isSaving$ | async"
              >
                Delete
              </button>
            </div>
          } @empty {
            <p class="empty-state">No feature flags configured.</p>
          }
        </div>

        <div class="add-flag-form">
          <input
            type="text"
            [(ngModel)]="newFlagKey"
            placeholder="flag_key (snake_case)"
            class="flag-key-input"
          />
          <select [(ngModel)]="newFlagType" class="flag-type-select">
            <option value="boolean">Boolean</option>
            <option value="string">String</option>
            <option value="number">Number</option>
          </select>
          @if (newFlagType === 'boolean') {
            <select [(ngModel)]="newFlagValue" class="flag-value-input">
              <option value="true">Enabled</option>
              <option value="false">Disabled</option>
            </select>
          } @else {
            <input
              type="text"
              [(ngModel)]="newFlagValue"
              [placeholder]="newFlagType === 'number' ? '0' : 'value'"
              class="flag-value-input"
            />
          }
          <button
            class="btn btn-primary"
            (click)="addFeatureFlag()"
            [disabled]="!newFlagKey.trim() || (isSaving$ | async)"
          >
            Add Flag
          </button>
        </div>
      </section>
    </div>
  }

  <!-- No Environment Selected -->
  @if (!selectedEnvironment && environments.length > 0) {
    <div class="no-selection">
      <p>Select an environment to view and edit its configuration.</p>
    </div>
  }

  <!-- No Environments Available -->
  @if (environments.length === 0) {
    <div class="no-environments">
      <p>No environments configured for this application.</p>
      <p class="hint">Add environments in the Overview tab first.</p>
    </div>
  }
</div>
