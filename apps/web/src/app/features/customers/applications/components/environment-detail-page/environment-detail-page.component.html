<!-- Environment Detail Page Template -->
<!-- Displays all configuration for a single environment -->
<!-- @see .kiro/specs/environment-detail-page/design.md -->

<div class="env-detail-container">
  <!-- Page Header -->
  <div class="orb-page-header">
    <div class="orb-page-header__content">
      <div class="orb-page-header__flex-container">
        <div class="orb-page-header__logo-section">
          <img src="assets/orb-logo.jpg" alt="Orb Integration Hub Logo" class="orb-page-header__logo">
        </div>
        <div class="orb-page-header__text-section">
          <div class="orb-page-header__greeting">
            <div class="orb-page-header__icon-title">
              <fa-icon icon="cog" class="orb-page-header__icon-fa"></fa-icon>
              <h1 class="orb-page-header__title">
                {{ getEnvironmentLabel(environment || '') }} Configuration
              </h1>
            </div>
            <p class="orb-page-header__subtitle">
              Configure API keys, CORS origins, rate limits, webhooks, and feature flags for this environment.
            </p>
            <div class="orb-page-header__status" *ngIf="environment">
              <span class="orb-role-badge orb-role-badge--{{ (environment || '').toLowerCase() }}">
                {{ getEnvironmentLabel(environment || '') }}
              </span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Breadcrumb / Back Link -->
  <div class="env-detail-content">
    <div class="env-detail-breadcrumb">
      <a [routerLink]="['/customers/applications']" class="env-detail-breadcrumb__link">
        Applications
      </a>
      <fa-icon icon="chevron-right" class="env-detail-breadcrumb__separator"></fa-icon>
      <a [routerLink]="['/customers/applications', applicationId]" class="env-detail-breadcrumb__link">
        {{ application?.name || 'Application' }}
      </a>
      <fa-icon icon="chevron-right" class="env-detail-breadcrumb__separator"></fa-icon>
      <span class="env-detail-breadcrumb__current">{{ getEnvironmentLabel(environment || '') }}</span>
    </div>

    <div class="env-detail-back">
      <button class="orb-btn orb-btn--secondary orb-btn--sm" (click)="goBack()">
        <fa-icon icon="arrow-left"></fa-icon>
        Back to Application
      </button>
    </div>

    <!-- Loading State -->
    <div class="env-detail-loading" *ngIf="isLoading$ | async">
      <fa-icon icon="spinner" animation="spin" size="2x"></fa-icon>
      <p>Loading configuration...</p>
    </div>

    <!-- Validation Error State -->
    <div class="env-detail-error" *ngIf="validationError && (isLoading$ | async) === false">
      <fa-icon icon="exclamation-triangle" size="2x"></fa-icon>
      <p>{{ validationError }}</p>
      <button class="orb-btn orb-btn--secondary" (click)="goBack()">
        Back to Application
      </button>
    </div>

    <!-- Load Error State - only show if not auto-creating -->
    <div class="env-detail-error" *ngIf="(loadError$ | async) as error">
      <ng-container *ngIf="!isAutoCreating">
        <fa-icon icon="exclamation-triangle" size="2x"></fa-icon>
        <p>{{ error }}</p>
        <button class="orb-btn orb-btn--secondary" (click)="goBack()">
          Back to Application
        </button>
      </ng-container>
      <ng-container *ngIf="isAutoCreating">
        <fa-icon icon="spinner" animation="spin" size="2x"></fa-icon>
        <p>Setting up environment configuration...</p>
      </ng-container>
    </div>

    <!-- Main Content -->
    <div class="env-detail-sections" *ngIf="!validationError && (isLoading$ | async) === false && ((loadError$ | async) === null || selectedConfig)">
      <!-- Save Error -->
      <div class="env-detail-save-error" *ngIf="saveError$ | async as error">
        <fa-icon icon="exclamation-circle"></fa-icon>
        <span>{{ error }}</span>
        <button class="orb-btn orb-btn--secondary orb-btn--sm" (click)="clearErrors()">Dismiss</button>
      </div>

      <!-- API Keys Section -->
      <div class="orb-card">
        <div class="orb-card__header">
          <h2 class="orb-card__title">
            <fa-icon icon="key" class="orb-card__icon"></fa-icon>
            API Keys
          </h2>
        </div>
        <div class="orb-card__content orb-card__content--padded">
          <!-- Generated Key Display -->
          <div class="env-detail-generated-key" *ngIf="generatedKeyDisplay">
            <div class="env-detail-generated-key__header">
              <fa-icon icon="check-circle" class="env-detail-generated-key__icon"></fa-icon>
              <span>API Key Generated Successfully</span>
            </div>
            <div class="env-detail-generated-key__content">
              <code class="env-detail-generated-key__value">{{ generatedKeyDisplay.fullKey }}</code>
              <button
                class="orb-btn orb-btn--secondary orb-btn--sm"
                (click)="copyGeneratedKey()"
                [attr.aria-label]="copySuccess ? 'Copied!' : 'Copy API key'">
                <fa-icon [icon]="copySuccess ? 'check' : 'copy'"></fa-icon>
                {{ copySuccess ? 'Copied!' : 'Copy' }}
              </button>
            </div>
            <div class="env-detail-generated-key__warning">
              <fa-icon icon="exclamation-triangle"></fa-icon>
              <span>Copy this key now. It won't be shown again.</span>
            </div>
            <button class="orb-btn orb-btn--secondary orb-btn--sm" (click)="dismissGeneratedKey()">
              Dismiss
            </button>
          </div>

          <!-- Current Key Status -->
          <div class="env-detail-key-status" *ngIf="!generatedKeyDisplay">
            <div class="env-detail-key-status__row">
              <span class="env-detail-key-status__label">Status:</span>
              <app-status-badge
                [status]="getApiKeyStatus()"
                type="apiKey"
                [showIcon]="true"
                [showLabel]="true"
                size="medium"
                variant="chip">
              </app-status-badge>
            </div>

            <div class="env-detail-key-status__row" *ngIf="environmentApiKey">
              <span class="env-detail-key-status__label">Key Prefix:</span>
              <code class="env-detail-key-status__value">{{ getApiKeyPrefix() }}...</code>
            </div>

            <div class="env-detail-key-status__row" *ngIf="environmentApiKey">
              <span class="env-detail-key-status__label">Key Type:</span>
              <span class="orb-key-type-badge" 
                    [class.orb-key-type-badge--publishable]="getApiKeyType() === 'PUBLISHABLE'"
                    [class.orb-key-type-badge--secret]="getApiKeyType() === 'SECRET'">
                {{ getApiKeyType() === 'SECRET' ? 'Secret (sk_*)' : 'Publishable (pk_*)' }}
              </span>
            </div>

            <div class="env-detail-key-actions">
              <button
                *ngIf="canGenerateKey()"
                class="orb-btn orb-btn--primary"
                (click)="onGenerateKey()"
                [disabled]="isGeneratingKey$ | async">
                <fa-icon icon="plus" *ngIf="(isGeneratingKey$ | async) === false"></fa-icon>
                <fa-icon icon="spinner" animation="spin" *ngIf="isGeneratingKey$ | async"></fa-icon>
                Generate API Key
              </button>

              <button
                *ngIf="isApiKeyActive()"
                class="orb-btn orb-btn--secondary"
                (click)="onRotateKey()"
                [disabled]="isGeneratingKey$ | async">
                <fa-icon icon="sync"></fa-icon>
                Rotate Key
              </button>

              <button
                *ngIf="isApiKeyActive()"
                class="orb-btn orb-btn--danger"
                (click)="onRevokeKey()"
                [disabled]="isRevokingKey$ | async">
                <fa-icon icon="ban"></fa-icon>
                Revoke Key
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Allowed Origins Section -->
      <div class="orb-card">
        <div class="orb-card__header">
          <h2 class="orb-card__title">
            <fa-icon icon="globe" class="orb-card__icon"></fa-icon>
            Allowed Origins (CORS)
          </h2>
        </div>
        <div class="orb-card__content orb-card__content--padded">
          <p class="env-detail-section-desc">
            Configure which domains can make requests using publishable API keys.
          </p>

          <div class="env-detail-origins-list">
            <div class="env-detail-origin-item" *ngFor="let origin of selectedConfig?.allowedOrigins || []">
              <code class="env-detail-origin-item__url">{{ origin }}</code>
              <button
                class="orb-btn orb-btn--danger orb-btn--sm"
                (click)="removeOrigin(origin)"
                [disabled]="isSaving$ | async">
                <fa-icon icon="trash"></fa-icon>
                Remove
              </button>
            </div>
            <p class="env-detail-empty" *ngIf="!selectedConfig?.allowedOrigins?.length">
              No allowed origins configured.
            </p>
          </div>

          <div class="env-detail-add-form">
            <input
              type="text"
              [(ngModel)]="newOrigin"
              placeholder="https://example.com or https://*.example.com"
              class="env-detail-input">
            <button
              class="orb-btn orb-btn--primary"
              (click)="addOrigin()"
              [disabled]="!newOrigin.trim() || (isSaving$ | async)">
              <fa-icon icon="plus"></fa-icon>
              Add Origin
            </button>
          </div>
        </div>
      </div>

      <!-- Rate Limits Section -->
      <div class="orb-card">
        <div class="orb-card__header">
          <h2 class="orb-card__title">
            <fa-icon icon="tachometer-alt" class="orb-card__icon"></fa-icon>
            Rate Limits
          </h2>
        </div>
        <div class="orb-card__content orb-card__content--padded">
          <p class="env-detail-section-desc">
            Configure API request limits for this environment.
          </p>

          <div class="env-detail-rate-form">
            <div class="env-detail-form-group">
              <label for="rateLimitPerMinute">Requests per minute</label>
              <input
                type="number"
                id="rateLimitPerMinute"
                [(ngModel)]="rateLimitForm.perMinute"
                min="1"
                max="10000"
                class="env-detail-input env-detail-input--number">
            </div>
            <div class="env-detail-form-group">
              <label for="rateLimitPerDay">Requests per day</label>
              <input
                type="number"
                id="rateLimitPerDay"
                [(ngModel)]="rateLimitForm.perDay"
                min="1"
                max="1000000"
                class="env-detail-input env-detail-input--number">
            </div>
            <button
              class="orb-btn orb-btn--primary"
              (click)="saveRateLimits()"
              [disabled]="isSaving$ | async">
              <fa-icon icon="save" *ngIf="(isSaving$ | async) === false"></fa-icon>
              <fa-icon icon="spinner" animation="spin" *ngIf="isSaving$ | async"></fa-icon>
              Save Rate Limits
            </button>
          </div>
        </div>
      </div>

      <!-- Webhooks Section -->
      <div class="orb-card">
        <div class="orb-card__header">
          <h2 class="orb-card__title">
            <fa-icon icon="bolt" class="orb-card__icon"></fa-icon>
            Webhook Configuration
          </h2>
        </div>
        <div class="orb-card__content orb-card__content--padded">
          <p class="env-detail-section-desc">
            Configure webhook delivery for real-time event notifications.
          </p>

          <div class="env-detail-webhook-form">
            <div class="env-detail-form-group">
              <label for="webhookUrl">Webhook URL</label>
              <input
                type="url"
                id="webhookUrl"
                [(ngModel)]="webhookForm.url"
                placeholder="https://your-server.com/webhook"
                class="env-detail-input">
            </div>

            <div class="env-detail-form-group env-detail-form-group--checkbox">
              <label>
                <input type="checkbox" [(ngModel)]="webhookForm.enabled">
                Enable webhook delivery
              </label>
            </div>

            <div class="env-detail-form-group">
              <span class="env-detail-form-label" id="webhook-events-label">Webhook Events</span>
              <div class="env-detail-events-grid" role="group" aria-labelledby="webhook-events-label">
                <label class="env-detail-event-checkbox" *ngFor="let event of webhookEventTypes">
                  <input
                    type="checkbox"
                    [checked]="isWebhookEventSelected(event.value)"
                    (change)="toggleWebhookEvent(event.value)">
                  {{ event.label }}
                </label>
              </div>
            </div>

            <div class="env-detail-retry-settings">
              <div class="env-detail-form-group">
                <label for="maxRetries">Max Retries</label>
                <input
                  type="number"
                  id="maxRetries"
                  [(ngModel)]="webhookForm.maxRetries"
                  min="0"
                  max="10"
                  class="env-detail-input env-detail-input--number">
              </div>
              <div class="env-detail-form-group">
                <label for="retryDelay">Retry Delay (seconds)</label>
                <input
                  type="number"
                  id="retryDelay"
                  [(ngModel)]="webhookForm.retryDelaySeconds"
                  min="10"
                  max="3600"
                  class="env-detail-input env-detail-input--number">
              </div>
            </div>

            <div class="env-detail-webhook-secret">
              <span class="env-detail-form-label" id="webhook-secret-label">Webhook Secret</span>
              <div class="env-detail-webhook-secret__display" aria-labelledby="webhook-secret-label">
                <code>{{ selectedConfig?.webhookSecret || 'Not generated' }}</code>
                <button
                  class="orb-btn orb-btn--secondary orb-btn--sm"
                  (click)="regenerateWebhookSecret()"
                  [disabled]="isSaving$ | async">
                  <fa-icon icon="redo"></fa-icon>
                  Regenerate Secret
                </button>
              </div>
            </div>

            <button
              class="orb-btn orb-btn--primary"
              (click)="saveWebhookConfig()"
              [disabled]="isSaving$ | async">
              <fa-icon icon="save" *ngIf="(isSaving$ | async) === false"></fa-icon>
              <fa-icon icon="spinner" animation="spin" *ngIf="isSaving$ | async"></fa-icon>
              Save Webhook Configuration
            </button>
          </div>
        </div>
      </div>

      <!-- Feature Flags Section -->
      <div class="orb-card">
        <div class="orb-card__header">
          <h2 class="orb-card__title">
            <fa-icon icon="flag" class="orb-card__icon"></fa-icon>
            Feature Flags
          </h2>
        </div>
        <div class="orb-card__content orb-card__content--padded">
          <p class="env-detail-section-desc">
            Configure feature flags for this environment.
          </p>

          <div class="env-detail-flags-list">
            <div class="env-detail-flag-item" *ngFor="let flag of getFeatureFlagEntries()">
              <div class="env-detail-flag-item__info">
                <span class="env-detail-flag-item__key">{{ flag.key }}</span>
                <span class="env-detail-flag-item__type">{{ getFeatureFlagType(flag.value) }}</span>
              </div>
              <div class="env-detail-flag-item__value">{{ formatFeatureFlagValue(flag.value) }}</div>
              <button
                class="orb-btn orb-btn--danger orb-btn--sm"
                (click)="deleteFeatureFlag(flag.key)"
                [disabled]="isSaving$ | async">
                <fa-icon icon="trash"></fa-icon>
                Delete
              </button>
            </div>
            <p class="env-detail-empty" *ngIf="!getFeatureFlagEntries().length">
              No feature flags configured.
            </p>
          </div>

          <div class="env-detail-add-flag-form">
            <input
              type="text"
              [(ngModel)]="newFlagKey"
              placeholder="flag_key (snake_case)"
              class="env-detail-input">
            <select [(ngModel)]="newFlagType" class="env-detail-select">
              <option value="boolean">Boolean</option>
              <option value="string">String</option>
              <option value="number">Number</option>
            </select>
            <select *ngIf="newFlagType === 'boolean'" [(ngModel)]="newFlagValue" class="env-detail-select">
              <option value="true">Enabled</option>
              <option value="false">Disabled</option>
            </select>
            <input
              *ngIf="newFlagType !== 'boolean'"
              type="text"
              [(ngModel)]="newFlagValue"
              [placeholder]="newFlagType === 'number' ? '0' : 'value'"
              class="env-detail-input">
            <button
              class="orb-btn orb-btn--primary"
              (click)="addFeatureFlag()"
              [disabled]="!newFlagKey.trim() || (isSaving$ | async)">
              <fa-icon icon="plus"></fa-icon>
              Add Flag
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
