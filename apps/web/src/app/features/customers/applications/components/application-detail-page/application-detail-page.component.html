<!-- Application Detail Page Template -->
<!-- Uses NgRx store as single source of truth (store-first pattern) -->
<!-- Includes tabbed interface for Overview, Environments, and Danger Zone -->
<!-- @see .kiro/specs/store-centric-refactoring/design.md -->
<!-- @see .kiro/specs/application-access-management/design.md -->
<!-- @see .kiro/specs/environment-detail-page/design.md -->

<!-- Custom Cell Templates for API Keys Grid - MUST be outside *ngIf for ViewChild static: true -->
<!-- Environment Cell -->
<ng-template #environmentCell let-row>
  <span
    class="orb-role-badge orb-role-badge--{{ row.environment.toLowerCase() }}">
    {{ row.environmentLabel }}
  </span>
</ng-template>

<!-- Key Info Cell -->
<ng-template #keyInfoCell let-row>
  <!-- Newly Generated Key Display -->
  <div class="security-key-generated" *ngIf="isNewlyGeneratedKey(row)">
    <div class="security-key-generated__header">
      <fa-icon icon="check-circle" class="security-key-generated__icon"></fa-icon>
      <span>API Key Generated</span>
    </div>
    <div class="security-key-generated__key">
      <code>{{ generatedKeyDisplay?.fullKey }}</code>
      <button
        type="button"
        class="orb-btn orb-btn--secondary orb-btn--sm"
        (click)="copyGeneratedKey(); $event.stopPropagation()"
        [attr.aria-label]="copySuccess ? 'Copied!' : 'Copy API key'">
        <fa-icon [icon]="copySuccess ? 'check' : 'copy'"></fa-icon>
        {{ copySuccess ? 'Copied!' : 'Copy' }}
      </button>
    </div>
    <div class="security-key-generated__warning">
      <fa-icon icon="exclamation-triangle"></fa-icon>
      <span>Copy this key now. It won't be shown again.</span>
    </div>
  </div>

  <!-- Active Key Info -->
  <div class="orb-info orb-info--inline" *ngIf="row.hasKey && !isNewlyGeneratedKey(row)">
    <span class="orb-key-type-badge" [class.orb-key-type-badge--publishable]="row.apiKey?.keyType === 'PUBLISHABLE'" [class.orb-key-type-badge--secret]="row.apiKey?.keyType === 'SECRET'">
      {{ row.apiKey?.keyType === 'SECRET' ? 'sk' : 'pk' }}
    </span>
    <code class="orb-info__id">{{ row.apiKey?.keyPrefix }}...</code>
    <app-status-badge
      [status]="row.apiKey?.status || ''"
      type="apiKey"
      [showIcon]="true"
      [showLabel]="true"
      size="small"
      variant="chip">
    </app-status-badge>
    <button
      type="button"
      class="orb-btn orb-btn--secondary orb-btn--sm"
      (click)="$event.stopPropagation()"
      [attr.aria-label]="'Copy key prefix'">
      <fa-icon icon="copy"></fa-icon>
    </button>
    <span class="orb-key-warning" *ngIf="row.apiKey?.keyType === 'SECRET'">
      <fa-icon icon="exclamation-triangle"></fa-icon>
      Secret key - do not expose in frontend code
    </span>
  </div>

  <!-- Revoked Key State -->
  <div class="orb-info orb-info--inline" *ngIf="row.isRevoked && !isNewlyGeneratedKey(row)">
    <app-status-badge
      status="REVOKED"
      type="apiKey"
      [showIcon]="true"
      [showLabel]="true"
      size="small"
      variant="chip">
    </app-status-badge>
    <span class="orb-info__id">Key has been revoked</span>
  </div>

  <!-- Expired Key State -->
  <div class="orb-info orb-info--inline" *ngIf="row.isExpired && !isNewlyGeneratedKey(row)">
    <app-status-badge
      status="EXPIRED"
      type="apiKey"
      [showIcon]="true"
      [showLabel]="true"
      size="small"
      variant="chip">
    </app-status-badge>
    <span class="orb-info__id">Key has expired</span>
  </div>

  <!-- No Key State -->
  <div class="orb-info orb-info--muted" *ngIf="row.canGenerate && !isNewlyGeneratedKey(row)">
    <fa-icon icon="info-circle"></fa-icon>
    <span class="orb-info__id">No API key configured</span>
  </div>
</ng-template>

<!-- Actions Cell -->
<ng-template #actionsCell let-row>
  <div class="security-key-actions" *ngIf="!isNewlyGeneratedKey(row)">
    <!-- Generate Key Button (no key exists or key is revoked/expired) -->
    <button
      *ngIf="row.canGenerate && !row.hasKey"
      class="orb-btn orb-btn--primary orb-btn--sm"
      (click)="onGenerateKeyForEnvironment(row.environment); $event.stopPropagation()"
      [disabled]="(isGeneratingKey$ | async)">
      <fa-icon icon="plus"></fa-icon>
      Generate
    </button>
    <!-- Regenerate Button (key is revoked or expired) -->
    <button
      *ngIf="row.canGenerate && row.hasKey === false && (row.isRevoked || row.isExpired)"
      class="orb-btn orb-btn--primary orb-btn--sm"
      (click)="onGenerateKeyForEnvironment(row.environment); $event.stopPropagation()"
      [disabled]="(isGeneratingKey$ | async)">
      <fa-icon icon="redo"></fa-icon>
      Regenerate
    </button>
    <!-- Rotate Button (active key) -->
    <button
      *ngIf="row.canRotate"
      class="orb-btn orb-btn--secondary orb-btn--sm"
      (click)="onRotateKeyForRow(row); $event.stopPropagation()"
      [disabled]="(isGeneratingKey$ | async)">
      <fa-icon icon="sync"></fa-icon>
      Rotate
    </button>
    <!-- Revoke Button (active key) -->
    <button
      *ngIf="row.canRevoke"
      class="orb-btn orb-btn--danger orb-btn--sm"
      (click)="onRevokeKeyForRow(row); $event.stopPropagation()"
      [disabled]="(isRevokingKey$ | async)">
      <fa-icon icon="ban"></fa-icon>
      Revoke
    </button>
  </div>
  <!-- Dismiss button for newly generated key -->
  <div class="security-key-actions" *ngIf="isNewlyGeneratedKey(row)">
    <button
      type="button"
      class="orb-btn orb-btn--secondary orb-btn--sm"
      (click)="dismissGeneratedKey(); $event.stopPropagation()"
      aria-label="Dismiss">
      <fa-icon icon="times"></fa-icon>
      Dismiss
    </button>
  </div>
</ng-template>

<!-- Environments DataGrid Custom Cell Templates -->

<!-- Environment Name Cell -->
<ng-template #envNameCell let-row>
  <span class="orb-role-badge orb-role-badge--{{ row.environment.toLowerCase() }}">
    {{ row.environmentLabel }}
  </span>
</ng-template>

<!-- Environment Status Cell -->
<ng-template #envStatusCell let-row>
  <app-status-badge
    *ngIf="row.apiKeyStatus !== 'Not Configured'"
    [status]="row.apiKeyStatus"
    type="apiKey"
    [showIcon]="true"
    [showLabel]="true"
    size="small"
    variant="chip">
  </app-status-badge>
  <span class="orb-info__id orb-info__id--muted" *ngIf="row.apiKeyStatus === 'Not Configured'">—</span>
</ng-template>

<!-- Environment API Key Cell -->
<ng-template #envApiKeyCell let-row>
  <code class="orb-info__id" *ngIf="row.apiKeyStatus !== 'Not Configured'">{{ row.formattedKeyPrefix }}</code>
  <span class="orb-info__id orb-info__id--muted" *ngIf="row.apiKeyStatus === 'Not Configured'">—</span>
</ng-template>

<!-- Environment Rate Limit Cell -->
<ng-template #envRateLimitCell let-row>
  <span class="orb-info__id" *ngIf="row.rateLimitDisplay !== 'Not configured'">{{ row.rateLimitDisplay }}</span>
  <span class="orb-info__id orb-info__id--muted" *ngIf="row.rateLimitDisplay === 'Not configured'">—</span>
</ng-template>

<!-- Environment Webhook Cell -->
<ng-template #envWebhookCell let-row>
  <span class="orb-info__id" *ngIf="row.webhookStatus === 'Enabled'">Enabled</span>
  <span class="orb-info__id" *ngIf="row.webhookStatus === 'Disabled'">Disabled</span>
  <span class="orb-info__id orb-info__id--muted" *ngIf="row.webhookStatus === 'Not Configured'">—</span>
</ng-template>

<!-- Environment Last Updated Cell -->
<ng-template #envLastUpdatedCell let-row>
  <span class="orb-info__id">{{ row.lastUpdated }}</span>
</ng-template>

<ng-container *ngIf="{
  isLoading: isLoading$ | async,
  isSaving: isSaving$ | async,
  saveError: saveError$ | async,
  organizations: organizations$ | async
} as data">
  <app-user-page
    [heroTitle]="heroTitle"
    [heroSubtitle]="heroSubtitle"
    [breadcrumbItems]="breadcrumbItems"
    [tabs]="tabs"
    [activeTabId]="activeTab"
    (tabChange)="onTabChange($event)">

    <!-- Loading State -->
    <div class="app-detail-loading" *ngIf="data.isLoading">
      <fa-icon icon="spinner" animation="spin" size="2x"></fa-icon>
      <p>Loading application...</p>
    </div>

    <!-- Error State -->
    <div class="app-detail-error" *ngIf="loadError && !data.isLoading">
      <fa-icon icon="exclamation-triangle" size="2x"></fa-icon>
      <p>{{ loadError }}</p>
      <button class="orb-btn orb-btn--secondary" routerLink="/customers/applications">
        Back to Applications
      </button>
    </div>

    <!-- Tab Panels -->
    <div class="app-detail-tab-panels" *ngIf="application && !data.isLoading && !loadError">
          <!-- Overview Tab Panel -->
          <div
            class="app-detail-tab-panel"
            *ngIf="activeTab === 'overview' || isDraft"
            role="tabpanel"
            id="panel-overview"
            [attr.aria-labelledby]="'tab-overview'">
            <!-- Form Card using global orb-card styles -->
            <div class="orb-card">
              <div class="orb-card__header">
                <h2 class="orb-card__title">
                  <fa-icon icon="info-circle" class="orb-card__icon"></fa-icon>
                  Application Information
                </h2>
              </div>
              <div class="orb-card__content orb-card__content--padded">
                <!-- Organization Field -->
                <div class="app-detail-field">
                  <label class="app-detail-field__label" for="app-organization">
                    Organization <span class="app-detail-field__required">*</span>
                  </label>
                  <div *ngIf="!data.organizations || data.organizations.length === 0" class="app-detail-field__no-orgs">
                    <fa-icon icon="exclamation-circle"></fa-icon>
                    <span>No organizations available. <a routerLink="/customers/organizations">Create one first</a>.</span>
                  </div>
                  <select
                    *ngIf="data.organizations && data.organizations.length > 0"
                    id="app-organization"
                    class="app-detail-field__select"
                    [class.app-detail-field__select--error]="validationErrors.organizationId"
                    [(ngModel)]="editForm.organizationId"
                    [attr.aria-invalid]="validationErrors.organizationId ? 'true' : 'false'"
                    [attr.aria-describedby]="validationErrors.organizationId ? 'org-error' : null">
                    <option value="" disabled>Select an organization</option>
                    <option *ngFor="let org of data.organizations" [value]="org.organizationId">
                      {{ org.name }}
                    </option>
                  </select>
                  <div class="app-detail-field__error" id="org-error" *ngIf="validationErrors.organizationId">
                    {{ validationErrors.organizationId }}
                  </div>
                </div>

                <!-- Name Field -->
                <div class="app-detail-field">
                  <label class="app-detail-field__label" for="app-name">
                    Application Name <span class="app-detail-field__required">*</span>
                  </label>
                  <input
                    type="text"
                    id="app-name"
                    class="app-detail-field__input"
                    [class.app-detail-field__input--error]="validationErrors.name"
                    [(ngModel)]="editForm.name"
                    placeholder="Enter application name"
                    maxlength="100"
                    [attr.aria-invalid]="validationErrors.name ? 'true' : 'false'"
                    [attr.aria-describedby]="validationErrors.name ? 'name-error' : null">
                  <div class="app-detail-field__error" id="name-error" *ngIf="validationErrors.name">
                    {{ validationErrors.name }}
                  </div>
                  <div class="app-detail-field__hint">
                    {{ editForm.name.length }}/100 characters
                  </div>
                </div>

                <!-- Description Field -->
                <div class="app-detail-field">
                  <label class="app-detail-field__label" for="app-description">
                    Description
                  </label>
                  <textarea
                    id="app-description"
                    class="app-detail-field__textarea"
                    [class.app-detail-field__textarea--error]="validationErrors.description"
                    [(ngModel)]="editForm.description"
                    placeholder="Enter a brief description of your application"
                    maxlength="500"
                    rows="4"
                    [attr.aria-invalid]="validationErrors.description ? 'true' : 'false'"
                    [attr.aria-describedby]="validationErrors.description ? 'desc-error' : null">
                  </textarea>
                  <div class="app-detail-field__error" id="desc-error" *ngIf="validationErrors.description">
                    {{ validationErrors.description }}
                  </div>
                  <div class="app-detail-field__hint">
                    {{ editForm.description.length }}/500 characters
                  </div>
                </div>

                <!-- Environments Field -->
                <div class="app-detail-field">
                  <span class="app-detail-field__label" id="environments-label">
                    Environments <span class="app-detail-field__required">*</span>
                  </span>
                  <p class="app-detail-field__description">
                    Select the deployment environments for this application.
                  </p>
                  <div class="app-detail-environments"
                       role="group"
                       aria-labelledby="environments-label"
                       [attr.aria-describedby]="validationErrors.environments ? 'env-error' : null">
                    <label
                      *ngFor="let env of availableEnvironments"
                      class="app-detail-environments__item"
                      [class.app-detail-environments__item--selected]="isEnvironmentSelected(env.value)">
                      <input
                        type="checkbox"
                        class="app-detail-environments__checkbox"
                        [checked]="isEnvironmentSelected(env.value)"
                        (change)="onEnvironmentToggle(env.value)"
                        [attr.aria-label]="env.label + ': ' + env.description">
                      <span class="app-detail-environments__content">
                        <span class="app-detail-environments__label">{{ env.label }}</span>
                        <span class="app-detail-environments__description">{{ env.description }}</span>
                      </span>
                    </label>
                  </div>
                  <div class="app-detail-field__error" id="env-error" *ngIf="validationErrors.environments">
                    {{ validationErrors.environments }}
                  </div>
                </div>

                <!-- Metadata (read-only, shown for existing apps) -->
                <div class="app-detail-metadata" *ngIf="!isDraft">
                  <div class="app-detail-metadata__item">
                    <span class="app-detail-metadata__label">Application ID</span>
                    <span class="app-detail-metadata__value">{{ application.applicationId }}</span>
                  </div>
                  <div class="app-detail-metadata__item">
                    <span class="app-detail-metadata__label">Created</span>
                    <span class="app-detail-metadata__value">{{ formatDate(application.createdAt) }}</span>
                  </div>
                  <div class="app-detail-metadata__item">
                    <span class="app-detail-metadata__label">Last Updated</span>
                    <span class="app-detail-metadata__value">{{ formatDate(application.updatedAt) }}</span>
                  </div>
                </div>

                <!-- Save Error -->
                <div class="app-detail-save-error" *ngIf="data.saveError">
                  <fa-icon icon="exclamation-circle"></fa-icon>
                  {{ data.saveError }}
                </div>
              </div>

              <!-- Actions Footer -->
              <div class="app-detail-actions">
                <div class="app-detail-actions__right">
                  <button
                    class="orb-btn orb-btn--secondary"
                    (click)="onCancel()"
                    [disabled]="data.isSaving">
                    Cancel
                  </button>
                  <button
                    class="orb-btn orb-btn--primary"
                    (click)="onSave()"
                    [disabled]="data.isSaving || !data.organizations || data.organizations.length === 0">
                    <fa-icon icon="spinner" animation="spin" *ngIf="data.isSaving"></fa-icon>
                    <fa-icon icon="save" *ngIf="!data.isSaving"></fa-icon>
                    {{ isDraft ? 'Activate Application' : 'Save Changes' }}
                  </button>
                </div>
              </div>
            </div>
          </div>

          <!-- Environments Tab Panel -->
          <div
            class="app-detail-tab-panel"
            *ngIf="activeTab === 'environments' && !isDraft"
            role="tabpanel"
            id="panel-environments"
            [attr.aria-labelledby]="'tab-environments'">
            <app-environments-list
              [applicationId]="application.applicationId"
              [organizationId]="application.organizationId">
            </app-environments-list>
          </div>

          <!-- Roles Tab Panel -->
          <div
            class="app-detail-tab-panel"
            *ngIf="activeTab === 'roles' && !isDraft"
            role="tabpanel"
            id="panel-roles"
            [attr.aria-labelledby]="'tab-roles'">
            <app-application-roles-list
              [applicationId]="application.applicationId"
              [organizationId]="application.organizationId">
            </app-application-roles-list>
          </div>

          <!-- Users Tab Panel -->
          <div
            class="app-detail-tab-panel"
            *ngIf="activeTab === 'users' && !isDraft"
            role="tabpanel"
            id="panel-users"
            [attr.aria-labelledby]="'tab-users'">
            <app-application-users-list
              [applicationId]="application.applicationId">
            </app-application-users-list>
          </div>

          <!-- Danger Zone Tab Panel -->
          <div
            class="app-detail-tab-panel"
            *ngIf="activeTab === 'danger'"
            role="tabpanel"
            id="panel-danger"
            [attr.aria-labelledby]="'tab-danger'">
            <app-danger-zone-card
              title="Delete Application"
              description="Permanently delete this application and all associated data including API keys. This action cannot be undone."
              buttonText="Delete Application"
              [isLoading]="data.isSaving"
              (action)="onDelete()">
            </app-danger-zone-card>
          </div>
        </div>

    <!-- Debug Panel -->
    <app-debug-panel
      [visible]="(debugMode$ | async) || false"
      [title]="'Application Detail Debug'"
      [logs$]="debugLogs$"
      [context]="debugContext">
    </app-debug-panel>

  </app-user-page>
</ng-container>