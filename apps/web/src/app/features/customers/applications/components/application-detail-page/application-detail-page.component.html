<!-- Application Detail Page Template -->
<!-- Uses NgRx store as single source of truth (store-first pattern) -->
<!-- Includes tabbed interface for Details, Groups, and API Keys -->
<!-- @see .kiro/specs/store-centric-refactoring/design.md -->
<!-- @see .kiro/specs/application-access-management/design.md -->

<ng-container *ngIf="{
  isLoading: isLoading$ | async,
  isSaving: isSaving$ | async,
  saveError: saveError$ | async,
  organizations: organizations$ | async
} as data">
  <div class="app-detail-container">
    <!-- Page Header -->
    <div class="orb-page-header">
      <div class="orb-page-header__content">
        <div class="orb-page-header__flex-container">
          <div class="orb-page-header__logo-section">
            <img src="assets/orb-logo.jpg" alt="Orb Integration Hub Logo" class="orb-page-header__logo">
          </div>
          <div class="orb-page-header__text-section">
            <div class="orb-page-header__greeting">
              <div class="orb-page-header__icon-title">
                <fa-icon icon="rocket" class="orb-page-header__icon-fa"></fa-icon>
                <h1 class="orb-page-header__title">
                  {{ isDraft ? 'Complete Application Setup' : (application?.name || 'Application Details') }}
                </h1>
              </div>
              <p class="orb-page-header__subtitle" *ngIf="isDraft">
                Your application was created but needs to be completed. Fill in the details below and click "Activate Application" to finish setup.
              </p>
              <p class="orb-page-header__subtitle" *ngIf="!isDraft && !data.isLoading && !loadError">
                Manage your application's settings, groups, and API keys.
              </p>
              <div class="orb-page-header__status" *ngIf="application && !isDraft">
                <app-status-badge
                  [status]="application.status"
                  type="application"
                  [showIcon]="true"
                  [showLabel]="true"
                  size="medium"
                  variant="chip">
                </app-status-badge>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Back Link -->
    <div class="app-detail-content">
      <div class="app-detail-breadcrumb">
        <a routerLink="/customers/applications" class="app-detail-back-link">
          <fa-icon icon="arrow-left"></fa-icon>
          Back to Applications
        </a>
      </div>

      <!-- Loading State -->
      <div class="app-detail-loading" *ngIf="data.isLoading">
        <fa-icon icon="spinner" animation="spin" size="2x"></fa-icon>
        <p>Loading application...</p>
      </div>

      <!-- Error State -->
      <div class="app-detail-error" *ngIf="loadError && !data.isLoading">
        <fa-icon icon="exclamation-triangle" size="2x"></fa-icon>
        <p>{{ loadError }}</p>
        <button class="orb-btn orb-btn--secondary" routerLink="/customers/applications">
          Back to Applications
        </button>
      </div>

      <!-- Content with Tabs -->
      <div class="app-detail-tabs-section" *ngIf="application && !data.isLoading && !loadError">
        <!-- Tab Navigation (always shown - users need Security tab to generate keys before activation) -->
        <nav class="app-detail-tabs" role="tablist" aria-label="Application sections">
          <button
            class="app-detail-tabs__tab"
            [class.app-detail-tabs__tab--active]="activeTab === ApplicationDetailTab.Details"
            (click)="setActiveTab(ApplicationDetailTab.Details)"
            role="tab"
            [attr.aria-selected]="activeTab === ApplicationDetailTab.Details"
            [attr.aria-controls]="'panel-details'"
            id="tab-details">
            <fa-icon icon="info-circle"></fa-icon>
            Details
          </button>
          <button
            class="app-detail-tabs__tab"
            [class.app-detail-tabs__tab--active]="activeTab === ApplicationDetailTab.Groups"
            (click)="setActiveTab(ApplicationDetailTab.Groups)"
            role="tab"
            [attr.aria-selected]="activeTab === ApplicationDetailTab.Groups"
            [attr.aria-controls]="'panel-groups'"
            id="tab-groups">
            <fa-icon icon="users"></fa-icon>
            Groups
            <span class="app-detail-tabs__count" *ngIf="application.groupCount">{{ application.groupCount }}</span>
          </button>
          <button
            class="app-detail-tabs__tab"
            [class.app-detail-tabs__tab--active]="activeTab === ApplicationDetailTab.Security"
            (click)="setActiveTab(ApplicationDetailTab.Security)"
            role="tab"
            [attr.aria-selected]="activeTab === ApplicationDetailTab.Security"
            [attr.aria-controls]="'panel-security'"
            id="tab-security">
            <fa-icon icon="shield-alt"></fa-icon>
            Security
          </button>
        </nav>

        <!-- Tab Panels -->
        <div class="app-detail-tab-panels">
          <!-- Details Tab Panel -->
          <div
            class="app-detail-tab-panel"
            *ngIf="activeTab === ApplicationDetailTab.Details || isDraft"
            role="tabpanel"
            id="panel-details"
            [attr.aria-labelledby]="'tab-details'">
            <!-- Form Card using global orb-card styles -->
            <div class="orb-card">
              <div class="orb-card__header">
                <h2 class="orb-card__title">
                  <fa-icon icon="info-circle" class="orb-card__icon"></fa-icon>
                  Application Information
                </h2>
              </div>
              <div class="orb-card__content orb-card__content--padded">
                <!-- Organization Field -->
                <div class="app-detail-field">
                  <label class="app-detail-field__label" for="app-organization">
                    Organization <span class="app-detail-field__required">*</span>
                  </label>
                  <div *ngIf="!data.organizations || data.organizations.length === 0" class="app-detail-field__no-orgs">
                    <fa-icon icon="exclamation-circle"></fa-icon>
                    <span>No organizations available. <a routerLink="/customers/organizations">Create one first</a>.</span>
                  </div>
                  <select
                    *ngIf="data.organizations && data.organizations.length > 0"
                    id="app-organization"
                    class="app-detail-field__select"
                    [class.app-detail-field__select--error]="validationErrors.organizationId"
                    [(ngModel)]="editForm.organizationId"
                    [attr.aria-invalid]="validationErrors.organizationId ? 'true' : 'false'"
                    [attr.aria-describedby]="validationErrors.organizationId ? 'org-error' : null">
                    <option value="" disabled>Select an organization</option>
                    <option *ngFor="let org of data.organizations" [value]="org.organizationId">
                      {{ org.name }}
                    </option>
                  </select>
                  <div class="app-detail-field__error" id="org-error" *ngIf="validationErrors.organizationId">
                    {{ validationErrors.organizationId }}
                  </div>
                </div>

                <!-- Name Field -->
                <div class="app-detail-field">
                  <label class="app-detail-field__label" for="app-name">
                    Application Name <span class="app-detail-field__required">*</span>
                  </label>
                  <input
                    type="text"
                    id="app-name"
                    class="app-detail-field__input"
                    [class.app-detail-field__input--error]="validationErrors.name"
                    [(ngModel)]="editForm.name"
                    placeholder="Enter application name"
                    maxlength="100"
                    [attr.aria-invalid]="validationErrors.name ? 'true' : 'false'"
                    [attr.aria-describedby]="validationErrors.name ? 'name-error' : null">
                  <div class="app-detail-field__error" id="name-error" *ngIf="validationErrors.name">
                    {{ validationErrors.name }}
                  </div>
                  <div class="app-detail-field__hint">
                    {{ editForm.name.length }}/100 characters
                  </div>
                </div>

                <!-- Description Field -->
                <div class="app-detail-field">
                  <label class="app-detail-field__label" for="app-description">
                    Description
                  </label>
                  <textarea
                    id="app-description"
                    class="app-detail-field__textarea"
                    [class.app-detail-field__textarea--error]="validationErrors.description"
                    [(ngModel)]="editForm.description"
                    placeholder="Enter a brief description of your application"
                    maxlength="500"
                    rows="4"
                    [attr.aria-invalid]="validationErrors.description ? 'true' : 'false'"
                    [attr.aria-describedby]="validationErrors.description ? 'desc-error' : null">
                  </textarea>
                  <div class="app-detail-field__error" id="desc-error" *ngIf="validationErrors.description">
                    {{ validationErrors.description }}
                  </div>
                  <div class="app-detail-field__hint">
                    {{ editForm.description.length }}/500 characters
                  </div>
                </div>

                <!-- Environments Field -->
                <div class="app-detail-field">
                  <span class="app-detail-field__label" id="environments-label">
                    Environments <span class="app-detail-field__required">*</span>
                  </span>
                  <p class="app-detail-field__description">
                    Select the deployment environments for this application.
                  </p>
                  <div class="app-detail-environments"
                       role="group"
                       aria-labelledby="environments-label"
                       [attr.aria-describedby]="validationErrors.environments ? 'env-error' : null">
                    <label
                      *ngFor="let env of availableEnvironments"
                      class="app-detail-environments__item"
                      [class.app-detail-environments__item--selected]="isEnvironmentSelected(env.value)">
                      <input
                        type="checkbox"
                        class="app-detail-environments__checkbox"
                        [checked]="isEnvironmentSelected(env.value)"
                        (change)="onEnvironmentToggle(env.value)"
                        [attr.aria-label]="env.label + ': ' + env.description">
                      <span class="app-detail-environments__content">
                        <span class="app-detail-environments__label">{{ env.label }}</span>
                        <span class="app-detail-environments__description">{{ env.description }}</span>
                      </span>
                    </label>
                  </div>
                  <div class="app-detail-field__error" id="env-error" *ngIf="validationErrors.environments">
                    {{ validationErrors.environments }}
                  </div>
                </div>

                <!-- Metadata (read-only, shown for existing apps) -->
                <div class="app-detail-metadata" *ngIf="!isDraft">
                  <div class="app-detail-metadata__item">
                    <span class="app-detail-metadata__label">Application ID</span>
                    <span class="app-detail-metadata__value">{{ application.applicationId }}</span>
                  </div>
                  <div class="app-detail-metadata__item">
                    <span class="app-detail-metadata__label">Created</span>
                    <span class="app-detail-metadata__value">{{ formatDate(application.createdAt) }}</span>
                  </div>
                  <div class="app-detail-metadata__item">
                    <span class="app-detail-metadata__label">Last Updated</span>
                    <span class="app-detail-metadata__value">{{ formatDate(application.updatedAt) }}</span>
                  </div>
                </div>

                <!-- Save Error -->
                <div class="app-detail-save-error" *ngIf="data.saveError">
                  <fa-icon icon="exclamation-circle"></fa-icon>
                  {{ data.saveError }}
                </div>

                <!-- API Key Validation Error -->
                <div class="app-detail-api-key-error" *ngIf="apiKeyValidationError">
                  <div class="app-detail-api-key-error__content">
                    <fa-icon icon="key" class="app-detail-api-key-error__icon"></fa-icon>
                    <div class="app-detail-api-key-error__text">
                      <p class="app-detail-api-key-error__message">{{ apiKeyValidationError }}</p>
                      <button
                        type="button"
                        class="app-detail-api-key-error__link"
                        (click)="setActiveTab(ApplicationDetailTab.Security)"
                        (keydown.enter)="setActiveTab(ApplicationDetailTab.Security)"
                        (keydown.space)="setActiveTab(ApplicationDetailTab.Security)">
                        <fa-icon icon="arrow-right"></fa-icon>
                        Go to Security Tab
                      </button>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Actions Footer -->
              <div class="app-detail-actions">
                <div class="app-detail-actions__left">
                  <button
                    class="orb-btn orb-btn--outline app-detail-actions__delete"
                    (click)="onDelete()"
                    [disabled]="data.isSaving">
                    <fa-icon icon="trash"></fa-icon>
                    Delete
                  </button>
                </div>
                <div class="app-detail-actions__right">
                  <button
                    class="orb-btn orb-btn--secondary"
                    (click)="onCancel()"
                    [disabled]="data.isSaving">
                    Cancel
                  </button>
                  <button
                    class="orb-btn orb-btn--primary"
                    (click)="onSave()"
                    [disabled]="data.isSaving || !data.organizations || data.organizations.length === 0">
                    <fa-icon icon="spinner" animation="spin" *ngIf="data.isSaving"></fa-icon>
                    <fa-icon icon="save" *ngIf="!data.isSaving"></fa-icon>
                    {{ isDraft ? 'Activate Application' : 'Save Changes' }}
                  </button>
                </div>
              </div>
            </div>
          </div>

          <!-- Groups Tab Panel -->
          <div
            class="app-detail-tab-panel"
            *ngIf="activeTab === ApplicationDetailTab.Groups && !isDraft"
            role="tabpanel"
            id="panel-groups"
            [attr.aria-labelledby]="'tab-groups'">
            <app-groups-list
              [applicationId]="application.applicationId"
              (groupSelected)="onGroupSelected($event)"
              (createGroup)="onCreateGroup()">
            </app-groups-list>
          </div>

          <!-- Security Tab Panel -->
          <div
            class="app-detail-tab-panel"
            *ngIf="activeTab === ApplicationDetailTab.Security"
            role="tabpanel"
            id="panel-security"
            [attr.aria-labelledby]="'tab-security'">
            
            <!-- API Keys Card -->
            <div class="orb-card">
              <div class="orb-card__header">
                <h2 class="orb-card__title">
                  <fa-icon icon="key" class="orb-card__icon"></fa-icon>
                  API Keys
                </h2>
              </div>
              <div class="orb-card__content">
                <!-- Empty State -->
                <div class="security-empty" *ngIf="environmentKeyRows.length === 0">
                  <fa-icon icon="info-circle" size="2x"></fa-icon>
                  <p class="security-empty__text">No environments configured</p>
                  <p class="security-empty__hint">
                    <button
                      type="button"
                      class="security-empty__link"
                      (click)="setActiveTab(ApplicationDetailTab.Details)"
                      (keydown.enter)="setActiveTab(ApplicationDetailTab.Details)"
                      (keydown.space)="setActiveTab(ApplicationDetailTab.Details)">
                      Configure environments in the Details tab
                    </button>
                  </p>
                </div>

                <!-- Environment Key Rows -->
                <div class="security-key-list" *ngIf="environmentKeyRows.length > 0">
                  <div class="security-key-row" *ngFor="let row of environmentKeyRows">
                    <!-- Environment Badge -->
                    <div class="security-key-row__env" [ngClass]="'security-key-row__env--' + row.environment.toLowerCase()">
                      <fa-icon icon="circle" class="security-key-row__env-icon"></fa-icon>
                      <span class="security-key-row__env-label">{{ row.environmentLabel }}</span>
                    </div>

                    <!-- Key Info (when key exists) -->
                    <div class="security-key-row__info" *ngIf="row.hasKey">
                      <span class="security-key-row__prefix">{{ row.apiKey?.keyPrefix }}...</span>
                      <app-status-badge
                        [status]="row.apiKey?.status || ''"
                        type="apiKey"
                        [showIcon]="true"
                        [showLabel]="true"
                        size="small"
                        variant="chip">
                      </app-status-badge>
                      <span class="security-key-row__last-used" *ngIf="row.apiKey?.lastUsedAt">
                        Last used: {{ formatRelativeTime(row.apiKey?.lastUsedAt) }}
                      </span>
                    </div>

                    <!-- No Key State -->
                    <div class="security-key-row__no-key" *ngIf="!row.hasKey">
                      <span>No API key</span>
                    </div>

                    <!-- Actions -->
                    <div class="security-key-row__actions">
                      <button
                        *ngIf="row.canGenerate"
                        class="orb-btn orb-btn--primary orb-btn--sm"
                        (click)="onGenerateKeyForEnvironment(row.environment)"
                        [disabled]="(isGeneratingKey$ | async)">
                        <fa-icon icon="plus"></fa-icon>
                        Generate Key
                      </button>
                      <button
                        *ngIf="row.canRotate"
                        class="orb-btn orb-btn--secondary orb-btn--sm"
                        (click)="onRotateKeyForRow(row)"
                        [disabled]="(isRotatingKey$ | async)">
                        <fa-icon icon="sync-alt"></fa-icon>
                        Rotate
                      </button>
                      <button
                        *ngIf="row.canRevoke"
                        class="orb-btn orb-btn--outline orb-btn--sm"
                        (click)="onRevokeKeyForRow(row)"
                        [disabled]="(isRevokingKey$ | async)">
                        <fa-icon icon="ban"></fa-icon>
                        Revoke
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Debug Panel -->
    <app-debug-panel
      [visible]="(debugMode$ | async) || false"
      [title]="'Application Detail Debug'"
      [logs$]="debugLogs$"
      [context]="debugContext">
    </app-debug-panel>
  </div>
</ng-container>
