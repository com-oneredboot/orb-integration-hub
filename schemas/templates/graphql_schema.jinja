{#-- Helper macro to join unique directives --#}
{% macro join_unique_directives(directives_list) -%}
  {%- set seen = [] -%}
  {%- for d in directives_list -%}
    {%- if d not in seen -%} {{ ' ' ~ d }}{%- do seen.append(d) -%}{%- endif -%}
  {%- endfor -%}
{%- endmacro %}

{%- include 'appsync_enums.jinja' -%}

{%- include 'graphql_schema_type.jinja' -%}

{%- include 'base_types.jinja' -%}

{%- for schema in table_schemas.values() %}
{#-- Collect all auth directives for Query/Mutation operations returning this type --#}
{%- set entity_field_directives = [] %}
{%- for op in schema.operations %}
  {%- for d in op.response_auth_directives %}
    {%- if d not in entity_field_directives %}{% do entity_field_directives.append(d) %}{% endif %}
  {%- endfor %}
{%- endfor %}
type {{ schema.name }} {
{%- for attr in schema.attributes %}
  {{ attr.name }}: {{ attr.type|graphql_type }}{{ join_unique_directives(entity_field_directives) }}
{%- endfor %}
}
{%- endfor %}

{#-- Response types with field-level directives --#}
{%- for schema in table_schemas.values() %}
{#-- Collect all response_auth_directives for Query operations returning this type --#}
{%- set response_directives = [] %}
{%- for op in schema.operations if op.type == 'Query' %}
  {%- for d in op.response_auth_directives %}
    {%- if d not in response_directives %}{% do response_directives.append(d) %}{% endif %}
  {%- endfor %}
{%- endfor %}
type {{ schema.name }}Response {
  StatusCode: Int!{{ join_unique_directives(response_directives) }}
  Message: String{{ join_unique_directives(response_directives) }}
  Data: {{ schema.name }}{{ join_unique_directives(response_directives) }}
}
{%- endfor %}
{%- for schema in table_schemas.values() %}
{%- set list_response_directives = [] %}
{%- for op in schema.operations if op.type == 'Query' %}
  {%- for d in op.response_auth_directives %}
    {%- if d not in list_response_directives %}{% do list_response_directives.append(d) %}{% endif %}
  {%- endfor %}
{%- endfor %}
type {{ schema.name }}ListResponse {
  StatusCode: Int!{{ join_unique_directives(list_response_directives) }}
  Message: String{{ join_unique_directives(list_response_directives) }}
  Data: [{{ schema.name }}]{{ join_unique_directives(list_response_directives) }}
}
{%- endfor %}
{%- for schema in table_schemas.values() %}
{%- for operation in schema.operations %}
{%- if operation.type != 'Query' %}
{%- set response_type_name = operation.field + 'Response' %}
type {{ response_type_name }} {
  StatusCode: Int!{{ join_unique_directives(operation.response_auth_directives) }}
  Message: String{{ join_unique_directives(operation.response_auth_directives) }}
  Data: {{ schema.name }}{{ join_unique_directives(operation.response_auth_directives) }}
}
{%- endif %}
{%- endfor %}
{%- endfor %}

type Query {
{%- include 'graphql_schema_queries.jinja' %}
}

type Mutation {
{%- include 'graphql_schema_mutations.jinja' %}
}
