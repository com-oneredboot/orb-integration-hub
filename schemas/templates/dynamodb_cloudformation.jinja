  # DynamoDB table for {{ model_name }}
  {{ table_name|replace('_', '')|capitalize }}Table:
    Properties:
      AttributeDefinitions:{%- set all_attrs = [keys.primary.partition] -%}
        {%- if keys.primary.sort -%}
          {%- set all_attrs = all_attrs + [keys.primary.sort] -%}
        {%- endif -%}
        {%- for idx in keys.secondary -%}
          {%- if idx.partition and idx.partition not in all_attrs -%}
            {%- set all_attrs = all_attrs + [idx.partition] -%}
          {%- endif -%}
          {%- if idx.sort and idx.sort not in all_attrs -%}
            {%- set all_attrs = all_attrs + [idx.sort] -%}
          {%- endif -%}
        {%- endfor %}
        -
          AttributeName: {{ keys.primary.partition }}
          AttributeType: S
        {%- if keys.primary.sort %}
        -
          AttributeName: {{ keys.primary.sort }}
          AttributeType: S
        {%- endif -%}
        {%- for idx in keys.secondary -%}
          {%- if idx.partition and idx.partition != keys.primary.partition and idx.partition != keys.primary.sort %}
        -
          AttributeName: {{ idx.partition }}
          AttributeType: S
          {%- endif -%}
          {%- if idx.sort and idx.sort != keys.primary.partition and idx.sort != keys.primary.sort and idx.sort != idx.partition %}
        -
          AttributeName: {{ idx.sort }}
          AttributeType: S
          {%- endif -%}
        {%- endfor %}
      BillingMode: PAY_PER_REQUEST
      KeySchema:
        -
          AttributeName: {{ keys.primary.partition }}
          KeyType: HASH
        {%- if keys.primary.sort %}
        -
          AttributeName: {{ keys.primary.sort }}
          KeyType: RANGE
        {%- endif %}
        {%- if keys.secondary %}
      GlobalSecondaryIndexes:
        {%- for idx in keys.secondary if idx.type == 'GSI' %}
        -
          IndexName: {{ idx.name }}
          KeySchema:
            -
              AttributeName: {{ idx.partition }}
              KeyType: HASH
            {%- if idx.sort %}
            -
              AttributeName: {{ idx.sort }}
              KeyType: RANGE
            {%- endif %}
          Projection:
            ProjectionType: {{ idx.projection_type }}
            {%- if idx.projection_type == 'INCLUDE' and idx.projected_attributes %}
            NonKeyAttributes:
              {%- for attr in idx.projected_attributes %}
              - {{ attr }}
              {%- endfor %}
            {%- endif %}
        {%- endfor %}
      LocalSecondaryIndexes:
        {%- for idx in keys.secondary if idx.type == 'LSI' %}
        -
          IndexName: {{ idx.name }}
          KeySchema:
            -
              AttributeName: {{ keys.primary.partition }}
              KeyType: HASH
            {%- if idx.sort %}
            -
              AttributeName: {{ idx.sort }}
              KeyType: RANGE
            {%- endif %}
          Projection:
            ProjectionType: {{ idx.projection_type }}
            {%- if idx.projection_type == 'INCLUDE' and idx.projected_attributes %}
            NonKeyAttributes:
              {%- for attr in idx.projected_attributes %}
              - {{ attr }}
              {%- endfor %}
            {%- endif %}
        {%- endfor %}
        {%- endif %}
      TableName: !Sub "${CustomerId}-${ProjectId}-${Environment}-{{ table_name }}"
      Tags:
        - Key: Billable
          Value: "true"
        - Key: CustomerId
          Value: !Ref CustomerId
        - Key: Environment
          Value: !Ref Environment
        - Key: ProjectId
          Value: !Ref ProjectId
    Type: AWS::DynamoDB::Table

  # Parameter Store for table name
  {{ table_name|replace('_', '')|capitalize }}TableNameParameter:
    Properties:
      Name: !Sub "${CustomerId}-${ProjectId}-${Environment}-{{ table_name }}-table-name"
      Type: String
      Value: !Ref {{ table_name|replace('_', '')|capitalize }}Table
      Description: DynamoDB {{ model_name }} Table Name
      Tags:
        Billable: true
        CustomerId: !Ref CustomerId
        Environment: !Ref Environment
        ProjectId: !Ref ProjectId
    Type: AWS::SSM::Parameter

  # Parameter Store for table ARN
  {{ table_name|replace('_', '')|capitalize }}TableArnParameter:
    Properties:
      Name: !Sub "${CustomerId}-${ProjectId}-${Environment}-{{ table_name }}-table-arn"
      Type: String
      Value: !GetAtt {{ table_name|replace('_', '')|capitalize }}Table.Arn
      Description: DynamoDB {{ model_name }} Table Arn
      Tags:
        Billable: true
        CustomerId: !Ref CustomerId
        Environment: !Ref Environment
        ProjectId: !Ref ProjectId
    Type: AWS::SSM::Parameter