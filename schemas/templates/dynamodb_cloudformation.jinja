# --------------------------------------------------- #
AWSTemplateFormatVersion: 2010-09-09

# --------------------------------------------------- #
Transform: AWS::Serverless-2016-10-31

# --------------------------------------------------- #
Description: >
 Application Infrastructure - DynamoDB Tables

# --------------------------------------------------- #
Parameters:
  Environment:
    Default: dev
    Type: String
    Description: Environment name (dev, staging, prod)
  CustomerId:
    Default: orb
    Type: String
    Description: Customer identifier
  ProjectId:
    Default: integration-hub
    Type: String
    Description: Project identifier
  TracingIs:
    Default: Active
    Type: String
    Description: Whether tracing is enabled

# --------------------------------------------------- #
Resources:
  {% for schema, table in schemas.items() %}
  {{ table }}Table:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !Sub ${CustomerId}-${ProjectId}-${Environment}-{{ table }}
      AttributeDefinitions:
        {% for attr in schema.attributes %}
        - AttributeName: {{ attr.name }}
          AttributeType: {{ attr.type }}
        {% endfor %}
      KeySchema:
        - AttributeName: {{ schema.partition_key }}
          KeyType: HASH
        {% if schema.sort_key %}
        - AttributeName: {{ schema.sort_key }}
          KeyType: RANGE
        {% endif %}
      BillingMode: PAY_PER_REQUEST
      Tags:
        - Key: Billable
          Value: !Sub ${Environment}-${CustomerId}-${ProjectId}
        - Key: CustomerId
          Value: !Ref CustomerId
        - Key: Environment
          Value: !Ref Environment
        - Key: ProjectId
          Value: !Ref ProjectId

  {{ table }}TableName:
    Type: AWS::SSM::Parameter
    Properties:
      Name: !Sub ${Environment}-${CustomerId}-${ProjectId}-{{ table }}-table-name
      Type: String
      Value: !Ref {{ table }}Table

  {{ table }}TableArn:
    Type: AWS::SSM::Parameter
    Properties:
      Name: !Sub ${Environment}-${CustomerId}-${ProjectId}-{{ table }}-table-arn
      Type: String
      Value: !GetAtt {{ table }}Table.Arn
  {% endfor %}

# --------------------------------------------------- #
Outputs:
  {% for table, schema in schemas.items() %}
  {{ table }}TableName:
    Description: {{ table }} Table Name
    Value: !Ref {{ table }}Table

  {{ table }}TableArn:
    Description: {{ table }} Table ARN
    Value: !GetAtt {{ table }}Table.Arn
  {% endfor %}