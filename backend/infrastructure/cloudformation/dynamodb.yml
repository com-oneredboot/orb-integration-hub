# --------------------------------------------------- #
AWSTemplateFormatVersion: 2010-09-09

# --------------------------------------------------- #
Transform: AWS::Serverless-2016-10-31

# --------------------------------------------------- #
Description: >
 Application Infrastructure - DynamoDB Tables

# --------------------------------------------------- #
Parameters:
  Environment:
    Default: dev
    Type: String
    Description: Environment name (dev, staging, prod)
  CustomerId:
    Default: orb
    Type: String
    Description: Customer identifier
  ProjectId:
    Default: integration-hub
    Type: String
    Description: Project identifier
  TracingIs:
    Default: Active
    Type: String
    Description: Whether tracing is enabled

# --------------------------------------------------- #
Resources:
  TableSchema(table='Applications', attributes=[Attribute(name='application_id', type='S'), Attribute(name='name', type='S'), Attribute(name='description', type='S'), Attribute(name='status', type='S'), Attribute(name='created_at', type='N'), Attribute(name='updated_at', type='N'), Attribute(name='user_id', type='S')], partition_key='application_id', sort_key=None)Table:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !Sub ${CustomerId}-${ProjectId}-${Environment}-TableSchema(table='Applications', attributes=[Attribute(name='application_id', type='S'), Attribute(name='name', type='S'), Attribute(name='description', type='S'), Attribute(name='status', type='S'), Attribute(name='created_at', type='N'), Attribute(name='updated_at', type='N'), Attribute(name='user_id', type='S')], partition_key='application_id', sort_key=None)
      AttributeDefinitions:
      KeySchema:
        - AttributeName: 
          KeyType: HASH

  TableSchema(table='Applications', attributes=[Attribute(name='application_id', type='S'), Attribute(name='name', type='S'), Attribute(name='description', type='S'), Attribute(name='status', type='S'), Attribute(name='created_at', type='N'), Attribute(name='updated_at', type='N'), Attribute(name='user_id', type='S')], partition_key='application_id', sort_key=None)TableName:
    Type: AWS::SSM::Parameter
    Properties:
      Name: !Sub ${Environment}-${CustomerId}-${ProjectId}-TableSchema(table='Applications', attributes=[Attribute(name='application_id', type='S'), Attribute(name='name', type='S'), Attribute(name='description', type='S'), Attribute(name='status', type='S'), Attribute(name='created_at', type='N'), Attribute(name='updated_at', type='N'), Attribute(name='user_id', type='S')], partition_key='application_id', sort_key=None)-table-name
      Type: String
      Value: !Ref TableSchema(table='Applications', attributes=[Attribute(name='application_id', type='S'), Attribute(name='name', type='S'), Attribute(name='description', type='S'), Attribute(name='status', type='S'), Attribute(name='created_at', type='N'), Attribute(name='updated_at', type='N'), Attribute(name='user_id', type='S')], partition_key='application_id', sort_key=None)Table

  TableSchema(table='Applications', attributes=[Attribute(name='application_id', type='S'), Attribute(name='name', type='S'), Attribute(name='description', type='S'), Attribute(name='status', type='S'), Attribute(name='created_at', type='N'), Attribute(name='updated_at', type='N'), Attribute(name='user_id', type='S')], partition_key='application_id', sort_key=None)TableArn:
    Type: AWS::SSM::Parameter
    Properties:
      Name: !Sub ${Environment}-${CustomerId}-${ProjectId}-TableSchema(table='Applications', attributes=[Attribute(name='application_id', type='S'), Attribute(name='name', type='S'), Attribute(name='description', type='S'), Attribute(name='status', type='S'), Attribute(name='created_at', type='N'), Attribute(name='updated_at', type='N'), Attribute(name='user_id', type='S')], partition_key='application_id', sort_key=None)-table-arn
      Type: String
      Value: !GetAtt TableSchema(table='Applications', attributes=[Attribute(name='application_id', type='S'), Attribute(name='name', type='S'), Attribute(name='description', type='S'), Attribute(name='status', type='S'), Attribute(name='created_at', type='N'), Attribute(name='updated_at', type='N'), Attribute(name='user_id', type='S')], partition_key='application_id', sort_key=None)Table.Arn
  TableSchema(table='ApplicationRoles', attributes=[Attribute(name='application_id', type='S'), Attribute(name='role_id', type='S'), Attribute(name='description', type='S'), Attribute(name='status', type='S'), Attribute(name='created_at', type='N'), Attribute(name='updated_at', type='N')], partition_key='application_id', sort_key='role_id')Table:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !Sub ${CustomerId}-${ProjectId}-${Environment}-TableSchema(table='ApplicationRoles', attributes=[Attribute(name='application_id', type='S'), Attribute(name='role_id', type='S'), Attribute(name='description', type='S'), Attribute(name='status', type='S'), Attribute(name='created_at', type='N'), Attribute(name='updated_at', type='N')], partition_key='application_id', sort_key='role_id')
      AttributeDefinitions:
      KeySchema:
        - AttributeName: 
          KeyType: HASH

  TableSchema(table='ApplicationRoles', attributes=[Attribute(name='application_id', type='S'), Attribute(name='role_id', type='S'), Attribute(name='description', type='S'), Attribute(name='status', type='S'), Attribute(name='created_at', type='N'), Attribute(name='updated_at', type='N')], partition_key='application_id', sort_key='role_id')TableName:
    Type: AWS::SSM::Parameter
    Properties:
      Name: !Sub ${Environment}-${CustomerId}-${ProjectId}-TableSchema(table='ApplicationRoles', attributes=[Attribute(name='application_id', type='S'), Attribute(name='role_id', type='S'), Attribute(name='description', type='S'), Attribute(name='status', type='S'), Attribute(name='created_at', type='N'), Attribute(name='updated_at', type='N')], partition_key='application_id', sort_key='role_id')-table-name
      Type: String
      Value: !Ref TableSchema(table='ApplicationRoles', attributes=[Attribute(name='application_id', type='S'), Attribute(name='role_id', type='S'), Attribute(name='description', type='S'), Attribute(name='status', type='S'), Attribute(name='created_at', type='N'), Attribute(name='updated_at', type='N')], partition_key='application_id', sort_key='role_id')Table

  TableSchema(table='ApplicationRoles', attributes=[Attribute(name='application_id', type='S'), Attribute(name='role_id', type='S'), Attribute(name='description', type='S'), Attribute(name='status', type='S'), Attribute(name='created_at', type='N'), Attribute(name='updated_at', type='N')], partition_key='application_id', sort_key='role_id')TableArn:
    Type: AWS::SSM::Parameter
    Properties:
      Name: !Sub ${Environment}-${CustomerId}-${ProjectId}-TableSchema(table='ApplicationRoles', attributes=[Attribute(name='application_id', type='S'), Attribute(name='role_id', type='S'), Attribute(name='description', type='S'), Attribute(name='status', type='S'), Attribute(name='created_at', type='N'), Attribute(name='updated_at', type='N')], partition_key='application_id', sort_key='role_id')-table-arn
      Type: String
      Value: !GetAtt TableSchema(table='ApplicationRoles', attributes=[Attribute(name='application_id', type='S'), Attribute(name='role_id', type='S'), Attribute(name='description', type='S'), Attribute(name='status', type='S'), Attribute(name='created_at', type='N'), Attribute(name='updated_at', type='N')], partition_key='application_id', sort_key='role_id')Table.Arn
  TableSchema(table='ApplicationUsers', attributes=[Attribute(name='application_id', type='S'), Attribute(name='user_id', type='S'), Attribute(name='role_id', type='S'), Attribute(name='status', type='S'), Attribute(name='created_at', type='N'), Attribute(name='updated_at', type='N')], partition_key='application_id', sort_key='user_id')Table:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !Sub ${CustomerId}-${ProjectId}-${Environment}-TableSchema(table='ApplicationUsers', attributes=[Attribute(name='application_id', type='S'), Attribute(name='user_id', type='S'), Attribute(name='role_id', type='S'), Attribute(name='status', type='S'), Attribute(name='created_at', type='N'), Attribute(name='updated_at', type='N')], partition_key='application_id', sort_key='user_id')
      AttributeDefinitions:
      KeySchema:
        - AttributeName: 
          KeyType: HASH

  TableSchema(table='ApplicationUsers', attributes=[Attribute(name='application_id', type='S'), Attribute(name='user_id', type='S'), Attribute(name='role_id', type='S'), Attribute(name='status', type='S'), Attribute(name='created_at', type='N'), Attribute(name='updated_at', type='N')], partition_key='application_id', sort_key='user_id')TableName:
    Type: AWS::SSM::Parameter
    Properties:
      Name: !Sub ${Environment}-${CustomerId}-${ProjectId}-TableSchema(table='ApplicationUsers', attributes=[Attribute(name='application_id', type='S'), Attribute(name='user_id', type='S'), Attribute(name='role_id', type='S'), Attribute(name='status', type='S'), Attribute(name='created_at', type='N'), Attribute(name='updated_at', type='N')], partition_key='application_id', sort_key='user_id')-table-name
      Type: String
      Value: !Ref TableSchema(table='ApplicationUsers', attributes=[Attribute(name='application_id', type='S'), Attribute(name='user_id', type='S'), Attribute(name='role_id', type='S'), Attribute(name='status', type='S'), Attribute(name='created_at', type='N'), Attribute(name='updated_at', type='N')], partition_key='application_id', sort_key='user_id')Table

  TableSchema(table='ApplicationUsers', attributes=[Attribute(name='application_id', type='S'), Attribute(name='user_id', type='S'), Attribute(name='role_id', type='S'), Attribute(name='status', type='S'), Attribute(name='created_at', type='N'), Attribute(name='updated_at', type='N')], partition_key='application_id', sort_key='user_id')TableArn:
    Type: AWS::SSM::Parameter
    Properties:
      Name: !Sub ${Environment}-${CustomerId}-${ProjectId}-TableSchema(table='ApplicationUsers', attributes=[Attribute(name='application_id', type='S'), Attribute(name='user_id', type='S'), Attribute(name='role_id', type='S'), Attribute(name='status', type='S'), Attribute(name='created_at', type='N'), Attribute(name='updated_at', type='N')], partition_key='application_id', sort_key='user_id')-table-arn
      Type: String
      Value: !GetAtt TableSchema(table='ApplicationUsers', attributes=[Attribute(name='application_id', type='S'), Attribute(name='user_id', type='S'), Attribute(name='role_id', type='S'), Attribute(name='status', type='S'), Attribute(name='created_at', type='N'), Attribute(name='updated_at', type='N')], partition_key='application_id', sort_key='user_id')Table.Arn
  TableSchema(table='Roles', attributes=[Attribute(name='role_id', type='S'), Attribute(name='user_id', type='S'), Attribute(name='application_id', type='S'), Attribute(name='role_name', type='S'), Attribute(name='role_type', type='S'), Attribute(name='permissions', type='S'), Attribute(name='created_at', type='N'), Attribute(name='updated_at', type='N'), Attribute(name='active', type='S')], partition_key='role_id', sort_key='application_id')Table:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !Sub ${CustomerId}-${ProjectId}-${Environment}-TableSchema(table='Roles', attributes=[Attribute(name='role_id', type='S'), Attribute(name='user_id', type='S'), Attribute(name='application_id', type='S'), Attribute(name='role_name', type='S'), Attribute(name='role_type', type='S'), Attribute(name='permissions', type='S'), Attribute(name='created_at', type='N'), Attribute(name='updated_at', type='N'), Attribute(name='active', type='S')], partition_key='role_id', sort_key='application_id')
      AttributeDefinitions:
      KeySchema:
        - AttributeName: 
          KeyType: HASH

  TableSchema(table='Roles', attributes=[Attribute(name='role_id', type='S'), Attribute(name='user_id', type='S'), Attribute(name='application_id', type='S'), Attribute(name='role_name', type='S'), Attribute(name='role_type', type='S'), Attribute(name='permissions', type='S'), Attribute(name='created_at', type='N'), Attribute(name='updated_at', type='N'), Attribute(name='active', type='S')], partition_key='role_id', sort_key='application_id')TableName:
    Type: AWS::SSM::Parameter
    Properties:
      Name: !Sub ${Environment}-${CustomerId}-${ProjectId}-TableSchema(table='Roles', attributes=[Attribute(name='role_id', type='S'), Attribute(name='user_id', type='S'), Attribute(name='application_id', type='S'), Attribute(name='role_name', type='S'), Attribute(name='role_type', type='S'), Attribute(name='permissions', type='S'), Attribute(name='created_at', type='N'), Attribute(name='updated_at', type='N'), Attribute(name='active', type='S')], partition_key='role_id', sort_key='application_id')-table-name
      Type: String
      Value: !Ref TableSchema(table='Roles', attributes=[Attribute(name='role_id', type='S'), Attribute(name='user_id', type='S'), Attribute(name='application_id', type='S'), Attribute(name='role_name', type='S'), Attribute(name='role_type', type='S'), Attribute(name='permissions', type='S'), Attribute(name='created_at', type='N'), Attribute(name='updated_at', type='N'), Attribute(name='active', type='S')], partition_key='role_id', sort_key='application_id')Table

  TableSchema(table='Roles', attributes=[Attribute(name='role_id', type='S'), Attribute(name='user_id', type='S'), Attribute(name='application_id', type='S'), Attribute(name='role_name', type='S'), Attribute(name='role_type', type='S'), Attribute(name='permissions', type='S'), Attribute(name='created_at', type='N'), Attribute(name='updated_at', type='N'), Attribute(name='active', type='S')], partition_key='role_id', sort_key='application_id')TableArn:
    Type: AWS::SSM::Parameter
    Properties:
      Name: !Sub ${Environment}-${CustomerId}-${ProjectId}-TableSchema(table='Roles', attributes=[Attribute(name='role_id', type='S'), Attribute(name='user_id', type='S'), Attribute(name='application_id', type='S'), Attribute(name='role_name', type='S'), Attribute(name='role_type', type='S'), Attribute(name='permissions', type='S'), Attribute(name='created_at', type='N'), Attribute(name='updated_at', type='N'), Attribute(name='active', type='S')], partition_key='role_id', sort_key='application_id')-table-arn
      Type: String
      Value: !GetAtt TableSchema(table='Roles', attributes=[Attribute(name='role_id', type='S'), Attribute(name='user_id', type='S'), Attribute(name='application_id', type='S'), Attribute(name='role_name', type='S'), Attribute(name='role_type', type='S'), Attribute(name='permissions', type='S'), Attribute(name='created_at', type='N'), Attribute(name='updated_at', type='N'), Attribute(name='active', type='S')], partition_key='role_id', sort_key='application_id')Table.Arn
  TableSchema(table='Users', attributes=[Attribute(name='user_id', type='S'), Attribute(name='cognito_id', type='S'), Attribute(name='email', type='S'), Attribute(name='phone_number', type='S'), Attribute(name='phone_verified', type='S'), Attribute(name='first_name', type='S'), Attribute(name='last_name', type='S'), Attribute(name='groups', type='S'), Attribute(name='status', type='S'), Attribute(name='created_at', type='N'), Attribute(name='updated_at', type='N')], partition_key='user_id', sort_key=None)Table:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !Sub ${CustomerId}-${ProjectId}-${Environment}-TableSchema(table='Users', attributes=[Attribute(name='user_id', type='S'), Attribute(name='cognito_id', type='S'), Attribute(name='email', type='S'), Attribute(name='phone_number', type='S'), Attribute(name='phone_verified', type='S'), Attribute(name='first_name', type='S'), Attribute(name='last_name', type='S'), Attribute(name='groups', type='S'), Attribute(name='status', type='S'), Attribute(name='created_at', type='N'), Attribute(name='updated_at', type='N')], partition_key='user_id', sort_key=None)
      AttributeDefinitions:
      KeySchema:
        - AttributeName: 
          KeyType: HASH

  TableSchema(table='Users', attributes=[Attribute(name='user_id', type='S'), Attribute(name='cognito_id', type='S'), Attribute(name='email', type='S'), Attribute(name='phone_number', type='S'), Attribute(name='phone_verified', type='S'), Attribute(name='first_name', type='S'), Attribute(name='last_name', type='S'), Attribute(name='groups', type='S'), Attribute(name='status', type='S'), Attribute(name='created_at', type='N'), Attribute(name='updated_at', type='N')], partition_key='user_id', sort_key=None)TableName:
    Type: AWS::SSM::Parameter
    Properties:
      Name: !Sub ${Environment}-${CustomerId}-${ProjectId}-TableSchema(table='Users', attributes=[Attribute(name='user_id', type='S'), Attribute(name='cognito_id', type='S'), Attribute(name='email', type='S'), Attribute(name='phone_number', type='S'), Attribute(name='phone_verified', type='S'), Attribute(name='first_name', type='S'), Attribute(name='last_name', type='S'), Attribute(name='groups', type='S'), Attribute(name='status', type='S'), Attribute(name='created_at', type='N'), Attribute(name='updated_at', type='N')], partition_key='user_id', sort_key=None)-table-name
      Type: String
      Value: !Ref TableSchema(table='Users', attributes=[Attribute(name='user_id', type='S'), Attribute(name='cognito_id', type='S'), Attribute(name='email', type='S'), Attribute(name='phone_number', type='S'), Attribute(name='phone_verified', type='S'), Attribute(name='first_name', type='S'), Attribute(name='last_name', type='S'), Attribute(name='groups', type='S'), Attribute(name='status', type='S'), Attribute(name='created_at', type='N'), Attribute(name='updated_at', type='N')], partition_key='user_id', sort_key=None)Table

  TableSchema(table='Users', attributes=[Attribute(name='user_id', type='S'), Attribute(name='cognito_id', type='S'), Attribute(name='email', type='S'), Attribute(name='phone_number', type='S'), Attribute(name='phone_verified', type='S'), Attribute(name='first_name', type='S'), Attribute(name='last_name', type='S'), Attribute(name='groups', type='S'), Attribute(name='status', type='S'), Attribute(name='created_at', type='N'), Attribute(name='updated_at', type='N')], partition_key='user_id', sort_key=None)TableArn:
    Type: AWS::SSM::Parameter
    Properties:
      Name: !Sub ${Environment}-${CustomerId}-${ProjectId}-TableSchema(table='Users', attributes=[Attribute(name='user_id', type='S'), Attribute(name='cognito_id', type='S'), Attribute(name='email', type='S'), Attribute(name='phone_number', type='S'), Attribute(name='phone_verified', type='S'), Attribute(name='first_name', type='S'), Attribute(name='last_name', type='S'), Attribute(name='groups', type='S'), Attribute(name='status', type='S'), Attribute(name='created_at', type='N'), Attribute(name='updated_at', type='N')], partition_key='user_id', sort_key=None)-table-arn
      Type: String
      Value: !GetAtt TableSchema(table='Users', attributes=[Attribute(name='user_id', type='S'), Attribute(name='cognito_id', type='S'), Attribute(name='email', type='S'), Attribute(name='phone_number', type='S'), Attribute(name='phone_verified', type='S'), Attribute(name='first_name', type='S'), Attribute(name='last_name', type='S'), Attribute(name='groups', type='S'), Attribute(name='status', type='S'), Attribute(name='created_at', type='N'), Attribute(name='updated_at', type='N')], partition_key='user_id', sort_key=None)Table.Arn

# --------------------------------------------------- #
Outputs:
  ApplicationsTableName:
    Description: Applications Table Name
    Value: !Ref ApplicationsTable

  ApplicationsTableArn:
    Description: Applications Table ARN
    Value: !GetAtt ApplicationsTable.Arn
  ApplicationRolesTableName:
    Description: ApplicationRoles Table Name
    Value: !Ref ApplicationRolesTable

  ApplicationRolesTableArn:
    Description: ApplicationRoles Table ARN
    Value: !GetAtt ApplicationRolesTable.Arn
  ApplicationUsersTableName:
    Description: ApplicationUsers Table Name
    Value: !Ref ApplicationUsersTable

  ApplicationUsersTableArn:
    Description: ApplicationUsers Table ARN
    Value: !GetAtt ApplicationUsersTable.Arn
  RolesTableName:
    Description: Roles Table Name
    Value: !Ref RolesTable

  RolesTableArn:
    Description: Roles Table ARN
    Value: !GetAtt RolesTable.Arn
  UsersTableName:
    Description: Users Table Name
    Value: !Ref UsersTable

  UsersTableArn:
    Description: Users Table ARN
    Value: !GetAtt UsersTable.Arn
