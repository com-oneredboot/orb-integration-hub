<!-- 
file: frontend/src/app/features/user/components/auth-flow/auth-flow.component.html
author: Corey Dale Peters
date: 2025-03-07
description: HTML template file
-->

<!-- Skip link for keyboard users -->
<a class="auth-flow__skip-link" href="#main-content">Skip to main content</a>

<!-- ARIA live region for step announcements -->
<div id="auth-step-announcer" class="sr-only" aria-live="polite" aria-atomic="true"></div>

<!-- Initialization Error Boundary -->
<div *ngIf="hasInitializationError" class="auth-flow__error-boundary" role="alert" aria-live="assertive">
  <div class="auth-flow__error-boundary-content">
    <h2>System Initialization Failed</h2>
    <p>{{ initializationErrorMessage }}</p>
    <div class="auth-flow__error-boundary-actions">
      <button 
        *ngIf="canRetryInitialization"
        type="button" 
        class="btn btn-primary"
        (click)="retryInitialization()"
        [disabled]="!canRetryInitialization">
        Retry Initialization
      </button>
      <button 
        type="button" 
        class="btn btn-secondary"
        (click)="window.location.reload()">
        Refresh Page
      </button>
    </div>
  </div>
</div>

<!-- Normal Authentication Flow -->
<div *ngIf="!hasInitializationError" class="auth-flow" 
     (touchstart)="onTouchStart($event)"
     (touchmove)="onTouchMove($event)">
  <ng-container *ngIf="{
    currentStep: currentStep$ | async,
    isLoading: isLoading$ | async,
    error: error$ | async,
    userExists: userExists$ | async,
    phoneVerified: phoneVerified$ | async,
    mfaSetupDetails: mfaSetupDetails$ | async,
    buttonText: buttonText$ | async,
    stepTitle: stepTitle$ | async,
  } as state">

    <header class="auth-flow__header" role="banner">
      <div class="auth-flow__header-logo-section">
        <img src="../../../../../assets/onredboot-logo.jpg" alt="OneRedBoot Logo" class="auth-flow__header-logo">
      </div>
      <h1 id="form-title" class="auth-flow__header-title">{{ state.stepTitle }}</h1>
    </header>

    <div class="auth-flow__progress" 
         role="progressbar" 
         [attr.aria-valuenow]="getCurrentStepNumber(state.currentStep)"
         aria-valuemin="1" 
         aria-valuemax="4"
         [attr.aria-label]="'Registration Progress: Step ' + getCurrentStepNumber(state.currentStep) + ' of 4'">
      
      <!-- Screen reader announcement -->
      <span class="sr-only">Step {{ getCurrentStepNumber(state.currentStep) }} of 4: {{ getStepLabel(state.currentStep) }}</span>
      
      <!-- Progress percentage bar -->
      <div class="auth-flow__progress-bar">
        <div class="auth-flow__progress-bar-fill" 
             [style.width.%]="(getCurrentStepNumber(state.currentStep) - 1) * 33.33">
        </div>
      </div>
      
      <!-- Progress steps with labels -->
      <div class="auth-flow__progress-steps">
        <div class="auth-flow__progress-step-container"
             *ngFor="let progressStep of [1, 2, 3, 4]; let i = index"
             [ngClass]="{
               'step-active': getCurrentStepNumber(state.currentStep) === progressStep,
               'step-completed': getCurrentStepNumber(state.currentStep) > progressStep,
               'step-pending': getCurrentStepNumber(state.currentStep) < progressStep
             }">
          
          <!-- Step circle/indicator -->
          <div class="auth-flow__progress-step"
               [ngClass]="{
                 'auth-flow__progress-step--active': getCurrentStepNumber(state.currentStep) === progressStep,
                 'auth-flow__progress-step--completed': getCurrentStepNumber(state.currentStep) > progressStep,
                 'auth-flow__progress-step--pending': getCurrentStepNumber(state.currentStep) < progressStep
               }"
               [attr.aria-label]="getProgressStepLabel(progressStep)">
            
            <!-- Step number or check icon -->
            <span class="auth-flow__progress-step-content">
              <i *ngIf="getCurrentStepNumber(state.currentStep) > progressStep" 
                 class="fa fa-check" 
                 aria-hidden="true"></i>
              <span *ngIf="getCurrentStepNumber(state.currentStep) <= progressStep">{{ progressStep }}</span>
            </span>
          </div>
          
          <!-- Step label -->
          <div class="auth-flow__progress-step-label">
            {{ getProgressStepLabel(progressStep) }}
          </div>
        </div>
      </div>
    </div>

    <main id="main-content" role="main">
      
      <!-- WCAG 4.1.3 Status Messages - Comprehensive Screen Reader Announcements -->
      <div aria-live="polite" aria-atomic="true" class="sr-only" role="status">
        <span *ngIf="isStepTransitioning">{{ loadingMessage }}</span>
        <span *ngIf="isValidationInProgress()">Validating your information, please wait...</span>
        <span *ngIf="isFormProcessing()">Processing your authentication request...</span>
        <span *ngIf="qrCodeLoading">Generating secure authentication code...</span>
        <span *ngIf="showSuccessMessage">{{ successMessage }}</span>
      </div>
      
      <!-- Step Transition Loading Overlay -->
      <div *ngIf="isStepTransitioning" 
           class="auth-flow__step-loading" 
           role="status" 
           aria-live="polite"
           [attr.aria-label]="loadingMessage">
        <div class="auth-flow__step-loading-content">
          <div class="auth-flow__step-loading-spinner" aria-hidden="true"></div>
          <div class="auth-flow__step-loading-text">{{ loadingMessage }}</div>
        </div>
      </div>
      
      <!-- Simple Error Display -->
      <div *ngIf="state.error" 
           class="auth-flow__error" 
           [ngClass]="{
             'auth-flow__error--session-refresh': isSessionRefreshMessage(state.error),
             'auth-flow__error--success': isSuccessMessage(state.error)
           }"
           role="alert" 
           aria-live="assertive">
        <h3>{{ getErrorTitle(state.error) }}</h3>
        <p>{{ state.error }}</p>
        <button type="button" 
                class="btn btn-primary" 
                (click)="onErrorRetry()"
                [disabled]="isSessionRefreshMessage(state.error)">
          {{ getRetryButtonText(state.error) }}
        </button>
      </div>
      
      <form *ngIf="authForm && !state.error" [formGroup]="authForm" (ngSubmit)="onSubmit()" 
            class="auth-flow__form" 
            role="form" 
            aria-labelledby="form-title"
            novalidate>

      <!-- Email Step -->
      <div class="auth-flow__form-step"
           [ngClass]="{
             'auth-flow__form-step--active': state.currentStep === authSteps.EMAIL,
             'auth-flow__form-step--loading': skeletonStates.form && state.currentStep === authSteps.EMAIL
           }">
        
        <!-- Skeleton Screen for Email Step -->
        <div *ngIf="skeletonStates.form && state.currentStep === authSteps.EMAIL" 
             class="auth-flow__skeleton-overlay" 
             aria-hidden="true">
          <div class="auth-flow__skeleton auth-flow__skeleton--text medium"></div>
          <div class="auth-flow__skeleton auth-flow__skeleton--input"></div>
          <div class="auth-flow__skeleton auth-flow__skeleton--button"></div>
        </div>
        <div class="auth-flow__verification-info" role="status" aria-live="polite">
          <p>Enter your email address to sign in or create an account.</p>
        </div>
        <div class="auth-flow__input-group">
          <label for="email-input" class="auth-flow__label">
            Email Address <span class="auth-flow__required" aria-label="required">*</span>
          </label>
          <div class="auth-flow__input-group-container">
            <input type="email"
                   id="email-input"
                   formControlName="email"
                   class="auth-flow__input-group-field"
                   [ngClass]="{
                     'auth-flow__input-group-field--error': shouldShowFieldError('email'),
                     'auth-flow__input-group-field--valid': getFieldValidationStatus('email') === 'valid',
                     'auth-flow__input-group-field--pending': getFieldValidationStatus('email') === 'pending'
                   }"
                   placeholder="Enter your email address"
                   aria-describedby="email-error email-status"
                   [attr.aria-invalid]="shouldShowFieldError('email')"
                   aria-required="true"
                   autocomplete="email"
                   (focus)="onFieldFocus('email')"
                   (blur)="onFieldBlur('email')">
            <!-- Enhanced validation loading state -->
            <div *ngIf="validationLoadingStates['email']" 
                 class="auth-flow__validation-loading"
                 role="status"
                 aria-live="polite">
              <div class="auth-flow__validation-loading-spinner" aria-hidden="true"></div>
              <span>Validating email address...</span>
            </div>
            
            <!-- Real-time validation feedback -->
            <div id="email-status" 
                 class="auth-flow__validation-status auth-flow__validation-status--pending"
                 *ngIf="getFieldValidationStatus('email') === 'pending' && !shouldShowFieldError('email') && !validationLoadingStates['email']"
                 aria-live="polite">
              <i class="fa fa-spinner fa-spin auth-flow__validation-icon" aria-hidden="true"></i>
              <span class="sr-only">Validating email</span>
            </div>
            
            <div *ngIf="shouldShowFieldError('email')" 
                 id="email-error" 
                 class="auth-flow__input-error" 
                 role="alert" 
                 aria-live="polite">
              <i class="fa fa-exclamation-circle auth-flow__error-icon" aria-hidden="true"></i>
              <span class="sr-only">Error: </span>{{ getErrorMessage('email') }}
            </div>
          </div>
        </div>
      </div>

      <!-- Password Step -->
      <div class="auth-flow__form-step"
           [ngClass]="{'auth-flow__form-step--active': state.currentStep === authSteps.PASSWORD}">
        <div class="auth-flow__verification-info" role="status" aria-live="polite">
          <p>Enter the password for your account to continue.</p>
        </div>
        <div class="auth-flow__input-group">
          <label for="password-input" class="auth-flow__label">
            Password <span class="auth-flow__required" aria-label="required">*</span>
          </label>
          <div class="auth-flow__input-group-container">
            <input [type]="passwordVisible ? 'text' : 'password'"
                   id="password-input"
                   formControlName="password"
                   class="auth-flow__input-group-field"
                   [ngClass]="{
                     'auth-flow__input-group-field--error': shouldShowFieldError('password'),
                     'auth-flow__input-group-field--valid': getFieldValidationStatus('password') === 'valid',
                     'auth-flow__input-group-field--pending': getFieldValidationStatus('password') === 'pending'
                   }"
                   placeholder="Enter your password"
                   aria-describedby="password-error password-status"
                   [attr.aria-invalid]="shouldShowFieldError('password')"
                   aria-required="true"
                   autocomplete="current-password"
                   (focus)="onFieldFocus('password')"
                   (blur)="onFieldBlur('password')">
            <button type="button"
                    class="auth-flow__input-group-toggle"
                    (click)="togglePasswordVisibility()"
                    [attr.aria-label]="passwordVisible ? 'Hide password' : 'Show password'"
                    [attr.aria-pressed]="passwordVisible">
              <i class="fa" [class.fa-eye]="!passwordVisible" [class.fa-eye-slash]="passwordVisible" aria-hidden="true"></i>
            </button>
            <div id="password-status" 
                 class="auth-flow__validation-status"
                 [ngClass]="{
                   'auth-flow__validation-status--pending': getFieldValidationStatus('password') === 'pending'
                 }"
                 *ngIf="getFieldValidationStatus('password') === 'pending' && !shouldShowFieldError('password')"
                 aria-live="polite">
              <i class="fa fa-spinner fa-spin auth-flow__validation-icon" aria-hidden="true"></i>
              <span class="sr-only">Validating password</span>
            </div>
            
            <div *ngIf="shouldShowFieldError('password')" 
                 id="password-error" 
                 class="auth-flow__input-error" 
                 role="alert" 
                 aria-live="polite">
              <i class="fa fa-exclamation-circle auth-flow__error-icon" aria-hidden="true"></i>
              <span class="sr-only">Error: </span>{{ getErrorMessage('password') }}
            </div>
          </div>
        </div>
      </div>

      <!-- Password Setup Step -->
      <div class="auth-flow__form-step"
           [ngClass]="{'auth-flow__form-step--active': state.currentStep === authSteps.PASSWORD_SETUP}">
        <div class="auth-flow__verification-info" role="status" aria-live="polite">
          <p>Create a strong password that meets all the requirements below.</p>
        </div>
        <div class="auth-flow__input-group">
          <label for="password-setup-input" class="auth-flow__label">
            Create Password <span class="auth-flow__required" aria-label="required">*</span>
          </label>
          <div class="auth-flow__input-group-container">
            <input [type]="passwordVisible ? 'text' : 'password'"
                   id="password-setup-input"
                   formControlName="password"
                   class="auth-flow__input-group-field"
                   [ngClass]="{
                     'auth-flow__input-group-field--error': shouldShowFieldError('password'),
                     'auth-flow__input-group-field--valid': getFieldValidationStatus('password') === 'valid',
                     'auth-flow__input-group-field--pending': getFieldValidationStatus('password') === 'pending'
                   }"
                   placeholder="Create a strong password"
                   aria-describedby="password-requirements password-setup-status"
                   [attr.aria-invalid]="shouldShowFieldError('password')"
                   aria-required="true"
                   autocomplete="new-password"
                   (focus)="onFieldFocus('password')"
                   (blur)="onFieldBlur('password')">
            <button type="button"
                    class="auth-flow__input-group-toggle"
                    (click)="togglePasswordVisibility()"
                    [attr.aria-label]="passwordVisible ? 'Hide password' : 'Show password'"
                    [attr.aria-pressed]="passwordVisible">
              <i class="fa" [class.fa-eye]="!passwordVisible" [class.fa-eye-slash]="passwordVisible" aria-hidden="true"></i>
            </button>
          </div>

          
          <!-- Password Requirements Checklist -->
          <div id="password-requirements" 
               class="auth-flow__password-requirements" 
               role="group" 
               aria-labelledby="password-requirements-title">
            <h3 id="password-requirements-title" class="auth-flow__requirements-title">
              Password Requirements
            </h3>
            <ul class="auth-flow__requirements-list" role="list">
              <li class="auth-flow__requirement"
                  [ngClass]="{'auth-flow__requirement--valid': passwordValidations.minLength}"
                  role="listitem">
                <i class="fa auth-flow__requirement-icon"
                   [class.fa-times]="!passwordValidations.minLength"
                   [class.fa-check]="passwordValidations.minLength"
                   [attr.aria-label]="passwordValidations.minLength ? 'Requirement met' : 'Requirement not met'"
                   aria-hidden="true"></i>
                <span>At least 8 characters</span>
                <span class="sr-only">{{ passwordValidations.minLength ? 'met' : 'not met' }}</span>
              </li>
              <li class="auth-flow__requirement"
                  [ngClass]="{'auth-flow__requirement--valid': passwordValidations.hasUppercase}"
                  role="listitem">
                <i class="fa auth-flow__requirement-icon"
                   [class.fa-times]="!passwordValidations.hasUppercase"
                   [class.fa-check]="passwordValidations.hasUppercase"
                   [attr.aria-label]="passwordValidations.hasUppercase ? 'Requirement met' : 'Requirement not met'"
                   aria-hidden="true"></i>
                <span>One uppercase letter</span>
                <span class="sr-only">{{ passwordValidations.hasUppercase ? 'met' : 'not met' }}</span>
              </li>
              <li class="auth-flow__requirement"
                  [ngClass]="{'auth-flow__requirement--valid': passwordValidations.hasLowercase}"
                  role="listitem">
                <i class="fa auth-flow__requirement-icon"
                   [class.fa-times]="!passwordValidations.hasLowercase"
                   [class.fa-check]="passwordValidations.hasLowercase"
                   [attr.aria-label]="passwordValidations.hasLowercase ? 'Requirement met' : 'Requirement not met'"
                   aria-hidden="true"></i>
                <span>One lowercase letter</span>
                <span class="sr-only">{{ passwordValidations.hasLowercase ? 'met' : 'not met' }}</span>
              </li>
              <li class="auth-flow__requirement"
                  [ngClass]="{'auth-flow__requirement--valid': passwordValidations.hasNumber}"
                  role="listitem">
                <i class="fa auth-flow__requirement-icon"
                   [class.fa-times]="!passwordValidations.hasNumber"
                   [class.fa-check]="passwordValidations.hasNumber"
                   [attr.aria-label]="passwordValidations.hasNumber ? 'Requirement met' : 'Requirement not met'"
                   aria-hidden="true"></i>
                <span>One number</span>
                <span class="sr-only">{{ passwordValidations.hasNumber ? 'met' : 'not met' }}</span>
              </li>
              <li class="auth-flow__requirement"
                  [ngClass]="{'auth-flow__requirement--valid': passwordValidations.hasSpecial}"
                  role="listitem">
                <i class="fa auth-flow__requirement-icon"
                   [class.fa-times]="!passwordValidations.hasSpecial"
                   [class.fa-check]="passwordValidations.hasSpecial"
                   [attr.aria-label]="passwordValidations.hasSpecial ? 'Requirement met' : 'Requirement not met'"
                   aria-hidden="true"></i>
                <span>One special character (!&#64;#$%^&*)</span>
                <span class="sr-only">{{ passwordValidations.hasSpecial ? 'met' : 'not met' }}</span>
              </li>
            </ul>
          </div>
        </div>
      </div>

      <!-- Email Confirm Step -->
      <div class="auth-flow__form-step"
           [ngClass]="{'auth-flow__form-step--active': state.currentStep === authSteps.EMAIL_VERIFY}">
        <div class="auth-flow__verification-info" role="status" aria-live="polite">
          <p>Enter the 6-digit verification code sent to your email.</p>
        </div>
        <div class="auth-flow__input-group">
          <label for="email-code-input" class="auth-flow__label">
            Email Verification Code <span class="auth-flow__required" aria-label="required">*</span>
          </label>
          <div class="auth-flow__input-group-container">
            <input type="text"
                   id="email-code-input"
                   formControlName="emailCode"
                   class="auth-flow__input-group-field"
                   [ngClass]="{
                     'auth-flow__input-group-field--error': shouldShowFieldError('emailCode'),
                     'auth-flow__input-group-field--valid': getFieldValidationStatus('emailCode') === 'valid',
                     'auth-flow__input-group-field--pending': getFieldValidationStatus('emailCode') === 'pending'
                   }"
                   placeholder="Enter 6-digit verification code"
                   aria-describedby="email-code-error email-code-status"
                   [attr.aria-invalid]="shouldShowFieldError('emailCode')"
                   aria-required="true"
                   inputmode="numeric"
                   pattern="[0-9]{6}"
                   maxlength="6"
                   (focus)="onFieldFocus('emailCode')"
                   (blur)="onFieldBlur('emailCode')">
            <div id="email-code-status" 
                 class="auth-flow__validation-status"
                 [ngClass]="{
                   'auth-flow__validation-status--pending': getFieldValidationStatus('emailCode') === 'pending'
                 }"
                 *ngIf="getFieldValidationStatus('emailCode') === 'pending' && !shouldShowFieldError('emailCode')"
                 aria-live="polite">
              <span *ngIf="getFieldValidationStatus('emailCode') === 'valid'" class="sr-only">Code format is valid</span>
            </div>
            
            <div *ngIf="shouldShowFieldError('emailCode')" 
                 id="email-code-error" 
                 class="auth-flow__input-error" 
                 role="alert" 
                 aria-live="polite">
              <i class="fa fa-exclamation-circle auth-flow__error-icon" aria-hidden="true"></i>
              <span class="sr-only">Error: </span>{{ getErrorMessage('emailCode') }}
            </div>
          </div>
        </div>
      </div>

      <!-- Register Step -->
      <div class="auth-flow__form-step"
           [ngClass]="{'auth-flow__form-step--active': state.currentStep === authSteps.NAME_SETUP}">
        <div class="auth-flow__verification-info" role="status" aria-live="polite">
          <p>Enter your legal name as it appears on your ID.</p>
        </div>
        <div class="auth-flow__input-group">
          <label for="first-name-input" class="auth-flow__label">
            First Name <span class="auth-flow__required" aria-label="required">*</span>
          </label>
          <div class="auth-flow__input-group-container">
            <input type="text"
                   id="first-name-input"
                   formControlName="firstName"
                   class="auth-flow__input-group-field"
                   [ngClass]="{
                     'auth-flow__input-group-field--error': shouldShowFieldError('firstName'),
                     'auth-flow__input-group-field--valid': getFieldValidationStatus('firstName') === 'valid',
                     'auth-flow__input-group-field--pending': getFieldValidationStatus('firstName') === 'pending'
                   }"
                   placeholder="Enter your first name"
                   aria-describedby="first-name-error first-name-status"
                   [attr.aria-invalid]="shouldShowFieldError('firstName')"
                   aria-required="true"
                   autocomplete="given-name"
                   (focus)="onFieldFocus('firstName')"
                   (blur)="onFieldBlur('firstName')">
            <div id="first-name-status" 
                 class="auth-flow__validation-status"
                 [ngClass]="{
                   'auth-flow__validation-status--pending': getFieldValidationStatus('firstName') === 'pending'
                 }"
                 *ngIf="getFieldValidationStatus('firstName') === 'pending' && !shouldShowFieldError('firstName')"
                 aria-live="polite">
              <i *ngIf="getFieldValidationStatus('firstName') === 'valid'" 
                 class="fa fa-check auth-flow__validation-icon" 
                 aria-hidden="true"></i>
              <span *ngIf="getFieldValidationStatus('firstName') === 'valid'" class="sr-only">First name is valid</span>
            </div>
            
            <div *ngIf="shouldShowFieldError('firstName')" 
                 id="first-name-error" 
                 class="auth-flow__input-error" 
                 role="alert" 
                 aria-live="polite">
              <i class="fa fa-exclamation-circle auth-flow__error-icon" aria-hidden="true"></i>
              <span class="sr-only">Error: </span>{{ getErrorMessage('firstName') }}
            </div>
          </div>
        </div>
        <div class="auth-flow__input-group">
          <label for="last-name-input" class="auth-flow__label">
            Last Name <span class="auth-flow__required" aria-label="required">*</span>
          </label>
          <div class="auth-flow__input-group-container">
            <input type="text"
                   id="last-name-input"
                   formControlName="lastName"
                   class="auth-flow__input-group-field"
                   [ngClass]="{
                     'auth-flow__input-group-field--error': shouldShowFieldError('lastName'),
                     'auth-flow__input-group-field--valid': getFieldValidationStatus('lastName') === 'valid',
                     'auth-flow__input-group-field--pending': getFieldValidationStatus('lastName') === 'pending'
                   }"
                   placeholder="Enter your last name"
                   aria-describedby="last-name-error last-name-status"
                   [attr.aria-invalid]="shouldShowFieldError('lastName')"
                   aria-required="true"
                   autocomplete="family-name"
                   (focus)="onFieldFocus('lastName')"
                   (blur)="onFieldBlur('lastName')">
            <div id="last-name-status" 
                 class="auth-flow__validation-status"
                 [ngClass]="{
                   'auth-flow__validation-status--pending': getFieldValidationStatus('lastName') === 'pending'
                 }"
                 *ngIf="getFieldValidationStatus('lastName') === 'pending' && !shouldShowFieldError('lastName')"
                 aria-live="polite">
              <i *ngIf="getFieldValidationStatus('lastName') === 'valid'" 
                 class="fa fa-check auth-flow__validation-icon" 
                 aria-hidden="true"></i>
              <span *ngIf="getFieldValidationStatus('lastName') === 'valid'" class="sr-only">Last name is valid</span>
            </div>
            
            <div *ngIf="shouldShowFieldError('lastName')" 
                 id="last-name-error" 
                 class="auth-flow__input-error" 
                 role="alert" 
                 aria-live="polite">
              <i class="fa fa-exclamation-circle auth-flow__error-icon" aria-hidden="true"></i>
              <span class="sr-only">Error: </span>{{ getErrorMessage('lastName') }}
            </div>
          </div>
        </div>
      </div>

      <!-- Phone Setup Step -->
      <div class="auth-flow__form-step"
           [ngClass]="{'auth-flow__form-step--active': state.currentStep === authSteps.PHONE_SETUP}">
        <div class="auth-flow__verification-info" role="status" aria-live="polite">
          <p>Enter your phone number with country code (e.g., +1 for US).</p>
        </div>
        <div class="auth-flow__input-group">
          <label for="phone-input" class="auth-flow__label">
            Phone Number <span class="auth-flow__required" aria-label="required">*</span>
          </label>
          <div class="auth-flow__input-group-container">
            <input type="tel"
                   id="phone-input"
                   formControlName="phoneNumber"
                   class="auth-flow__input-group-field"
                   [ngClass]="{
                     'auth-flow__input-group-field--error': shouldShowFieldError('phoneNumber'),
                     'auth-flow__input-group-field--valid': getFieldValidationStatus('phoneNumber') === 'valid',
                     'auth-flow__input-group-field--pending': getFieldValidationStatus('phoneNumber') === 'pending'
                   }"
                   placeholder="+1 (555) 123-4567"
                   aria-describedby="phone-error phone-status"
                   [attr.aria-invalid]="shouldShowFieldError('phoneNumber')"
                   aria-required="true"
                   autocomplete="tel"
                   (focus)="onFieldFocus('phoneNumber')"
                   (blur)="onFieldBlur('phoneNumber')">
            <div id="phone-status" 
                 class="auth-flow__validation-status"
                 [ngClass]="{
                   'auth-flow__validation-status--pending': getFieldValidationStatus('phoneNumber') === 'pending'
                 }"
                 *ngIf="getFieldValidationStatus('phoneNumber') === 'pending' && !shouldShowFieldError('phoneNumber')"
                 aria-live="polite">
              <i *ngIf="getFieldValidationStatus('phoneNumber') === 'valid'" 
                 class="fa fa-check auth-flow__validation-icon" 
                 aria-hidden="true"></i>
              <span *ngIf="getFieldValidationStatus('phoneNumber') === 'valid'" class="sr-only">Phone number is valid</span>
            </div>
            
            <div *ngIf="shouldShowFieldError('phoneNumber')" 
                 id="phone-error" 
                 class="auth-flow__input-error" 
                 role="alert" 
                 aria-live="polite">
              <i class="fa fa-exclamation-circle auth-flow__error-icon" aria-hidden="true"></i>
              <span class="sr-only">Error: </span>{{ getErrorMessage('phoneNumber') }}
            </div>
          </div>
        </div>
      </div>

      <!-- Phone Verify Step -->
      <div class="auth-flow__form-step"
           [ngClass]="{'auth-flow__form-step--active': state.currentStep === authSteps.PHONE_VERIFY}">
        <div class="auth-flow__verification-info" role="status" aria-live="polite">
          <p>A verification code has been sent to your phone number.</p>
          <p>Please enter the 6-digit code below to verify your phone.</p>
        </div>
        <div class="auth-flow__input-group">
          <label for="phone-code-input" class="auth-flow__label">
            Phone Verification Code <span class="auth-flow__required" aria-label="required">*</span>
          </label>
          <div class="auth-flow__input-group-container">
            <input type="text"
                   id="phone-code-input"
                   formControlName="phoneCode"
                   class="auth-flow__input-group-field"
                   [ngClass]="{
                     'auth-flow__input-group-field--error': shouldShowFieldError('phoneCode'),
                     'auth-flow__input-group-field--valid': getFieldValidationStatus('phoneCode') === 'valid',
                     'auth-flow__input-group-field--pending': getFieldValidationStatus('phoneCode') === 'pending'
                   }"
                   placeholder="Enter 6-digit verification code"
                   aria-describedby="phone-code-error phone-code-status"
                   [attr.aria-invalid]="shouldShowFieldError('phoneCode')"
                   aria-required="true"
                   inputmode="numeric"
                   pattern="[0-9]{6}"
                   maxlength="6"
                   (focus)="onFieldFocus('phoneCode')"
                   (blur)="onFieldBlur('phoneCode')">
            <div id="phone-code-status" 
                 class="auth-flow__validation-status"
                 [ngClass]="{
                   'auth-flow__validation-status--pending': getFieldValidationStatus('phoneCode') === 'pending'
                 }"
                 *ngIf="getFieldValidationStatus('phoneCode') === 'pending' && !shouldShowFieldError('phoneCode')"
                 aria-live="polite">
              <i *ngIf="getFieldValidationStatus('phoneCode') === 'valid'" 
                 class="fa fa-check auth-flow__validation-icon" 
                 aria-hidden="true"></i>
              <span *ngIf="getFieldValidationStatus('phoneCode') === 'valid'" class="sr-only">Code format is valid</span>
            </div>
            
            <div *ngIf="shouldShowFieldError('phoneCode')" 
                 id="phone-code-error" 
                 class="auth-flow__input-error" 
                 role="alert" 
                 aria-live="polite">
              <i class="fa fa-exclamation-circle auth-flow__error-icon" aria-hidden="true"></i>
              <span class="sr-only">Error: </span>{{ getErrorMessage('phoneCode') }}
            </div>
          </div>
        </div>
        <div class="auth-flow__resend-code">
          <button type="button" 
                  class="auth-flow__text-button" 
                  (click)="resendVerificationCode(); triggerHapticFeedback('light')"
                  aria-describedby="resend-help">
            {{ isTouchDevice ? 'Resend Code' : 'Didn\'t receive a code? Send again' }}
          </button>
          <div id="resend-help" class="auth-flow__help-text sr-only">
            Click to resend the verification code to your phone number
          </div>
        </div>
      </div>

      <!-- MFA Setup Step -->
      <div class="auth-flow__form-step"
           [ngClass]="{'auth-flow__form-step--active': state.currentStep === authSteps.MFA_SETUP}">
        <div class="auth-flow__mfa-options" *ngIf="state.mfaSetupDetails" role="region" aria-labelledby="mfa-setup-title">
          <h2 id="mfa-setup-title" class="auth-flow__mfa-title">Set Up Two-Factor Authentication</h2>
          <div class="auth-flow__instructions" role="status" aria-live="polite">
            <p>Scan this QR code with your authenticator app (Google Authenticator, Authy, etc.)</p>
            <p>This will be registered using your email address in your authenticator app.</p>
          </div>
          <!-- Enhanced QR Code with Skeleton Loading -->
          <div class="auth-flow__qr-container" 
               [ngClass]="{'auth-flow__qr-container--loading': qrCodeLoading || skeletonStates.qrCode}">
            
            <!-- QR Code Skeleton -->
            <div *ngIf="qrCodeLoading || skeletonStates.qrCode" 
                 class="auth-flow__skeleton auth-flow__skeleton--qr-code"
                 role="status"
                 aria-live="polite"
                 aria-label="Loading QR code for authentication setup">
            </div>
            
            <!-- Actual QR Code -->
            <div *ngIf="qrCodeDataUrl && !qrCodeLoading && !skeletonStates.qrCode" 
                 role="img" 
                 aria-labelledby="qr-description">
              <img [src]="qrCodeDataUrl" 
                   alt="QR code for setting up two-factor authentication. Contains setup information for your authenticator app." 
                   class="qr-code"
                   aria-describedby="qr-help">
              <div id="qr-description" class="sr-only">
                QR code containing setup information for two-factor authentication
              </div>
              <div id="qr-help" class="auth-flow__help-text">
                Use your authenticator app to scan this QR code
              </div>
            </div>
            
            <!-- Loading message for QR code -->
            <div *ngIf="qrCodeLoading" 
                 class="auth-flow__qr-loading-text"
                 aria-live="polite">
              Generating your authentication QR code...
            </div>
          </div>
          <div class="auth-flow__secret-key" *ngIf="state.mfaSetupDetails.secretKey" role="region" aria-labelledby="secret-key-title">
            <h3 id="secret-key-title" class="auth-flow__secret-title">Manual Setup</h3>
            <div class="secret-key" role="text" aria-labelledby="secret-key-label">
              <label id="secret-key-label" for="secret-key-text">Secret Key:</label>
              <span id="secret-key-text" aria-describedby="secret-key-instructions">{{ state.mfaSetupDetails.secretKey }}</span>
            </div>
            <p id="secret-key-instructions" class="instructions">
              Enter this secret key into your authenticator app if you cannot scan the QR code.
            </p>
          </div>
          <div class="auth-flow__input-group">
            <label for="mfa-setup-input" class="auth-flow__label">
              Authenticator Code <span class="auth-flow__required" aria-label="required">*</span>
            </label>
            <div class="auth-flow__input-group-container">
              <input type="text"
                     id="mfa-setup-input"
                     formControlName="mfaCode"
                     class="auth-flow__input-group-field"
                     [ngClass]="{
                       'auth-flow__input-group-field--error': shouldShowFieldError('mfaCode'),
                       'auth-flow__input-group-field--valid': getFieldValidationStatus('mfaCode') === 'valid',
                       'auth-flow__input-group-field--pending': getFieldValidationStatus('mfaCode') === 'pending'
                     }"
                     placeholder="Enter 6-digit code from app"
                     aria-describedby="mfa-setup-error mfa-setup-status"
                     [attr.aria-invalid]="shouldShowFieldError('mfaCode')"
                     aria-required="true"
                     inputmode="numeric"
                     pattern="[0-9]{6}"
                     maxlength="6"
                     (focus)="onFieldFocus('mfaCode')"
                     (blur)="onFieldBlur('mfaCode')">
              <div id="mfa-setup-status" 
                   class="auth-flow__validation-status"
                   [ngClass]="{
                     'auth-flow__validation-status--pending': getFieldValidationStatus('mfaCode') === 'pending'
                   }"
                   *ngIf="getFieldValidationStatus('mfaCode') === 'pending' && !shouldShowFieldError('mfaCode')"
                   aria-live="polite">
                <i *ngIf="getFieldValidationStatus('mfaCode') === 'valid'" 
                   class="fa fa-check auth-flow__validation-icon" 
                   aria-hidden="true"></i>
                <span *ngIf="getFieldValidationStatus('mfaCode') === 'valid'" class="sr-only">Code format is valid</span>
              </div>
              
              <div *ngIf="shouldShowFieldError('mfaCode')" 
                   id="mfa-setup-error" 
                   class="auth-flow__input-error" 
                   role="alert" 
                   aria-live="polite">
                <i class="fa fa-exclamation-circle auth-flow__error-icon" aria-hidden="true"></i>
                <span class="sr-only">Error: </span>{{ getErrorMessage('mfaCode') }}
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- MFA Verification Step -->
      <div class="auth-flow__form-step"
           [ngClass]="{'auth-flow__form-step--active': state.currentStep === authSteps.MFA_VERIFY}">
        <div class="auth-flow__verification-info" role="status" aria-live="polite">
          <p>Please enter the 6-digit code from your authenticator app to complete sign in.</p>
        </div>
        <div class="auth-flow__input-group">
          <label for="mfa-verify-input" class="auth-flow__label">
            Authenticator Code <span class="auth-flow__required" aria-label="required">*</span>
          </label>
          <div class="auth-flow__input-group-container">
            <input type="text"
                   id="mfa-verify-input"
                   formControlName="mfaCode"
                   class="auth-flow__input-group-field"
                   [ngClass]="{
                     'auth-flow__input-group-field--error': shouldShowFieldError('mfaCode'),
                     'auth-flow__input-group-field--valid': getFieldValidationStatus('mfaCode') === 'valid',
                     'auth-flow__input-group-field--pending': getFieldValidationStatus('mfaCode') === 'pending'
                   }"
                   placeholder="Enter 6-digit code from app"
                   aria-describedby="mfa-verify-error mfa-verify-status"
                   [attr.aria-invalid]="shouldShowFieldError('mfaCode')"
                   aria-required="true"
                   inputmode="numeric"
                   pattern="[0-9]{6}"
                   maxlength="6"
                   (focus)="onFieldFocus('mfaCode')"
                   (blur)="onFieldBlur('mfaCode')">
            <div id="mfa-verify-status" 
                 class="auth-flow__validation-status"
                 [ngClass]="{
                   'auth-flow__validation-status--pending': getFieldValidationStatus('mfaCode') === 'pending'
                 }"
                 *ngIf="getFieldValidationStatus('mfaCode') === 'pending' && !shouldShowFieldError('mfaCode')"
                 aria-live="polite">
              <i *ngIf="getFieldValidationStatus('mfaCode') === 'valid'" 
                 class="fa fa-check auth-flow__validation-icon" 
                 aria-hidden="true"></i>
              <span *ngIf="getFieldValidationStatus('mfaCode') === 'valid'" class="sr-only">Code format is valid</span>
            </div>
            
            <div *ngIf="shouldShowFieldError('mfaCode')" 
                 id="mfa-verify-error" 
                 class="auth-flow__input-error" 
                 role="alert" 
                 aria-live="polite">
              <i class="fa fa-exclamation-circle auth-flow__error-icon" aria-hidden="true"></i>
              <span class="sr-only">Error: </span>{{ getErrorMessage('mfaCode') }}
            </div>
          </div>
        </div>
      </div>

      <!-- Enhanced Submit Button with Progress -->
      <button type="submit"
              class="auth-flow__button"
              [disabled]="!authForm.valid || state.isLoading"
              [ngClass]="{
                'auth-flow__button--loading': state.isLoading,
                'auth-flow__button--progress': buttonProgress > 0 && buttonProgress < 100
              }"
              [style.--progress]="buttonProgress + '%'"
              [attr.aria-label]="state.isLoading ? 'Processing, please wait' : getResponsiveButtonText(state.buttonText || '')"
              [attr.aria-describedby]="state.isLoading ? 'loading-status' : null"
              (click)="triggerHapticFeedback('medium')">
        
        <!-- Button text -->
        <span *ngIf="!state.isLoading && buttonProgress === 0">
          {{ getResponsiveButtonText(state.buttonText || '') }}
        </span>
        
        <!-- Progress text -->
        <span *ngIf="buttonProgress > 0 && buttonProgress < 100" 
              class="auth-flow__button-progress-text">
          {{ buttonProgress }}% Complete
        </span>
        
        <!-- Loading spinner -->
        <div class="auth-flow__button-loader" 
             *ngIf="state.isLoading && buttonProgress === 0" 
             role="status" 
             aria-hidden="true"></div>
             
        <!-- Loading status for screen readers -->
        <span id="loading-status" 
              class="sr-only" 
              *ngIf="state.isLoading" 
              aria-live="polite">
          <span *ngIf="buttonProgress === 0">Processing your request, please wait</span>
          <span *ngIf="buttonProgress > 0">{{ buttonProgress }}% complete</span>
        </span>
      </button>
      
      <!-- Form Footer Actions -->
      <div class="auth-flow__form-footer">
        <button *ngIf="canNavigateBack()" 
                type="button" 
                class="auth-flow__back-button"
                (click)="navigateBack(); triggerHapticFeedback('light')"
                aria-label="Go back to previous step"
                [attr.aria-describedby]="'back-help'">
          <i class="fa fa-arrow-left" aria-hidden="true"></i>
          <span>{{ isTouchDevice ? 'Back' : 'Back' }}</span>
        </button>
        
        <button type="button" 
                class="auth-flow__start-over-button"
                (click)="startOver(); triggerHapticFeedback('medium')"
                aria-label="Start authentication process over"
                [attr.aria-describedby]="'start-over-help'">
          <i class="fa fa-refresh" aria-hidden="true"></i>
          <span>{{ isTouchDevice ? 'Reset' : 'Start Over' }}</span>
        </button>
        
        <div id="back-help" class="sr-only">
          Return to the previous step in the authentication process
        </div>
        <div id="start-over-help" class="sr-only">
          Clear all progress and restart the authentication process from the beginning
        </div>
      </div>
    </form>
    </main>
  </ng-container>
</div> <!-- Close normal auth flow -->

<!-- Add this after your form in auth-flow.component.html -->
<ng-container *ngIf="debugMode$ | async">
  <div class="auth-flow__debug">
    <h3 class="auth-flow__debug-title">Debug Information</h3>

    <div class="auth-flow__debug-section">
      <h4>Form State</h4>
      <pre>Form Valid: {{ authForm.valid }}</pre>
      <pre>Form Pristine: {{ authForm.pristine }}</pre>
      <pre>Form Touched: {{ authForm.touched }}</pre>
      <pre>Form Values: {{ authForm.value | json }}</pre>
      <pre>Form Errors: {{ authForm.errors | json }}</pre>
      <pre>Button Disabled: {{ !authForm.valid }}</pre>
    </div>

    <div class="auth-flow__debug-section">
      <h4>Current Store State</h4>
      <ng-container *ngIf="{
        currentStep: currentStep$ | async,
        isLoading: isLoading$ | async,
        error: error$ | async,
        userExists: userExists$ | async,
        currentUser: currentUser$ | async,
        needsMFA: needsMFA$ | async,
        phoneVerified: phoneVerified$ | async,
        emailVerified: emailVerified$ | async,
        mfaSetupDetails: mfaSetupDetails$ | async
      } as state">
        <pre>Current Step: {{ state.currentStep }}</pre>
        <pre>Is Loading: {{ state.isLoading }}</pre>
        <pre>Error: {{ state.error }}</pre>
        <pre>User Exists: {{ state.userExists }}</pre>
        <pre>Current User: {{ state.currentUser | json }}</pre>
        <pre>User Is Valid: {{ state.currentUser ? (isUserValid(state.currentUser) | json) : 'N/A' }}</pre>
        <pre>Needs MFA: {{ state.needsMFA }}</pre>
        <pre>MFA Setup Details: {{ state.mfaSetupDetails | json }}</pre>
        <pre>Phone Verified: {{ state.phoneVerified }}</pre>
        <pre>Email Verified: {{ state.emailVerified }}</pre>
      </ng-container>
    </div>

    <div class="auth-flow__debug-section">
      <h4>Button State</h4>
      <pre>Button Disabled: {{ !authForm.valid }}</pre>
      <pre>Is Loading: {{ isLoading$ | async }}</pre>
    </div>
  </div>
</ng-container>
