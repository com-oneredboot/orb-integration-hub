# API Documentation

## Overview

The Orb Integration Hub exposes a GraphQL API through AWS AppSync. The API provides CRUD operations for managing users, organizations, applications, roles, notifications, privacy requests, and ownership transfers.

All operations are auto-generated by `orb-schema-generator` from YAML schema definitions in `schemas/tables/`.

## Authentication

All API operations require Cognito User Pool authentication with group-based authorization:

| Group | Description |
|-------|-------------|
| USER | Basic authenticated user |
| CUSTOMER | Customer-level access |
| EMPLOYEE | Internal employee access |
| OWNER | Full administrative access |

Operations specify required groups via the `@aws_auth` directive.

### Public Operations (API Key Authentication)

Some operations are accessible without user authentication using API key:

| Operation | Description |
|-----------|-------------|
| `CheckEmailExists` | Check if an email exists in the system |
| `CreateUserFromCognito` | Create user record from Cognito data during self-registration |

## Public Queries

### CheckEmailExists

Check if an email address exists in the system. This is a Lambda-backed query that uses API key authentication, allowing unauthenticated users to check email existence during the authentication flow.

**Authentication**: API Key (`@aws_api_key`)

**Input**:
```graphql
input CheckEmailExistsInput {
  email: String!
}
```

**Output**:
```graphql
type CheckEmailExists {
  email: String!
  exists: Boolean!
}
```

**Example**:
```graphql
query {
  CheckEmailExists(input: { email: "user@example.com" }) {
    email
    exists
  }
}
```

**Error Responses**:

| Error Code | Message | Description |
|------------|---------|-------------|
| ORB-AUTH-007 | Invalid email format | Email doesn't match expected format |
| ORB-API-005 | Email check service unavailable | Backend service error |

**Security Notes**:
- Returns only boolean existence status (no user data exposed)
- Email format validated before database query
- All requests logged for security audit

## Public Mutations

### CreateUserFromCognito

Create a user record in DynamoDB from Cognito data during self-registration. This is a secure, Lambda-backed mutation that validates against Cognito before creating records. Only accepts `cognitoSub` as input and extracts all user data from Cognito to prevent client-side data injection.

**Authentication**: API Key (`@aws_api_key`)

**Input**:
```graphql
input CreateUserFromCognitoInput {
  cognitoSub: String!
}
```

**Output**:
```graphql
type CreateUserFromCognito {
  cognitoSub: String!
  userId: String
  email: String
  firstName: String
  lastName: String
  status: String
  emailVerified: Boolean
  phoneVerified: Boolean
  mfaEnabled: Boolean
  mfaSetupComplete: Boolean
  groups: [String]
  createdAt: AWSTimestamp
  updatedAt: AWSTimestamp
}
```

**Example**:
```graphql
mutation {
  CreateUserFromCognito(input: { cognitoSub: "550e8400-e29b-41d4-a716-446655440000" }) {
    userId
    email
    firstName
    lastName
    status
    groups
  }
}
```

**Error Responses**:

| Error Code | Message | Description |
|------------|---------|-------------|
| ORB-AUTH-010 | Authentication service unavailable | Cognito service error |
| ORB-AUTH-011 | Invalid request format | cognitoSub is not a valid UUID |
| ORB-AUTH-012 | User not found | User doesn't exist in Cognito |
| ORB-API-010 | Database service unavailable | DynamoDB service error |

**Security Notes**:
- Only accepts `cognitoSub` as input - all other user data is extracted from Cognito
- Validates user exists in Cognito before creating DynamoDB record
- Idempotent - returns existing user if already created
- Timing attack prevention via consistent response times
- Error messages don't expose internal details or PII

**Use Case**:
This mutation is used during the self-registration flow after MFA verification. The frontend calls this mutation with the user's Cognito sub to create the corresponding DynamoDB record. This approach:
1. Prevents client-side data injection (all data comes from Cognito)
2. Ensures user exists in Cognito before creating DynamoDB record
3. Provides idempotency for retry scenarios

## Generated Operations

The schema contains 99 operations across 11 entities. Operations follow a consistent naming pattern:
- Queries: `{Entity}QueryBy{Key}` or `{Entity}QueryBy{Key}And{SortKey}`
- Mutations: `{Entity}Create`, `{Entity}Update`, `{Entity}Delete`, `{Entity}Disable`

### Users

**Queries** (Groups: CUSTOMER, EMPLOYEE, OWNER, USER):
- `UsersQueryByUserId(input: UsersQueryByUserIdInput!): UsersResponse`
- `UsersQueryByEmail(input: UsersQueryByEmailInput!): UsersResponse`
- `UsersQueryByCognitoId(input: UsersQueryByCognitoIdInput!): UsersResponse`
- `UsersQueryByCognitoSub(input: UsersQueryByCognitoSubInput!): UsersResponse`

**Mutations**:
- `UsersCreate(input: UsersCreateInput!): UsersResponse` (Groups: EMPLOYEE, OWNER) - Admin user creation
- `UsersUpdate(input: UsersUpdateInput!): UsersResponse` (Groups: EMPLOYEE, OWNER, or API Key)
- `UsersDelete(input: UsersDeleteInput!): UsersResponse` (Groups: EMPLOYEE, OWNER)
- `UsersDisable(input: UsersDisableInput!): UsersResponse` (Groups: EMPLOYEE, OWNER)

**Note**: For self-registration, use `CreateUserFromCognito` mutation instead of `UsersCreate`. The `UsersCreate` mutation is restricted to admin operations (EMPLOYEE, OWNER groups).

### Organizations

**Queries** (Groups: CUSTOMER, EMPLOYEE, OWNER):
- `OrganizationsQueryByOrganizationId(input: OrganizationsQueryByOrganizationIdInput!): OrganizationsResponse`
- `OrganizationsQueryByOwnerId(input: OrganizationsQueryByOwnerIdInput!): OrganizationsResponse`
- `OrganizationsQueryByOwnerIdAndCreatedAt(input: OrganizationsQueryByOwnerIdAndCreatedAtInput!): OrganizationsResponse`
- `OrganizationsQueryByStatus(input: OrganizationsQueryByStatusInput!): OrganizationsResponse`
- `OrganizationsQueryByStatusAndCreatedAt(input: OrganizationsQueryByStatusAndCreatedAtInput!): OrganizationsResponse`

**Mutations** (Groups: CUSTOMER, EMPLOYEE, OWNER):
- `OrganizationsCreate(input: OrganizationsCreateInput!): OrganizationsResponse`
- `OrganizationsUpdate(input: OrganizationsUpdateInput!): OrganizationsResponse`
- `OrganizationsDelete(input: OrganizationsDeleteInput!): OrganizationsResponse`
- `OrganizationsDisable(input: OrganizationsDisableInput!): OrganizationsResponse`

### Applications

**Queries** (Groups: CUSTOMER, EMPLOYEE, OWNER):
- `ApplicationsQueryByApplicationId(input: ApplicationsQueryByApplicationIdInput!): ApplicationsResponse`
- `ApplicationsQueryByOrganizationId(input: ApplicationsQueryByOrganizationIdInput!): ApplicationsResponse`
- `ApplicationsQueryByOrganizationIdAndCreatedAt(input: ApplicationsQueryByOrganizationIdAndCreatedAtInput!): ApplicationsResponse`

**Mutations** (Groups: CUSTOMER, EMPLOYEE, OWNER):
- `ApplicationsCreate(input: ApplicationsCreateInput!): ApplicationsResponse`
- `ApplicationsUpdate(input: ApplicationsUpdateInput!): ApplicationsResponse`
- `ApplicationsDelete(input: ApplicationsDeleteInput!): ApplicationsResponse`
- `ApplicationsDisable(input: ApplicationsDisableInput!): ApplicationsResponse`

### Organization Users

**Queries** (Groups: CUSTOMER, EMPLOYEE, OWNER):
- `OrganizationUsersQueryByUserId(input: OrganizationUsersQueryByUserIdInput!): OrganizationUsersResponse`
- `OrganizationUsersQueryByOrganizationId(input: OrganizationUsersQueryByOrganizationIdInput!): OrganizationUsersResponse`
- `OrganizationUsersQueryByUserIdAndOrganizationId(input: OrganizationUsersQueryByUserIdAndOrganizationIdInput!): OrganizationUsersResponse`
- `OrganizationUsersQueryByOrganizationIdAndRole(input: OrganizationUsersQueryByOrganizationIdAndRoleInput!): OrganizationUsersResponse`
- `OrganizationUsersQueryByUserIdAndRole(input: OrganizationUsersQueryByUserIdAndRoleInput!): OrganizationUsersResponse`

**Mutations** (Groups: CUSTOMER, EMPLOYEE, OWNER):
- `OrganizationUsersCreate(input: OrganizationUsersCreateInput!): OrganizationUsersResponse`
- `OrganizationUsersUpdate(input: OrganizationUsersUpdateInput!): OrganizationUsersResponse`
- `OrganizationUsersDelete(input: OrganizationUsersDeleteInput!): OrganizationUsersResponse`
- `OrganizationUsersDisable(input: OrganizationUsersDisableInput!): OrganizationUsersResponse`

### Notifications

**Queries** (Groups: CUSTOMER, EMPLOYEE, OWNER):
- `NotificationsQueryByNotificationId(input: NotificationsQueryByNotificationIdInput!): NotificationsResponse`
- `NotificationsQueryByRecipientUserId(input: NotificationsQueryByRecipientUserIdInput!): NotificationsResponse`
- `NotificationsQueryByRecipientUserIdAndCreatedAt(input: NotificationsQueryByRecipientUserIdAndCreatedAtInput!): NotificationsResponse`
- `NotificationsQueryByType(input: NotificationsQueryByTypeInput!): NotificationsResponse`
- `NotificationsQueryByTypeAndStatus(input: NotificationsQueryByTypeAndStatusInput!): NotificationsResponse`

**Mutations** (Groups: CUSTOMER, EMPLOYEE, OWNER):
- `NotificationsCreate(input: NotificationsCreateInput!): NotificationsResponse`
- `NotificationsUpdate(input: NotificationsUpdateInput!): NotificationsResponse`
- `NotificationsDelete(input: NotificationsDeleteInput!): NotificationsResponse`
- `NotificationsDisable(input: NotificationsDisableInput!): NotificationsResponse`

### Privacy Requests

**Queries** (Groups: EMPLOYEE, OWNER):
- `PrivacyRequestsQueryByRequestId(input: PrivacyRequestsQueryByRequestIdInput!): PrivacyRequestsResponse`
- `PrivacyRequestsQueryByRequestType(input: PrivacyRequestsQueryByRequestTypeInput!): PrivacyRequestsResponse`
- `PrivacyRequestsQueryByRequestTypeAndReceivedAt(input: PrivacyRequestsQueryByRequestTypeAndReceivedAtInput!): PrivacyRequestsResponse`
- `PrivacyRequestsQueryByDataSubjectEmail(input: PrivacyRequestsQueryByDataSubjectEmailInput!): PrivacyRequestsResponse`
- `PrivacyRequestsQueryByDataSubjectEmailAndReceivedAt(input: PrivacyRequestsQueryByDataSubjectEmailAndReceivedAtInput!): PrivacyRequestsResponse`
- `PrivacyRequestsQueryByOrganizationId(input: PrivacyRequestsQueryByOrganizationIdInput!): PrivacyRequestsResponse`
- `PrivacyRequestsQueryByOrganizationIdAndReceivedAt(input: PrivacyRequestsQueryByOrganizationIdAndReceivedAtInput!): PrivacyRequestsResponse`
- `PrivacyRequestsQueryByStatus(input: PrivacyRequestsQueryByStatusInput!): PrivacyRequestsResponse`
- `PrivacyRequestsQueryByStatusAndDeadline(input: PrivacyRequestsQueryByStatusAndDeadlineInput!): PrivacyRequestsResponse`

**Mutations** (Groups: EMPLOYEE, OWNER):
- `PrivacyRequestsCreate(input: PrivacyRequestsCreateInput!): PrivacyRequestsResponse`
- `PrivacyRequestsUpdate(input: PrivacyRequestsUpdateInput!): PrivacyRequestsResponse`
- `PrivacyRequestsDelete(input: PrivacyRequestsDeleteInput!): PrivacyRequestsResponse`
- `PrivacyRequestsDisable(input: PrivacyRequestsDisableInput!): PrivacyRequestsResponse`

### Ownership Transfer Requests

**Queries** (Groups: CUSTOMER, EMPLOYEE, OWNER):
- `OwnershipTransferRequestsQueryByTransferId(input: OwnershipTransferRequestsQueryByTransferIdInput!): OwnershipTransferRequestsResponse`
- `OwnershipTransferRequestsQueryByCurrentOwnerId(input: OwnershipTransferRequestsQueryByCurrentOwnerIdInput!): OwnershipTransferRequestsResponse`
- `OwnershipTransferRequestsQueryByCurrentOwnerIdAndCreatedAt(input: OwnershipTransferRequestsQueryByCurrentOwnerIdAndCreatedAtInput!): OwnershipTransferRequestsResponse`
- `OwnershipTransferRequestsQueryByNewOwnerId(input: OwnershipTransferRequestsQueryByNewOwnerIdInput!): OwnershipTransferRequestsResponse`
- `OwnershipTransferRequestsQueryByNewOwnerIdAndCreatedAt(input: OwnershipTransferRequestsQueryByNewOwnerIdAndCreatedAtInput!): OwnershipTransferRequestsResponse`
- `OwnershipTransferRequestsQueryByStatus(input: OwnershipTransferRequestsQueryByStatusInput!): OwnershipTransferRequestsResponse`
- `OwnershipTransferRequestsQueryByStatusAndCreatedAt(input: OwnershipTransferRequestsQueryByStatusAndCreatedAtInput!): OwnershipTransferRequestsResponse`
- `OwnershipTransferRequestsQueryByStatusAndExpiresAt(input: OwnershipTransferRequestsQueryByStatusAndExpiresAtInput!): OwnershipTransferRequestsResponse`

**Mutations** (Groups: CUSTOMER, EMPLOYEE, OWNER):
- `OwnershipTransferRequestsCreate(input: OwnershipTransferRequestsCreateInput!): OwnershipTransferRequestsResponse`
- `OwnershipTransferRequestsUpdate(input: OwnershipTransferRequestsUpdateInput!): OwnershipTransferRequestsResponse`
- `OwnershipTransferRequestsDelete(input: OwnershipTransferRequestsDeleteInput!): OwnershipTransferRequestsResponse`
- `OwnershipTransferRequestsDisable(input: OwnershipTransferRequestsDisableInput!): OwnershipTransferRequestsResponse`

### Additional Entities

See `apps/api/graphql/schema.graphql` for complete operations on:
- ApplicationUsers (OWNER only)
- ApplicationRoles (OWNER only)
- Roles (OWNER only)
- SmsRateLimit (OWNER, USER)

## Response Types

All operations return a paginated response:

```graphql
type UsersResponse {
  items: [Users!]
  nextToken: String
}
```

## Input Types

Query inputs include the key field(s) and pagination:

```graphql
input UsersQueryByEmailInput {
  email: String!
  limit: Int
  nextToken: String
}
```

Create/Update inputs include all entity fields:

```graphql
input UsersCreateInput {
  userId: String!
  cognitoId: String!
  email: String!
  firstName: String!
  lastName: String!
  status: UserStatus!
  # ... additional fields
}
```

## Error Handling

See [Error Handling Documentation](./error-handling.md) for detailed error codes and handling patterns.

## Schema Reference

The complete GraphQL schema is generated at `apps/api/graphql/schema.graphql`.

To regenerate after schema changes:
```bash
pipenv run orb-schema generate
```
