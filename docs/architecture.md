# Architecture

## Infrastructure Overview

orb-integration-hub uses AWS CDK (Cloud Development Kit) for infrastructure as code. All infrastructure is defined in Python and deployed via GitHub Actions.

### CDK Stack Structure

The infrastructure is organized into modular stacks with explicit dependencies:

```
infrastructure/cdk/
├── app.py                    # CDK app entry point
├── config.py                 # Configuration management
├── stacks/                   # Stack definitions
│   ├── bootstrap_stack.py    # S3 buckets, SQS queues, IAM
│   ├── cognito_stack.py      # User Pool, Identity Pool, groups
│   ├── dynamodb_stack.py     # All DynamoDB tables
│   ├── lambda_layers_stack.py # Lambda layers
│   ├── lambda_stack.py       # Lambda functions
│   ├── appsync_stack.py      # GraphQL API, data sources, resolvers
│   ├── monitoring_stack.py   # CloudWatch, alarms, GuardDuty
│   └── frontend_stack.py     # S3, CloudFront distribution
├── shared_constructs/        # Reusable constructs
└── generated/                # Auto-generated by orb-schema-generator
    ├── api.py                # AppSync API construct
    └── *_table.py            # DynamoDB table constructs
```

### Stack Dependencies

```
Bootstrap → Cognito → DynamoDB → Lambda Layers → Lambda → AppSync → Monitoring
                                                                  ↘ Frontend
```

### Deployment Workflows

- `deploy-infrastructure.yml` - Deploys all CDK stacks (synth/diff/deploy)
- `deploy-website.yml` - Builds Angular app and deploys to S3/CloudFront

## AppSync Monitoring & Observability

### CloudWatch Dashboard
A CloudWatch dashboard named `${CustomerId}-${ProjectId}-${Environment}-appsync-dashboard` is automatically created. It includes widgets for:
- **4XX/5XX Errors**: Tracks client and server errors for the AppSync API.
- **Latency & Integration Latency**: Shows end-to-end and backend integration latency.
- **Request Count**: Total number of GraphQL requests.
- **Throttled Requests**: Requests throttled due to rate limits.

Access the dashboard in AWS Console > CloudWatch > Dashboards.

### CloudWatch Alarms
The following alarms are set up for AppSync:
- **4XX Error Alarm**: Triggers if 5 or more client errors occur in a 5-minute window.
- **5XX Error Alarm**: Triggers if any server error occurs in a 5-minute window.
- **Latency Alarm**: Triggers if average latency exceeds 2 seconds in a 5-minute window.

Configure notification actions (e.g., SNS, email) as needed in the AWS Console.

### X-Ray Tracing
X-Ray tracing is enabled for the AppSync API. This allows you to trace requests end-to-end, including integration with DynamoDB and Lambda data sources. Use AWS X-Ray in the console to view traces, identify bottlenecks, and troubleshoot issues.

### Best Practices
- Monitor the dashboard regularly for spikes in errors or latency.
- Investigate and resolve alarms promptly.
- Use X-Ray traces to debug complex issues or performance bottlenecks. 