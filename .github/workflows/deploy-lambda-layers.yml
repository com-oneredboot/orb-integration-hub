name: deploy-lambda-layers

permissions:
  contents: read
  security-events: write

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        type: environment
      region:
        description: 'AWS Region'
        required: true
        type: choice
        options:
          - 'us-east-1'
      customer_id:
        description: 'Customer ID'
        required: true
        type: string
        default: 'orb'
      project_id:
        description: 'Project ID'
        required: true
        type: string
        default: 'integration-hub'

jobs:
  # First job: Check which layers have changed
  check-layer-changes:
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}
    outputs:
      layers_to_build: ${{ steps.check-changes.outputs.layers_to_build }}
      any_changes: ${{ steps.check-changes.outputs.any_changes }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Configure AWS Credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ inputs.region }}

    - name: Check Layer Changes
      id: check-changes
      run: |
        chmod +x check_layer_changes.sh
        ./check_layer_changes.sh ${{ inputs.customer_id }} ${{ inputs.project_id }}
      working-directory: backend/src/layers

  # Second job: Build and deploy only changed layers (individual stacks)
  deploy-individual-layers:
    needs: check-layer-changes
    if: needs.check-layer-changes.outputs.any_changes == 'true'
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}
    strategy:
      matrix:
        layer: ${{ fromJson(needs.check-layer-changes.outputs.layers_to_build) }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Set up Python 3.12
      uses: actions/setup-python@v4
      with:
        python-version: '3.12'

    - name: Install dependencies
      run: |
        pip install --upgrade pip
        pip install pipenv

    - name: Configure AWS Credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ secrets.AWS_REGION }}

    - name: Build ${{ matrix.layer }} Layer
      run: |
        echo "Building ${{ matrix.layer }} Layer"
        chmod +x build_layer.sh
        ./build_layer.sh ${{ matrix.layer }}
      working-directory: backend/src/layers

    - name: Deploy ${{ matrix.layer }} Layer
      run: |
        echo "Deploying ${{ matrix.layer }} layer individually"
        
        # Get the stack name for this specific layer
        # Using underscores in stack name to comply with CloudFormation naming rules
        LAYER_STACK_NAME="${{ inputs.customer_id }}-${{ inputs.project_id }}-${{ inputs.environment }}-${{ matrix.layer }}-layer"
        LAYER_STACK_NAME="${LAYER_STACK_NAME//_/-}"  # Replace underscores with hyphens
        
        # Get the template file name for this layer
        TEMPLATE_NAME="lambda-layer-${{ matrix.layer }}.yml"
        TEMPLATE_NAME="${TEMPLATE_NAME//_/-}"  # Replace underscores with hyphens
        
        echo "Using template: $TEMPLATE_NAME"
        
        # Build the layer
        sam build \
          --template-file $TEMPLATE_NAME
        
        # Package the layer
        sam package \
          --template-file .aws-sam/build/template.yaml \
          --s3-bucket ${{ inputs.customer_id }}-${{ inputs.project_id }}-build-artifacts \
          --s3-prefix sam-builds/layers \
          --output-template-file ${TEMPLATE_NAME%.yml}-packaged.yml
        
        # Deploy only this specific layer
        sam deploy \
          --template-file ${TEMPLATE_NAME%.yml}-packaged.yml \
          --s3-bucket ${{ inputs.customer_id }}-${{ inputs.project_id }}-build-artifacts \
          --stack-name $LAYER_STACK_NAME \
          --capabilities CAPABILITY_NAMED_IAM \
          --no-fail-on-empty-changeset \
          --parameter-overrides \
            LayerName=${{ matrix.layer }} \
            CustomerID=${{ inputs.customer_id }} \
            ProjectID=${{ inputs.project_id }} \
            Environment=${{ inputs.environment }}
        
        # Store the packaged template
        aws s3 cp ${TEMPLATE_NAME%.yml}-packaged.yml \
          s3://${{ inputs.customer_id }}-${{ inputs.project_id }}-build-artifacts/templates/layers/
        
      working-directory: infrastructure/cloudformation

  # Third job: Update hashes after successful deployment
  update-layer-hashes:
    needs: [check-layer-changes, deploy-individual-layers]
    if: needs.check-layer-changes.outputs.any_changes == 'true'
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Configure AWS Credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ secrets.AWS_REGION }}

    - name: Update Layer Hashes
      run: |
        chmod +x update_layer_hashes.sh
        ./update_layer_hashes.sh \
          ${{ inputs.customer_id }} \
          ${{ inputs.project_id }} \
          '${{ needs.check-layer-changes.outputs.layers_to_build }}'
      working-directory: backend/src/layers