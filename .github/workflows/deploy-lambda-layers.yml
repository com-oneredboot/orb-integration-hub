name: deploy-lambda-layers

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy'
        required: true
        type: environment
        default: dev
      action:
        description: 'CDK action to perform'
        required: true
        type: choice
        options:
          - deploy
          - diff
          - synth
        default: deploy

env:
  PYTHON_VERSION: '3.13'
  CUSTOMER_ID: orb
  PROJECT_ID: integration-hub

permissions:
  id-token: write
  contents: read

jobs:
  deploy:
    name: Deploy Lambda Layers
    runs-on: ubuntu-latest
    timeout-minutes: 30
    environment: ${{ github.event.inputs.environment }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ vars.AWS_DEPLOYMENT_ROLE_ARN }}
          aws-region: ${{ vars.AWS_REGION }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install CDK CLI
        run: npm install -g aws-cdk

      - name: Login to CodeArtifact for pipenv
        run: |
          export CODEARTIFACT_AUTH_TOKEN=$(aws codeartifact get-authorization-token \
            --domain orb-infrastructure-shared-codeartifact-domain \
            --domain-owner 432045270100 \
            --query authorizationToken \
            --output text)
          echo "CODEARTIFACT_AUTH_TOKEN=$CODEARTIFACT_AUTH_TOKEN" >> $GITHUB_ENV

      - name: Install Python dependencies
        working-directory: infrastructure
        run: |
          pip install pipenv
          pipenv install --dev

      - name: CDK Synth
        if: ${{ github.event.inputs.action == 'synth' || github.event.inputs.action == 'deploy' }}
        working-directory: infrastructure
        run: |
          echo "ðŸ”§ Synthesizing Lambda Layers stack for ${{ github.event.inputs.environment }}..."
          pipenv run cdk --app "python cdk/app_lambda_layers.py" synth \
            --context customer_id=${{ env.CUSTOMER_ID }} \
            --context project_id=${{ env.PROJECT_ID }} \
            --context environment=${{ github.event.inputs.environment }}

      - name: CDK Diff
        if: ${{ github.event.inputs.action == 'diff' || github.event.inputs.action == 'deploy' }}
        working-directory: infrastructure
        run: |
          echo "ðŸ“‹ Showing Lambda Layers changes..."
          pipenv run cdk --app "python cdk/app_lambda_layers.py" diff \
            --context customer_id=${{ env.CUSTOMER_ID }} \
            --context project_id=${{ env.PROJECT_ID }} \
            --context environment=${{ github.event.inputs.environment }} || true

      - name: CDK Deploy
        if: ${{ github.event.inputs.action == 'deploy' }}
        working-directory: infrastructure
        run: |
          echo "ðŸš€ Deploying Lambda Layers to ${{ github.event.inputs.environment }}..."
          pipenv run cdk --app "python cdk/app_lambda_layers.py" deploy --all \
            --require-approval never \
            --context customer_id=${{ env.CUSTOMER_ID }} \
            --context project_id=${{ env.PROJECT_ID }} \
            --context environment=${{ github.event.inputs.environment }}

      - name: Output Stack Information
        if: ${{ github.event.inputs.action == 'deploy' }}
        run: |
          echo "## Deployed Lambda Layers Stack" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          PREFIX="${{ env.CUSTOMER_ID }}-${{ env.PROJECT_ID }}-${{ github.event.inputs.environment }}"
          STACK_NAME="${PREFIX}-lambda-layers"
          STATUS=$(aws cloudformation describe-stacks --stack-name "$STACK_NAME" --query 'Stacks[0].StackStatus' --output text 2>/dev/null || echo "NOT_FOUND")
          echo "| Stack | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| $STACK_NAME | $STATUS |" >> $GITHUB_STEP_SUMMARY
