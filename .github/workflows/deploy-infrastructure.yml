name: deploy-infrastructure

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy'
        required: true
        type: environment
        default: dev
      action:
        description: 'CDK action to perform'
        required: true
        type: choice
        options:
          - deploy
          - diff
          - synth
        default: deploy
      skip_tests:
        description: 'Skip tests'
        required: false
        default: false
        type: boolean

env:
  PYTHON_VERSION: '3.13'
  CUSTOMER_ID: orb
  PROJECT_ID: integration-hub
  SMS_ORIGINATION_NUMBER: '+12898190331'

permissions:
  id-token: write
  contents: read

jobs:
  deploy:
    name: Deploy Infrastructure
    runs-on: ubuntu-latest
    timeout-minutes: 60
    environment: ${{ github.event.inputs.environment }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ vars.AWS_DEPLOYMENT_ROLE_ARN }}
          aws-region: ${{ vars.AWS_REGION }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install CDK CLI
        run: npm install -g aws-cdk

      - name: Login to CodeArtifact for pipenv
        run: |
          export CODEARTIFACT_AUTH_TOKEN=$(aws codeartifact get-authorization-token \
            --domain orb-infrastructure-shared-codeartifact-domain \
            --domain-owner 432045270100 \
            --query authorizationToken \
            --output text)
          echo "CODEARTIFACT_AUTH_TOKEN=$CODEARTIFACT_AUTH_TOKEN" >> $GITHUB_ENV

      - name: Install Python dependencies
        working-directory: infrastructure
        run: |
          pip install pipenv
          pipenv install --dev

      - name: Skip tests warning
        if: ${{ github.event.inputs.skip_tests == 'true' }}
        run: |
          echo "âš ï¸  CDK SYNTH VALIDATION SKIPPED - Emergency deployment mode"
          echo "   This should only be used in emergencies!"

      - name: Run CDK Tests
        if: ${{ github.event.inputs.skip_tests != 'true' }}
        working-directory: infrastructure
        run: |
          echo "ðŸ§ª Running CDK infrastructure tests..."
          pipenv run pytest cdk/tests/ -v

      - name: CDK Synth
        if: ${{ github.event.inputs.action == 'synth' || github.event.inputs.action == 'deploy' }}
        working-directory: infrastructure
        run: |
          echo "ðŸ”§ Synthesizing CDK stacks for ${{ github.event.inputs.environment }}..."
          pipenv run cdk synth --all \
            --context customer_id=${{ env.CUSTOMER_ID }} \
            --context project_id=${{ env.PROJECT_ID }} \
            --context environment=${{ github.event.inputs.environment }} \
            --context sms_origination_number=${{ env.SMS_ORIGINATION_NUMBER }} \
            --context alert_email=${{ vars.ALERT_EMAIL }}

      - name: CDK Diff
        if: ${{ github.event.inputs.action == 'diff' || github.event.inputs.action == 'deploy' }}
        working-directory: infrastructure
        run: |
          echo "ðŸ“‹ Showing infrastructure changes..."
          pipenv run cdk diff --all \
            --context customer_id=${{ env.CUSTOMER_ID }} \
            --context project_id=${{ env.PROJECT_ID }} \
            --context environment=${{ github.event.inputs.environment }} \
            --context sms_origination_number=${{ env.SMS_ORIGINATION_NUMBER }} \
            --context alert_email=${{ vars.ALERT_EMAIL }} || true

      - name: CDK Deploy
        if: ${{ github.event.inputs.action == 'deploy' }}
        working-directory: infrastructure
        run: |
          echo "ðŸš€ Deploying infrastructure to ${{ github.event.inputs.environment }}..."

          STACK_STATUS=$(aws cloudformation describe-stacks --stack-name CDKToolkit --query 'Stacks[0].StackStatus' --output text 2>/dev/null || echo "DOES_NOT_EXIST")

          if [[ "$STACK_STATUS" == *"ROLLBACK"* ]] || [[ "$STACK_STATUS" == *"FAILED"* ]]; then
            echo "âŒ CDKToolkit stack is in $STACK_STATUS state - manual intervention required"
            exit 1
          fi

          if [[ "$STACK_STATUS" == "DOES_NOT_EXIST" ]]; then
            echo "Bootstrapping CDK..."
            pipenv run cdk bootstrap \
              --context customer_id=${{ env.CUSTOMER_ID }} \
              --context project_id=${{ env.PROJECT_ID }} \
              --context environment=${{ github.event.inputs.environment }} \
              --context sms_origination_number=${{ env.SMS_ORIGINATION_NUMBER }} \
              --context alert_email=${{ vars.ALERT_EMAIL }}
          fi

          pipenv run cdk deploy --all \
            --require-approval never \
            --context customer_id=${{ env.CUSTOMER_ID }} \
            --context project_id=${{ env.PROJECT_ID }} \
            --context environment=${{ github.event.inputs.environment }} \
            --context sms_origination_number=${{ env.SMS_ORIGINATION_NUMBER }} \
            --context alert_email=${{ vars.ALERT_EMAIL }}

      - name: Output Stack Information
        if: ${{ github.event.inputs.action == 'deploy' }}
        run: |
          echo "## Deployed Stacks" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Stack | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          
          PREFIX="${{ env.CUSTOMER_ID }}-${{ env.PROJECT_ID }}-${{ github.event.inputs.environment }}"
          # Note: lambda-layers is deployed separately via deploy-lambda-layers workflow
          for stack in bootstrap cognito dynamodb frontend lambda appsync monitoring; do
            STACK_NAME="${PREFIX}-${stack}"
            STATUS=$(aws cloudformation describe-stacks --stack-name "$STACK_NAME" --query 'Stacks[0].StackStatus' --output text 2>/dev/null || echo "NOT_FOUND")
            echo "| $STACK_NAME | $STATUS |" >> $GITHUB_STEP_SUMMARY
          done
