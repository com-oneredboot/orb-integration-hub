name: deploy-infrastructure

permissions:
  id-token: write
  contents: read

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        type: environment
      customer_id:
        description: 'Customer ID'
        required: false
        type: string
        default: 'orb'
      project_id:
        description: 'Project ID'
        required: false
        type: string
        default: 'integration-hub'
      sms_origination_number:
        description: 'SMS Origination Number'
        required: false
        type: string
        default: '+12898190331'

env:
  AWS_REGION: us-east-1
  PYTHON_VERSION: '3.12'

jobs:
  deploy-infrastructure:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    environment: ${{ inputs.environment }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ vars.AWS_DEPLOYMENT_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Set up Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install AWS CDK CLI
        run: npm install -g aws-cdk

      - name: Login to CodeArtifact for pipenv
        run: |
          export CODEARTIFACT_AUTH_TOKEN=$(aws codeartifact get-authorization-token \
            --domain orb-infrastructure-shared-codeartifact-domain \
            --domain-owner 432045270100 \
            --query authorizationToken \
            --output text)
          echo "CODEARTIFACT_AUTH_TOKEN=$CODEARTIFACT_AUTH_TOKEN" >> $GITHUB_ENV

      - name: Install Python dependencies
        run: |
          pip install pipenv
          cd infrastructure
          pipenv install --dev

      - name: Get AWS Account ID
        id: aws-account
        run: |
          ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
          echo "account_id=$ACCOUNT_ID" >> $GITHUB_OUTPUT

      - name: CDK Bootstrap (if needed)
        run: |
          cd infrastructure
          pipenv run cdk bootstrap aws://${{ steps.aws-account.outputs.account_id }}/${{ env.AWS_REGION }} \
            --context customer_id=${{ inputs.customer_id }} \
            --context project_id=${{ inputs.project_id }} \
            --context environment=${{ inputs.environment }} \
            --context region=${{ env.AWS_REGION }} \
            --context account=${{ steps.aws-account.outputs.account_id }} \
            --context sms_origination_number=${{ inputs.sms_origination_number }} \
            --context alert_email=${{ vars.ALERT_EMAIL }} \
            || echo "Bootstrap may already exist, continuing..."

      - name: CDK Deploy
        run: |
          cd infrastructure
          pipenv run cdk deploy --all \
            --require-approval never \
            --context customer_id=${{ inputs.customer_id }} \
            --context project_id=${{ inputs.project_id }} \
            --context environment=${{ inputs.environment }} \
            --context region=${{ env.AWS_REGION }} \
            --context account=${{ steps.aws-account.outputs.account_id }} \
            --context sms_origination_number=${{ inputs.sms_origination_number }} \
            --context alert_email=${{ vars.ALERT_EMAIL }}

      - name: Output Stack Information
        run: |
          echo "## Deployed Stacks" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Stack | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          
          PREFIX="${{ inputs.customer_id }}-${{ inputs.project_id }}-${{ inputs.environment }}"
          for stack in bootstrap cognito dynamodb lambda-layers frontend lambda appsync monitoring; do
            STACK_NAME="${PREFIX}-${stack}"
            STATUS=$(aws cloudformation describe-stacks --stack-name "$STACK_NAME" --query 'Stacks[0].StackStatus' --output text 2>/dev/null || echo "NOT_FOUND")
            echo "| $STACK_NAME | $STATUS |" >> $GITHUB_STEP_SUMMARY
          done
