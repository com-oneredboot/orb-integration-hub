# Requirements Document

## Introduction

This spec covers refactoring the CDK infrastructure to maximize use of orb-schema-generator, eliminate code duplication, and align SSM parameter naming with orb-templates standards. The goal is DRY (Don't Repeat Yourself) infrastructure code where orb-schema-generator handles all schema-driven resources.

## Glossary

- **orb-schema-generator**: Code generation tool that produces CDK constructs, models, GraphQL schemas, and VTL resolvers from YAML definitions
- **SSM_Parameter**: AWS Systems Manager Parameter Store entry for cross-stack/service configuration sharing
- **Generated_Code**: CDK constructs auto-generated by orb-schema-generator (in `infrastructure/cdk/generated/`)
- **Manual_Stack**: Hand-written CDK stack code (in `infrastructure/cdk/stacks/`)
- **DRY**: Don't Repeat Yourself - principle of reducing code duplication
- **Path_Based_Naming**: SSM parameter naming using `/` separators (e.g., `/orb/integration-hub/dev/cognito/user-pool-id`)

## Current State Analysis

### What orb-schema-generator Currently Generates

1. **DynamoDB Table Constructs** (`infrastructure/cdk/generated/*_table.py`)
   - Table definitions with partition/sort keys
   - GSI definitions
   - Does NOT include: SSM parameters, PITR, removal policies, tags

2. **AppSync API Construct** (`infrastructure/cdk/generated/api.py`)
   - GraphQL API with Cognito auth
   - DynamoDB data sources and resolvers
   - SSM parameters using path-based naming (`/orb/integration-hub/dev/appsync/api-id`)
   - Reads Cognito User Pool ID from SSM parameter

3. **VTL Resolvers** (`apps/api/graphql/resolvers/`)
   - Request/response mapping templates for CRUD operations

### What Manual Stacks Currently Provide

1. **dynamodb_stack.py**: Duplicates table definitions, adds PITR, removal policies, SSM parameters (dash-based naming)
2. **appsync_stack.py**: Duplicates AppSync API, adds custom resolvers, Lambda data sources
3. **cognito_stack.py**: User Pool, Identity Pool, Groups (not schema-driven)
4. **lambda_stack.py**: Lambda functions with layer references
5. **lambda_layers_stack.py**: Lambda layers
6. **bootstrap_stack.py**: SQS queues, IAM policies, secrets
7. **frontend_stack.py**: S3, CloudFront
8. **monitoring_stack.py**: CloudWatch, alarms, GuardDuty

## Requirements

### Requirement 1: SSM Parameter Naming Convention

**User Story:** As a developer, I want consistent SSM parameter naming across all stacks, so that parameter discovery and cross-stack references are predictable.

#### Acceptance Criteria

1. THE Config SHALL use path-based SSM parameter naming following pattern `/{customer_id}/{project_id}/{environment}/{resource-path}`
2. WHEN a Manual_Stack creates an SSM parameter THEN the parameter name SHALL match the orb-schema-generator convention
3. THE Manual_Stack SSM parameters SHALL be organized by resource type (e.g., `/orb/integration-hub/dev/cognito/user-pool-id`)
4. WHEN migrating existing parameters THEN the CDK SHALL create new parameters with correct naming

### Requirement 2: DynamoDB Stack Refactoring

**User Story:** As a developer, I want the DynamoDB stack to use generated table constructs, so that table definitions are not duplicated.

#### Acceptance Criteria

1. THE dynamodb_stack SHALL import Generated_Code table constructs from `infrastructure/cdk/generated/`
2. THE dynamodb_stack SHALL wrap Generated_Code constructs to add PITR, removal policies, and tags
3. THE dynamodb_stack SHALL create SSM parameters for table ARNs and names using path-based naming
4. THE dynamodb_stack SHALL NOT duplicate table definitions that exist in Generated_Code
5. IF a table requires configuration not supported by Generated_Code THEN the dynamodb_stack SHALL extend the construct

### Requirement 3: Schema Type Evaluation

**User Story:** As a developer, I want to evaluate using `lambda-dynamodb` schema type instead of `dynamodb`, so that Lambda resolvers are generated automatically.

#### Acceptance Criteria

1. THE team SHALL evaluate changing table schemas from `type: dynamodb` to `type: lambda-dynamodb`
2. IF `lambda-dynamodb` generates Lambda data sources and resolvers THEN the schemas SHALL be updated
3. THE evaluation SHALL document what additional resources `lambda-dynamodb` generates vs `dynamodb`
4. IF schema type changes are beneficial THEN the schemas SHALL be updated and code regenerated

### Requirement 4: AppSync Stack Evaluation

**User Story:** As a developer, I want to evaluate using the generated AppSync construct, so that resolver definitions are not duplicated.

#### Acceptance Criteria

1. THE appsync_stack SHALL evaluate using Generated_Code AppSync construct from `infrastructure/cdk/generated/api.py`
2. IF the Generated_Code AppSync construct is sufficient THEN the appsync_stack SHALL use it directly
3. IF custom Lambda data sources are needed THEN the appsync_stack SHALL extend the Generated_Code construct
4. THE appsync_stack SHALL document any gaps between Generated_Code and requirements
5. IF gaps exist THEN an issue SHALL be opened with orb-schema-generator team

### Requirement 5: Lambda Stack SSM Alignment

**User Story:** As a developer, I want Lambda functions to reference layers via SSM parameters with correct naming, so that cross-stack references work reliably.

#### Acceptance Criteria

1. THE lambda_stack SHALL read layer ARNs from SSM parameters using path-based naming (`/orb/integration-hub/dev/lambda-layers/{layer-name}/arn`)
2. THE lambda_layers_stack SHALL write layer ARNs to SSM parameters using path-based naming
3. THE lambda_stack SHALL write Lambda ARNs to SSM parameters under `/orb/integration-hub/dev/lambda/{function-name}/arn`

### Requirement 6: Cognito Stack SSM Alignment

**User Story:** As a developer, I want Cognito resources to use path-based SSM parameter naming, so that the generated AppSync API can reference them.

#### Acceptance Criteria

1. THE cognito_stack SHALL use path-based SSM parameter naming
2. THE cognito_stack SSM parameters SHALL be organized under `/orb/integration-hub/{env}/cognito/`
3. THE cognito_stack SHALL export User Pool ID to `/orb/integration-hub/{env}/cognito/user-pool-id` (required by generated AppSync)

### Requirement 7: Bootstrap Stack SSM Alignment

**User Story:** As a developer, I want bootstrap resources to use consistent SSM parameter naming, so that all infrastructure follows the same convention.

#### Acceptance Criteria

1. THE bootstrap_stack SHALL use path-based SSM parameter naming
2. THE bootstrap_stack SSM parameters SHALL be organized by resource type (e.g., `/orb/integration-hub/{env}/sqs/alerts-queue/arn`)

### Requirement 8: Frontend and Monitoring Stack Alignment

**User Story:** As a developer, I want all remaining stacks to use consistent SSM parameter naming, so that the entire infrastructure is uniform.

#### Acceptance Criteria

1. THE frontend_stack SHALL use path-based SSM parameter naming under `/orb/integration-hub/{env}/frontend/`
2. THE monitoring_stack SHALL use path-based SSM parameter naming under `/orb/integration-hub/{env}/monitoring/`

### Requirement 9: Test Updates

**User Story:** As a developer, I want CDK tests to validate the new SSM parameter naming convention, so that regressions are caught.

#### Acceptance Criteria

1. WHEN SSM parameter naming changes THEN the CDK tests SHALL be updated to expect new parameter names
2. THE CDK tests SHALL verify path-based parameter naming format
3. THE CDK tests SHALL pass after all refactoring is complete

### Requirement 10: orb-schema-generator Enhancement Requests

**User Story:** As a developer, I want to identify gaps in orb-schema-generator capabilities, so that enhancement requests can be filed.

#### Acceptance Criteria

1. IF Generated_Code tables lack SSM parameter generation THEN an enhancement request SHALL be filed with orb-schema-generator team
2. IF Generated_Code tables lack PITR configuration THEN an enhancement request SHALL be filed
3. IF Generated_Code tables lack removal policy configuration THEN an enhancement request SHALL be filed
4. THE enhancement requests SHALL include specific examples from this project

### Requirement 11: orb-schema-generator Documentation Feedback

**User Story:** As a developer, I want to provide documentation feedback to the orb-schema-generator team, so that future users have clearer guidance.

#### Acceptance Criteria

1. THE feedback SHALL identify missing documentation for CDK infrastructure generation capabilities
2. THE feedback SHALL request a clear matrix showing what each schema type generates (tables, SSM params, Lambda functions, etc.)
3. THE feedback SHALL request documentation on how to extend generated constructs with PITR, removal policies, and tags
4. THE feedback SHALL request examples of integrating generated constructs with manual stacks

### Requirement 12: Migration Strategy

**User Story:** As a developer, I want a clean migration from old to new SSM parameter names, so that the infrastructure uses consistent naming.

#### Acceptance Criteria

1. THE migration SHALL replace all dash-based SSM parameters with path-based parameters
2. THE migration SHALL NOT create duplicate parameters (old and new)
3. THE migration SHALL be executed in a single deployment
4. THE migration SHALL update all code references to use new parameter names before deployment
5. AFTER deployment THEN only path-based parameters SHALL exist


### Requirement 13: Documentation Updates

**User Story:** As a developer, I want documentation updated to reflect the new SSM parameter naming convention, so that future developers understand the patterns.

#### Acceptance Criteria

1. THE infrastructure steering file SHALL document the path-based SSM parameter naming convention
2. THE CDK README SHALL be updated with examples of the new parameter naming
3. THE documentation SHALL include the parameter path structure for each resource type
4. THE documentation SHALL reference orb-schema-generator conventions

### Requirement 14: Version and Changelog Updates

**User Story:** As a developer, I want version and changelog properly updated, so that changes are tracked and communicated.

#### Acceptance Criteria

1. THE CHANGELOG.md SHALL include an entry for the CDK refactoring changes
2. THE changelog entry SHALL list all SSM parameter naming changes
3. THE changelog entry SHALL note the alignment with orb-schema-generator conventions
4. THE changelog entry SHALL reference any issues opened with orb-schema-generator team
5. IF version bump is required THEN the version SHALL be updated according to semver

### Requirement 15: Git Commit Standards

**User Story:** As a developer, I want commits to follow conventional commit format, so that changes are properly tracked.

#### Acceptance Criteria

1. THE commits SHALL follow conventional commit format (e.g., `refactor: align SSM parameter naming with orb-schema-generator`)
2. THE commits SHALL reference any related GitHub issues
3. THE commits SHALL be atomic and focused on specific changes
