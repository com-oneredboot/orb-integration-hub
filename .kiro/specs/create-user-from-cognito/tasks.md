# Implementation Plan: CreateUserFromCognito

## Overview

This implementation plan creates a secure Lambda-backed GraphQL mutation for user record creation during self-registration, following the security pattern established by CheckEmailExists.

## Tasks

- [x] 1. Create Lambda Schema Definition
  - Create `schemas/lambdas/CreateUserFromCognito.yml`
  - Define mutation operation with apiKeyAuthentication
  - Define input attribute (cognitoSub) and output attributes
  - _Requirements: 1.1, 1.2, 1.3, 1.4, 1.5_

- [x] 2. Implement CreateUserFromCognito Lambda
  - [x] 2.1 Create Lambda directory structure
    - Create `apps/api/lambdas/create_user_from_cognito/`
    - Create `__init__.py` and `index.py`
    - _Requirements: 2.1_

  - [x] 2.2 Implement input validation
    - Implement UUID format validation for cognitoSub
    - Implement timing attack prevention (MIN_RESPONSE_TIME)
    - _Requirements: 5.1, 5.2_

  - [x] 2.3 Implement Cognito user lookup
    - Implement `get_cognito_user()` using admin_get_user
    - Extract user attributes (email, given_name, family_name, email_verified, sub)
    - Handle UserNotFoundException
    - _Requirements: 2.1, 2.2, 2.6_

  - [x] 2.4 Implement DynamoDB operations
    - Implement `query_user_by_cognito_sub()` for idempotency check
    - Implement `create_user_record()` with Cognito-verified data
    - Set status=PENDING, groups=['USER']
    - _Requirements: 2.4, 2.5, 2.7_

  - [x] 2.5 Implement error handling
    - Map errors to ORB-AUTH-010, ORB-AUTH-011, ORB-AUTH-012, ORB-API-010
    - Ensure generic error messages (no PII)
    - _Requirements: 5.3, 5.4, 6.1, 6.2, 6.3, 6.4_

  - [x] 2.6 Implement lambda_handler
    - Wire together validation, Cognito lookup, DynamoDB operations
    - Ensure consistent response timing
    - _Requirements: 2.1, 2.2, 2.3, 2.4_

  - [x] 2.7 Write unit tests for Lambda
    - Test happy path, idempotency, user not found, invalid UUID
    - Test Cognito/DynamoDB service errors
    - Target >85% coverage
    - _Requirements: 8.1_

  - [x] 2.8 Write property test: Cognito Validation
    - **Property 1: Cognito Validation**
    - **Validates: Requirements 2.1, 2.6**

  - [x] 2.9 Write property test: Data Source Integrity
    - **Property 2: Data Source Integrity**
    - **Validates: Requirements 2.2, 2.3, 2.5**

  - [x] 2.10 Write property test: Idempotency
    - **Property 3: Idempotency**
    - **Validates: Requirements 2.7**

  - [x] 2.11 Write property test: Input Validation
    - **Property 4: Input Validation**
    - **Validates: Requirements 5.1, 5.4**

- [x] 3. Checkpoint - Lambda Implementation
  - ✅ All 19 unit tests pass
  - ✅ All 10 property tests pass
  - ✅ Tests use mocking for Cognito (moto's cognitoidp requires joserfc)
  - Ask the user if questions arise

- [x] 4. Update UsersCreate Schema Security
  - [x] 4.1 Modify Users table schema
    - ✅ Updated `schemas/tables/Users.yml` to remove apiKeyAuthentication from UsersCreate
    - ✅ Restricted UsersCreate to cognitoAuthentication with groups EMPLOYEE, OWNER
    - _Requirements: 3.1, 3.2_

  - [x] 4.2 Regenerate GraphQL schema
    - ✅ Ran `pipenv run orb-schema generate`
    - ✅ Verified UsersCreate has @aws_auth only (no @aws_api_key)
    - ✅ Verified CreateUserFromCognito has @aws_api_key
    - _Requirements: 3.1, 3.2_

  - [x] 4.3 Write schema validation test
    - ✅ Created `apps/api/tests/property/test_schema_auth_directives.sh`
    - ✅ Verifies CreateUserFromCognito has @aws_api_key only
    - ✅ Verifies UsersCreate has @aws_auth only (no @aws_api_key)
    - ✅ All 7 tests pass
    - _Requirements: 8.4_

- [x] 5. Update Frontend Integration
  - [x] 5.1 Create GraphQL operation file
    - ✅ Auto-generated by orb-schema-generator at `apps/web/src/app/core/graphql/CreateUserFromCognito.graphql.ts`
    - _Requirements: 4.1_

  - [x] 5.2 Add createUserFromCognito service method
    - ✅ Added method to `apps/web/src/app/core/services/user.service.ts`
    - ✅ Uses apiKey auth mode
    - _Requirements: 4.2_

  - [x] 5.3 Update handleMFASuccess effect
    - ✅ Modified `apps/web/src/app/features/user/store/user.effects.ts`
    - ✅ Replaced createUserRecordOnly with createUserFromCognito
    - _Requirements: 4.1, 4.3_

  - [x] 5.4 Update user actions and reducer
    - ✅ Added createUserFromCognito action to `apps/web/src/app/features/user/store/user.actions.ts`
    - ✅ Added createUserFromCognito$ effect and handleCreateUserFromCognitoSuccess$ effect
    - ✅ Updated reducer for success/failure states in `apps/web/src/app/features/user/store/user.reducer.ts`
    - _Requirements: 4.1_

  - [x] 5.5 Write frontend unit tests
    - ✅ Added tests to `apps/web/src/app/core/services/user.service.spec.ts`
    - ✅ Added tests to `apps/web/src/app/features/user/store/user.effects.spec.ts`
    - ✅ Tests verify createUserFromCognito uses apiKey auth mode
    - ✅ Tests verify effect dispatches correct actions
    - ✅ Test files have no TypeScript errors
    - Note: Pre-existing TypeScript errors in main codebase prevent test execution
    - _Requirements: 8.3_

- [x] 6. Checkpoint - Frontend Integration
  - ✅ All frontend linting passes (`npm run lint`)
  - ✅ CreateUserFromCognito-related files have no TypeScript errors
  - ✅ Test files (user.service.spec.ts, user.effects.spec.ts) have no errors
  - ✅ GraphQL operation file (CreateUserFromCognito.graphql.ts) has no errors
  - Note: Pre-existing TypeScript errors in codebase (not related to this feature)
  - Ask the user if questions arise

- [x] 7. Update CDK Infrastructure
  - [x] 7.1 Add Lambda to Lambda stack
    - ✅ Added CreateUserFromCognito Lambda definition to `infrastructure/cdk/stacks/lambda_stack.py`
    - ✅ Configured environment variables (USERS_TABLE_NAME, USER_POOL_ID)
    - ✅ Granted Cognito and DynamoDB permissions via shared lambda_execution_role
    - _Requirements: 2.1_

  - [x] 7.2 Add Lambda resolver to AppSync stack
    - ✅ Auto-generated by orb-schema-generator in `infrastructure/cdk/generated/appsync/api.py`
    - ✅ Resolver configured for CreateUserFromCognito mutation
    - _Requirements: 2.8_

- [x] 8. Update Documentation
  - [x] 8.1 Update API documentation
    - ✅ Added CreateUserFromCognito to `docs/api.md`
    - ✅ Documented input/output, authentication, error codes
    - ✅ Updated Users section to reflect new auth requirements
    - _Requirements: 7.1_

  - [x] 8.2 Create/update auth architecture documentation
    - ✅ Documented in API docs the separation of API key vs Cognito auth operations
    - ✅ Documented use case and security notes
    - _Requirements: 7.2, 7.3_

- [x] 9. Update Error Registry
  - ✅ Added ORB-AUTH-010 (Authentication service unavailable)
  - ✅ Added ORB-AUTH-011 (Invalid request format)
  - ✅ Added ORB-AUTH-012 (User not found)
  - ✅ Added ORB-API-010 (Database service unavailable)
  - ✅ Regenerated schemas
  - _Requirements: 6.1, 6.2, 6.3, 6.4_

- [x] 10. Final Checkpoint
  - ✅ All 29 Lambda tests pass (19 unit + 10 property)
  - ✅ All 21 CDK tests pass
  - ✅ Schema generation succeeds
  - ✅ Documentation updated
  - ✅ Error registry updated
  - ✅ Schema validation test passes (7 tests)
  - ✅ Frontend unit tests created (10 new tests)
  - ✅ Frontend linting passes
  - ✅ All CreateUserFromCognito-related files have no TypeScript errors
  - Note: Pre-existing TypeScript errors in codebase (not related to this feature)

## Notes

- All tasks are required for comprehensive testing
- Each task references specific requirements for traceability
- Checkpoints ensure incremental validation
- Property tests validate universal correctness properties
- Unit tests validate specific examples and edge cases
- Follow CheckEmailExists Lambda as reference implementation
