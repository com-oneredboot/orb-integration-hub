# Design Document: Enum Schema Migration

## Overview

This design document outlines the migration of manually created TypeScript enums to use orb-schema-generator generated enums. The migration involves updating all code references from SCREAMING_CASE values (e.g., `AuthSteps.EMAIL`) to PascalCase values (e.g., `AuthStep.Email`), removing backward-compatible alias objects, and updating coding standards documentation.

The migration affects four enums:
- `AuthStep` - Authentication flow steps
- `CognitoUserStatus` - Cognito user status values
- `RecoveryAction` - Recovery flow actions
- `ProfileSetupStep` - Profile setup flow steps

## Architecture

### Current State

```
┌─────────────────────────────────────────────────────────────────┐
│                     Current Architecture                         │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  schemas/registries/*.yml                                        │
│         │                                                        │
│         ▼                                                        │
│  orb-schema-generator                                            │
│         │                                                        │
│         ▼                                                        │
│  core/enums/*Enum.ts (Generated - PascalCase)                   │
│         │                                                        │
│         ▼                                                        │
│  Backward-Compatible Aliases (SCREAMING_CASE → PascalCase)      │
│  ├── user.state.ts: AuthSteps                                   │
│  ├── RecoveryModel.ts: CognitoUserStatus, RecoveryAction        │
│  └── profile.component.ts: ProfileSetupStep                     │
│         │                                                        │
│         ▼                                                        │
│  Application Code (Mixed: some use aliases, some use generated) │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### Target State

```
┌─────────────────────────────────────────────────────────────────┐
│                     Target Architecture                          │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  schemas/registries/*.yml                                        │
│         │                                                        │
│         ▼                                                        │
│  orb-schema-generator                                            │
│         │                                                        │
│         ▼                                                        │
│  core/enums/*Enum.ts (Generated - PascalCase)                   │
│         │                                                        │
│         ▼                                                        │
│  Application Code (All use generated enums directly)            │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

## Components and Interfaces

### Generated Enum Files

All generated enums follow the same pattern from orb-schema-generator:

```typescript
// AUTO-GENERATED by orb-schema-generator - DO NOT EDIT
export enum EnumName {
  /** Description */
  PascalCaseValue = "SCREAMING_CASE_VALUE",
}

export function enumnameToJson(value: EnumName): string;
export function enumnameFromJson(json: string): EnumName;
```

### Enum Value Mapping

| Enum | Old Reference | New Reference |
|------|---------------|---------------|
| AuthStep | `AuthSteps.EMAIL` | `AuthStep.Email` |
| AuthStep | `AuthSteps.EMAIL_ENTRY` | `AuthStep.EmailEntry` |
| AuthStep | `AuthSteps.PASSWORD` | `AuthStep.Password` |
| AuthStep | `AuthSteps.PASSWORD_SETUP` | `AuthStep.PasswordSetup` |
| AuthStep | `AuthSteps.PASSWORD_VERIFY` | `AuthStep.PasswordVerify` |
| AuthStep | `AuthSteps.EMAIL_VERIFY` | `AuthStep.EmailVerify` |
| AuthStep | `AuthSteps.SIGNIN` | `AuthStep.Signin` |
| AuthStep | `AuthSteps.MFA_SETUP` | `AuthStep.MfaSetup` |
| AuthStep | `AuthSteps.MFA_VERIFY` | `AuthStep.MfaVerify` |
| AuthStep | `AuthSteps.PASSWORD_RESET` | `AuthStep.PasswordReset` |
| AuthStep | `AuthSteps.PASSWORD_RESET_VERIFY` | `AuthStep.PasswordResetVerify` |
| AuthStep | `AuthSteps.PASSWORD_RESET_CONFIRM` | `AuthStep.PasswordResetConfirm` |
| AuthStep | `AuthSteps.COMPLETE` | `AuthStep.Complete` |
| CognitoUserStatus | `CognitoUserStatus.UNKNOWN` | `CognitoUserStatus.Unknown` |
| CognitoUserStatus | `CognitoUserStatus.UNCONFIRMED` | `CognitoUserStatus.Unconfirmed` |
| CognitoUserStatus | `CognitoUserStatus.CONFIRMED` | `CognitoUserStatus.Confirmed` |
| CognitoUserStatus | `CognitoUserStatus.FORCE_CHANGE_PASSWORD` | `CognitoUserStatus.ForceChangePassword` |
| CognitoUserStatus | `CognitoUserStatus.RESET_REQUIRED` | `CognitoUserStatus.ResetRequired` |
| RecoveryAction | `RecoveryAction.UNKNOWN` | `RecoveryAction.Unknown` |
| RecoveryAction | `RecoveryAction.NEW_SIGNUP` | `RecoveryAction.NewSignup` |
| RecoveryAction | `RecoveryAction.RESEND_VERIFICATION` | `RecoveryAction.ResendVerification` |
| RecoveryAction | `RecoveryAction.CREATE_DYNAMO_RECORD` | `RecoveryAction.CreateDynamoRecord` |
| RecoveryAction | `RecoveryAction.LOGIN` | `RecoveryAction.Login` |
| RecoveryAction | `RecoveryAction.PASSWORD_RESET` | `RecoveryAction.PasswordReset` |
| RecoveryAction | `RecoveryAction.CONTACT_SUPPORT` | `RecoveryAction.ContactSupport` |
| ProfileSetupStep | `ProfileSetupStep.UNKNOWN` | `ProfileSetupStep.Unknown` |
| ProfileSetupStep | `ProfileSetupStep.NAME` | `ProfileSetupStep.Name` |
| ProfileSetupStep | `ProfileSetupStep.PHONE` | `ProfileSetupStep.Phone` |
| ProfileSetupStep | `ProfileSetupStep.PHONE_VERIFY` | `ProfileSetupStep.PhoneVerify` |
| ProfileSetupStep | `ProfileSetupStep.COMPLETE` | `ProfileSetupStep.Complete` |

### Files Requiring Updates

#### Source Files

| File | Changes Required |
|------|------------------|
| `user.state.ts` | Remove `AuthSteps` alias, update imports |
| `user.reducer.ts` | Update `AuthSteps.` → `AuthStep.` |
| `user.selectors.ts` | Update `AuthSteps.` → `AuthStep.` |
| `user.effects.ts` | Update `AuthSteps.` → `AuthStep.` |
| `user.actions.ts` | Update type references if any |
| `RecoveryModel.ts` | Remove alias objects, update function implementations |
| `recovery.service.ts` | Update `AuthSteps.` → `AuthStep.` |
| `auth-flow.component.ts` | Update enum references |
| `profile.component.ts` | Remove `ProfileSetupStep` alias, update references |
| `auth-progress-storage.service.ts` | Update enum references |

#### Test Files

| File | Changes Required |
|------|------------------|
| `user.effects.spec.ts` | Update `AuthSteps.` → `AuthStep.` |
| `user.effects.property.spec.ts` | Update `AuthSteps.` → `AuthStep.` |
| `auth-flow.component.spec.ts` | Update `AuthSteps.` → `AuthStep.` |
| `recovery.service.spec.ts` | Update `AuthSteps.` → `AuthStep.` |
| `auth-progress-storage.service.spec.ts` | Update `AuthSteps.` → `AuthStep.` |
| `profile.component.spec.ts` | Update `ProfileSetupStep.` references |
| `profile.component.property.spec.ts` | Update `ProfileSetupStep.` references |

## Data Models

### Import Pattern Changes

**Before:**
```typescript
import { AuthSteps } from '../../store/user.state';
// or
import { CognitoUserStatus, RecoveryAction } from '../../../core/models/RecoveryModel';
```

**After:**
```typescript
import { AuthStep } from '../../../core/enums/AuthStepEnum';
import { CognitoUserStatus } from '../../../core/enums/CognitoUserStatusEnum';
import { RecoveryAction } from '../../../core/enums/RecoveryActionEnum';
```

### RecoveryModel.ts Refactoring

The `RecoveryModel.ts` file will be simplified to only contain:
- Interface definitions (`SmartCheckResult`)
- Message constants (`AUTH_MESSAGES`)
- Helper functions (`getNextStepForAction`, `getMessageForAction`)

All enum imports will come from `core/enums/`.

## Correctness Properties

*A property is a characteristic or behavior that should hold true across all valid executions of a system-essentially, a formal statement about what the system should do. Properties serve as the bridge between human-readable specifications and machine-verifiable correctness guarantees.*

This migration is primarily a code transformation task verified through static analysis and integration testing. The acceptance criteria are testable as specific examples rather than universal properties, since we're verifying the absence of deprecated patterns and presence of correct patterns in a finite codebase.

### Verification Approach

Since this is a migration task, verification is done through:

1. **Static Code Analysis**: Grep searches to verify no deprecated patterns remain
2. **Integration Testing**: Running existing test suites to ensure functionality is preserved
3. **Compilation**: TypeScript compiler to catch type errors

### Verification Checks

| Check | Command | Expected Result |
|-------|---------|-----------------|
| No AuthSteps references | `grep -r "AuthSteps\." apps/web/src` | Zero matches |
| No SCREAMING_CASE AuthStep | `grep -r "AuthStep\.[A-Z_]*[A-Z]" apps/web/src` | Zero matches |
| Tests pass | `npm test` in apps/web | All tests pass |
| Lint passes | `npm run lint` in apps/web | Zero errors |
| TypeScript compiles | `npm run build` in apps/web | Zero errors |

## Error Handling

| Scenario | Handling |
|----------|----------|
| Test failures after migration | Review test expectations, update to use PascalCase values |
| TypeScript compilation errors | Fix import paths and enum value references |
| Runtime errors | Verify enum string values match (PascalCase member = SCREAMING_CASE value) |

## Testing Strategy

### Unit Tests

Existing unit tests will be updated to use PascalCase enum values. No new unit tests are required since this is a refactoring that preserves behavior.

### Integration Tests

Run the full test suite after migration to verify:
- All existing tests pass
- No TypeScript compilation errors
- No lint errors

### Verification Script

A verification script can be run post-migration:

```bash
# Verify no deprecated patterns remain
echo "Checking for AuthSteps references..."
grep -r "AuthSteps\." apps/web/src --include="*.ts" | wc -l

echo "Checking for deprecated alias objects..."
grep -r "@deprecated.*alias" apps/web/src --include="*.ts" | wc -l

echo "Running tests..."
cd apps/web && npm test

echo "Running linter..."
cd apps/web && npm run lint
```

## Documentation Updates

### Enum Standards Section for frontend-components.md

The following section will be added to `.kiro/steering/frontend-components.md`:

```markdown
## Enum Standards

**CRITICAL**: All enums MUST be defined in schema registries and generated via orb-schema-generator. This follows the project principle: "Nothing is ever frontend only. EVER."

### Rules

1. **Never create TypeScript enums manually** - All enums must be defined in `schemas/registries/` as YAML files
2. **Use generated enums** - Import from `core/enums/*Enum.ts`
3. **Use PascalCase values** - Generated enums use PascalCase member names (e.g., `AuthStep.EmailEntry`)

### Correct Pattern

```typescript
// ✅ CORRECT - Import from generated enum file
import { AuthStep } from '../../../core/enums/AuthStepEnum';
import { UserStatus } from '../../../core/enums/UserStatusEnum';

// Use PascalCase enum values
if (currentStep === AuthStep.EmailEntry) { ... }
if (user.status === UserStatus.Active) { ... }
```

### Incorrect Patterns

```typescript
// ❌ WRONG - Manual enum definition
enum MyCustomEnum {
  VALUE_ONE = 'VALUE_ONE',
  VALUE_TWO = 'VALUE_TWO',
}

// ❌ WRONG - SCREAMING_CASE values (old pattern)
if (currentStep === AuthSteps.EMAIL_ENTRY) { ... }

// ❌ WRONG - Importing from non-enum files
import { AuthSteps } from '../../store/user.state';
```

### Creating New Enums

1. Create a YAML file in `schemas/registries/YourEnum.yml`
2. Run `pipenv run orb-schema generate`
3. Import from `core/enums/YourEnumEnum.ts`

### UI-Only Enums Exception

Component-local enums for UI-only state (e.g., tab selection) are acceptable when:
- The enum is only used within a single component
- The values are not persisted or sent to the backend
- The enum represents purely presentational state

Example: `EnvironmentDetailTab` in `environment-detail-page.component.ts`
```
