# Requirements Document

## Introduction

This document defines the requirements for completing the orb-integration-hub GraphQL API layer and associated components. The project has infrastructure deployed (Cognito, DynamoDB, Lambda functions) but the GraphQL schema is empty - no queries or mutations are generated, blocking all frontend data operations.

## Standard Requirements

This spec follows the [orb-templates Spec Standards](../../../repositories/orb-templates/docs/kiro-steering/templates/spec-standards.md).

## Glossary

- **GraphQL_Schema**: The `apps/api/graphql/schema.graphql` file generated by orb-schema-generator
- **Table_Schema**: YAML schema files in `schemas/tables/` that define DynamoDB table structures and GraphQL operations
- **Lambda_Schema**: YAML schema files in `schemas/lambdas/` that define Lambda resolver configurations
- **AppSync_Resolver**: VTL templates that connect GraphQL operations to DynamoDB or Lambda data sources
- **Entity_Service**: Angular service that provides CRUD operations for a specific entity via GraphQL
- **Schema_Generator**: The orb-schema-generator tool (v0.13.2) used for code generation

## Requirements

### Requirement 1: GraphQL Operations Generation

**User Story:** As a frontend developer, I want GraphQL queries and mutations generated for all entities, so that I can perform CRUD operations from the Angular application.

#### Acceptance Criteria

1. WHEN orb-schema-generator runs THEN the GraphQL_Schema SHALL contain Query operations for all table entities
2. WHEN orb-schema-generator runs THEN the GraphQL_Schema SHALL contain Mutation operations (Create, Update, Delete) for all table entities
3. THE Table_Schema files SHALL include a `graphql` section defining operations, inputs, and response types
4. THE GraphQL_Schema SHALL include proper input types for all mutations
5. THE GraphQL_Schema SHALL include response types following the standard contract (StatusCode: Int!, Message: String, Data: Entity)
6. WHEN a table has GSI indexes THEN the GraphQL_Schema SHALL include query operations that utilize those indexes

### Requirement 2: Organizations Table Schema

**User Story:** As a developer, I want the Organizations table to have a proper schema definition, so that GraphQL operations are generated consistently with other entities.

#### Acceptance Criteria

1. THE Schema_Generator SHALL have a `schemas/tables/Organizations.yml` file
2. THE Organizations Table_Schema SHALL define all fields matching the deployed DynamoDB table (organizationId, name, ownerId, status, createdAt, updatedAt)
3. THE Organizations Table_Schema SHALL define GSI indexes (OwnerIndex, StatusCreatedIndex)
4. THE Organizations Table_Schema SHALL include GraphQL operations (Query, Create, Update, Delete)
5. THE Organizations Table_Schema SHALL reference the OrganizationStatus enum from registries

### Requirement 3: AppSync Resolver Configuration

**User Story:** As a backend developer, I want AppSync resolvers properly configured, so that GraphQL operations connect to the correct data sources.

#### Acceptance Criteria

1. WHEN a Table_Schema defines DynamoDB operations THEN the AppSync_Resolver SHALL use DynamoDB data source
2. WHEN a Lambda_Schema defines operations THEN the AppSync_Resolver SHALL use Lambda data source
3. THE AppSync_Resolver templates SHALL follow the response type contract (StatusCode, Message, Data)
4. THE AppSync_Resolver templates SHALL handle errors gracefully with appropriate status codes
5. THE infrastructure/cloudformation/appsync.yml SHALL reference all generated resolvers

### Requirement 4: Authentication and Authorization

**User Story:** As a security-conscious developer, I want all GraphQL operations to have proper authentication and authorization, so that data is protected.

#### Acceptance Criteria

1. THE GraphQL_Schema SHALL use @aws_cognito_user_pools directive for authenticated operations
2. THE GraphQL_Schema SHALL specify cognito_groups for operations requiring specific roles
3. WHEN an operation requires OWNER or EMPLOYEE access THEN the directive SHALL specify those groups
4. THE GraphQL_Schema SHALL use @aws_api_key directive only for public read operations (if any)
5. THE Lambda resolvers SHALL validate user permissions before performing operations

### Requirement 5: Frontend Entity Services

**User Story:** As a frontend developer, I want Angular services that wrap GraphQL operations, so that I can easily perform CRUD operations with proper typing.

#### Acceptance Criteria

1. THE Entity_Service for Users SHALL provide query, create, update, and delete methods
2. THE Entity_Service for Organizations SHALL provide query, create, update, and delete methods
3. THE Entity_Service for Applications SHALL provide query, create, update, and delete methods
4. THE Entity_Service SHALL use the generated TypeScript models for type safety
5. THE Entity_Service SHALL handle errors consistently using the ErrorHandlerService
6. THE Entity_Service SHALL integrate with NgRx store for state management

### Requirement 6: GraphQL Query Definitions

**User Story:** As a frontend developer, I want TypeScript GraphQL query/mutation definitions, so that I can make type-safe API calls.

#### Acceptance Criteria

1. THE `apps/web/src/app/core/graphql/` directory SHALL contain query definitions for all entities
2. THE GraphQL query definitions SHALL match the generated schema operations
3. THE GraphQL query definitions SHALL use proper TypeScript typing
4. WHEN the schema changes THEN the query definitions SHALL be updated to match
5. THE GraphQL query definitions SHALL include variables for filtering and pagination

### Requirement 7: Missing Table Schemas Completion

**User Story:** As a developer, I want all DynamoDB tables to have corresponding schema definitions, so that the codebase is complete and consistent.

#### Acceptance Criteria

1. THE Schema_Generator SHALL have schemas for all deployed DynamoDB tables
2. IF a table exists in dynamodb.yml but not in schemas/tables/ THEN a schema SHALL be created
3. THE table schemas SHALL match the deployed table structure (keys, attributes, GSIs)
4. THE table schemas SHALL include appropriate GraphQL operations
5. THE table schemas SHALL use the correct targets configuration for orb-schema-generator 0.13.2

### Requirement 8: Version and Changelog Management

**User Story:** As a project maintainer, I want proper version tracking and changelog updates, so that changes are documented and traceable.

#### Acceptance Criteria

1. WHEN this spec is completed THEN the CHANGELOG.md SHALL be updated with all changes
2. THE CHANGELOG.md SHALL follow the standard format (Added, Changed, Fixed, Removed sections)
3. THE CHANGELOG.md SHALL reference any related GitHub issues
4. WHEN breaking changes are made THEN the version SHALL be bumped appropriately
5. THE package.json and any version files SHALL be updated consistently

### Requirement 9: Testing Coverage

**User Story:** As a quality-focused developer, I want tests for the new GraphQL operations and services, so that the implementation is verified.

#### Acceptance Criteria

1. THE Entity_Service implementations SHALL have unit tests
2. THE GraphQL resolvers SHALL have integration tests
3. THE tests SHALL cover success and error scenarios
4. THE tests SHALL verify authentication and authorization behavior
5. WHEN tests are added THEN they SHALL follow the project's testing standards

### Requirement 10: Documentation Updates

**User Story:** As a developer, I want documentation updated to reflect the completed API, so that the project is well-documented.

#### Acceptance Criteria

1. THE docs/api.md SHALL be updated with all new GraphQL operations
2. THE docs/schema.md SHALL be updated with new schema definitions
3. THE README.md SHALL reflect the completed state of the project
4. THE documentation SHALL include examples of using the new API operations
5. THE documentation SHALL be concise and avoid duplication with existing docs
